import{_ as K}from"./AppLayout.vue_vue_type_script_setup_true_lang-DkXoEYZQ.js";import{d as Q,x as H,y as p,r as D,c as j,w as B,a as e,t as d,j as X,u as N,l as E,f as c,b as o,e as a,n as P,o as i,F as Y,g as Z,h as x}from"./app-Ctez1HXG.js";import{r as y}from"./routes-C8N3XD_S.js";import{u as ee}from"./useSweetAlert-CjcY7Pj8.js";import"./BootstrapLayout-ri-ER_V1.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const se={class:"d-flex justify-content-between align-items-center mb-4"},te={class:"h2 mb-1"},ie={class:"d-flex gap-2"},le={class:"row g-4"},oe={class:"col-lg-8"},ne={class:"card mb-4"},de={class:"card-body"},re={class:"row g-3"},ae={class:"col-md-6"},ce={class:"mb-0 font-monospace"},ue={class:"col-md-6"},me={class:"mb-0"},ve={class:"col-md-6"},be={class:"mb-0"},ye={class:"col-md-6"},fe={class:"mb-0"},he={class:"col-md-6"},ge={class:"mb-0"},_e={key:0},pe={key:1,class:"text-muted"},Ne={key:0,class:"col-md-6"},xe={class:"mb-0"},we={class:"col-md-6"},ke={class:"mb-0"},Fe={key:0,class:"mt-4 pt-3 border-top"},Ce={class:"bg-light p-3 rounded"},De={class:"mb-0"},Be={class:"card"},Le={class:"card-body"},Se={key:0,class:"text-center py-4 text-muted"},je={key:1,class:"table-responsive"},Ee={class:"table table-hover mb-0"},Pe={class:"align-middle"},Re={class:"d-flex align-items-center"},Ue={class:"flex-shrink-0 me-3"},ze={key:0,class:"bg-light rounded overflow-hidden d-flex align-items-center justify-content-center",style:{width:"60px",height:"60px"}},Te=["src","alt"],Ie={key:1,class:"bg-light rounded d-flex align-items-center justify-content-center",style:{width:"60px",height:"60px"}},$e={class:"fw-medium"},Ae={key:0,class:"text-muted small"},Me={class:"align-middle"},Oe={class:"badge bg-secondary"},Ve={class:"align-middle"},Ge={class:"align-middle fw-medium text-success"},We={class:"col-lg-4"},qe={class:"card mb-4"},Je={class:"card-body"},Ke={class:"mb-3"},Qe={class:"d-flex justify-content-between mb-2"},He={class:"fw-medium"},Xe={key:0,class:"d-flex justify-content-between mb-2"},Ye={class:"fw-medium"},Ze={key:1,class:"d-flex justify-content-between mb-2"},es={class:"fw-medium text-danger"},ss={class:"d-flex justify-content-between"},ts={class:"fw-bold text-success fs-5"},is={key:0,class:"alert alert-warning"},ls={key:1,class:"alert alert-success"},os={class:"card"},ns={class:"card-body"},ds={class:"d-grid gap-2"},rs=["disabled"],as={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},cs={key:1,class:"bi bi-download me-1"},us=["disabled"],ms={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},vs={key:1,class:"bi bi-printer me-1"},bs=["disabled"],ys=["disabled"],fs={class:"card mt-4"},hs={class:"card-header d-flex justify-content-between align-items-center"},gs={key:0,class:"d-flex align-items-center gap-2"},_s=["href"],ps={class:"card-body"},Ns={class:"mb-3"},xs={key:0,class:"mt-2"},ws={class:"text-success"},ks={class:"mb-3"},Fs={class:"d-grid"},Cs=["disabled"],Ds={key:0,class:"mt-3"},Bs={class:"border rounded p-2 bg-light"},Ls=["src"],Ss=["src"],js={key:2,class:"text-muted small"},Es={class:"mt-2 small text-muted"},Ps={key:0},Rs={key:1},Os=Q({__name:"Show",props:{deliveryNote:{}},setup(t){const r=t,R=H(),U=p(()=>R.props.auth?.user?.role==="admin"),{success:_,error:h,confirm:w}=ee(),u=D(!1),m=D(!1),g=n=>new Intl.NumberFormat("fr-FR").format(n)+" Fcfa",z=n=>new Date(n).toLocaleDateString("fr-FR"),T=n=>({pending:"bg-warning",validated:"bg-success",cancelled:"bg-danger"})[n]||"bg-secondary",f=D(null),k=p(()=>y("delivery-notes.invoice.show",{deliveryNote:r.deliveryNote.id})),F=p(()=>!!r.deliveryNote.invoice_file_path),I=p(()=>(r.deliveryNote.invoice_file_mime||"").startsWith("image")),$=p(()=>(r.deliveryNote.invoice_file_mime||"").includes("pdf")),A=n=>{const s=n.target,l=s.files&&s.files[0]?s.files[0]:null;if(l&&l.size>2097152){h("Le fichier est trop volumineux. La taille maximale autorisée est de 2 Mo."),s.value="",f.value=null;return}f.value=l},M=async()=>{if(!f.value)return;const n=new FormData;n.append("file",f.value),x.post(y("delivery-notes.invoice.upload",{deliveryNote:r.deliveryNote.id}),n,{forceFormData:!0,onSuccess:()=>{f.value=null,_("Fichier uploadé avec succès")},onError:s=>{const l=s.message||"Erreur lors de l'upload du fichier.";h(l)}})},O=async()=>{await w("Supprimer le fichier de facture/BL ?")&&x.delete(y("delivery-notes.invoice.delete",{deliveryNote:r.deliveryNote.id}),{onSuccess:()=>{_("Fichier supprimé avec succès")},onError:s=>{const l=s.message||"Erreur lors de la suppression du fichier.";h(l)}})},V=n=>{if(!n&&n!==0)return"";const s=["octets","Ko","Mo","Go"];let l=n,v=0;for(;l>=1024&&v<s.length-1;)l/=1024,v++;return`${new Intl.NumberFormat("fr-FR",{maximumFractionDigits:1}).format(l)} ${s[v]}`},G=async()=>{await w(`Êtes-vous sûr de vouloir valider le bon de livraison "${r.deliveryNote.delivery_number}" ? Le stock sera ajusté.`)&&x.post(y("delivery-notes.validate",{id:r.deliveryNote.id}),{},{onSuccess:()=>{_(`Bon de livraison "${r.deliveryNote.delivery_number}" validé et stock ajusté avec succès !`)},onError:s=>{const l=s.message||"Erreur lors de la validation du bon de livraison.";h(l)}})},W=async()=>{u.value=!0;try{const n=y("delivery-notes.download",{deliveryNote:r.deliveryNote.id}),s=await fetch(n);if(!s.ok)throw new Error("Erreur lors du téléchargement");const l=await s.blob(),v=window.URL.createObjectURL(l),b=document.createElement("a");b.href=v;const L=s.headers.get("Content-Disposition");let S=`Bon_de_livraison_${r.deliveryNote.delivery_number}.pdf`;if(L){const C=L.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);C&&C[1]&&(S=C[1].replace(/['"]/g,""))}b.download=S,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(v),_("Bon de livraison téléchargé avec succès !")}catch{h("Erreur lors du téléchargement du bon de livraison.")}finally{u.value=!1}},q=async()=>{m.value=!0;try{const n=y("delivery-notes.print",{deliveryNote:r.deliveryNote.id}),s=await fetch(n);if(!s.ok)throw new Error("Erreur lors de l'ouverture du PDF");const l=await s.blob(),v=window.URL.createObjectURL(l),b=window.open(v,"_blank");b&&(b.onload=()=>{b.print()})}catch{h("Erreur lors de l'ouverture du bon de livraison pour impression.")}finally{m.value=!1}},J=async()=>{await w(`Êtes-vous sûr de vouloir supprimer le bon de livraison "${r.deliveryNote.delivery_number}" ?`)&&x.delete(y("delivery-notes.destroy",{id:r.deliveryNote.id}),{onSuccess:()=>{_(`Bon de livraison "${r.deliveryNote.delivery_number}" supprimé avec succès !`)},onError:s=>{const l=s.message||"Erreur lors de la suppression du bon de livraison.";h(l)}})};return(n,s)=>(i(),j(K,null,{default:B(()=>[e("div",se,[e("div",null,[e("h1",te,"Bon de livraison "+d(t.deliveryNote.delivery_number),1),s[0]||(s[0]=e("p",{class:"text-muted mb-0"},"Détails du bon de livraison",-1))]),e("div",ie,[X(N(E),{href:N(y)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:B(()=>[...s[1]||(s[1]=[e("i",{class:"bi bi-arrow-left me-1"},null,-1),c(" Retour à la liste ",-1)])]),_:1},8,["href"])])]),e("div",le,[e("div",oe,[e("div",ne,[s[10]||(s[10]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Informations générales")],-1)),e("div",de,[e("div",re,[e("div",ae,[s[2]||(s[2]=e("label",{class:"form-label text-muted"},"Numéro de BL",-1)),e("p",ce,d(t.deliveryNote.delivery_number),1)]),e("div",ue,[s[3]||(s[3]=e("label",{class:"form-label text-muted"},"Statut",-1)),e("p",me,[e("span",{class:P(["badge",T(t.deliveryNote.status)])},d(t.deliveryNote.status_label),3)])]),e("div",ve,[s[4]||(s[4]=e("label",{class:"form-label text-muted"},"Fournisseur",-1)),e("p",be,d(t.deliveryNote.supplier?.name||"Non renseigné"),1)]),e("div",ye,[s[5]||(s[5]=e("label",{class:"form-label text-muted"},"Date de livraison",-1)),e("p",fe,d(z(t.deliveryNote.delivery_date)),1)]),e("div",he,[s[6]||(s[6]=e("label",{class:"form-label text-muted"},"Numéro de BC",-1)),e("p",ge,[t.deliveryNote.purchase_order?.po_number?(i(),o("code",_e,d(t.deliveryNote.purchase_order.po_number),1)):(i(),o("span",pe,"Non renseigné"))])]),t.deliveryNote.invoice_number?(i(),o("div",Ne,[s[7]||(s[7]=e("label",{class:"form-label text-muted"},"Numéro de facture",-1)),e("p",xe,[e("code",null,d(t.deliveryNote.invoice_number),1)])])):a("",!0),e("div",we,[s[8]||(s[8]=e("label",{class:"form-label text-muted"},"Créé par",-1)),e("p",ke,d(t.deliveryNote.user?.name||"Non renseigné"),1)])]),t.deliveryNote.notes?(i(),o("div",Fe,[s[9]||(s[9]=e("label",{class:"form-label text-muted"},"Notes",-1)),e("div",Ce,[e("p",De,d(t.deliveryNote.notes),1)])])):a("",!0)])]),e("div",Be,[s[14]||(s[14]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Articles livrés")],-1)),e("div",Le,[!t.deliveryNote.items||t.deliveryNote.items.length===0?(i(),o("div",Se,[...s[11]||(s[11]=[e("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),e("p",null,"Aucun article trouvé pour ce bon de livraison.",-1)])])):(i(),o("div",je,[e("table",Ee,[s[13]||(s[13]=e("thead",{class:"table-light"},[e("tr",null,[e("th",null,"Produit"),e("th",null,"Quantité"),e("th",null,"Prix unitaire d'achat"),e("th",null,"Total")])],-1)),e("tbody",null,[(i(!0),o(Y,null,Z(t.deliveryNote.items,l=>(i(),o("tr",{key:l.id},[e("td",Pe,[e("div",Re,[e("div",Ue,[l.product?.image_url?(i(),o("div",ze,[e("img",{src:l.product.image_url,alt:l.product?.name||"Produit",class:"img-fluid",style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,Te)])):(i(),o("div",Ie,[...s[12]||(s[12]=[e("i",{class:"bi bi-box text-muted"},null,-1)])]))]),e("div",null,[e("div",$e,d(l.product?.name||"Produit supprimé"),1),l.product?(i(),o("div",Ae,d(l.product.category?.name||"Sans catégorie"),1)):a("",!0)])])]),e("td",Me,[e("span",Oe,d(l.quantity),1)]),e("td",Ve,d(g(l.unit_price)),1),e("td",Ge,d(g(l.total_price)),1)]))),128))])])]))])])]),e("div",We,[e("div",qe,[s[22]||(s[22]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Résumé financier")],-1)),e("div",Je,[e("div",Ke,[e("div",Qe,[s[15]||(s[15]=e("span",{class:"text-muted"},"Sous-total",-1)),e("span",He,d(g(t.deliveryNote.subtotal)),1)]),t.deliveryNote.tax_amount>0?(i(),o("div",Xe,[s[16]||(s[16]=e("span",{class:"text-muted"},"Taxes",-1)),e("span",Ye,d(g(t.deliveryNote.tax_amount)),1)])):a("",!0),t.deliveryNote.discount_amount>0?(i(),o("div",Ze,[s[17]||(s[17]=e("span",{class:"text-muted"},"Remise",-1)),e("span",es,"-"+d(g(t.deliveryNote.discount_amount)),1)])):a("",!0),s[19]||(s[19]=e("hr",null,null,-1)),e("div",ss,[s[18]||(s[18]=e("span",{class:"fw-bold"},"Total",-1)),e("span",ts,d(g(t.deliveryNote.total_amount)),1)])]),t.deliveryNote.status==="pending"?(i(),o("div",is,[...s[20]||(s[20]=[e("i",{class:"bi bi-exclamation-triangle me-1"},null,-1),c(" Ce bon de livraison n'est pas encore validé. Le stock ne sera ajusté qu'après validation. ",-1)])])):a("",!0),t.deliveryNote.status==="validated"?(i(),o("div",ls,[...s[21]||(s[21]=[e("i",{class:"bi bi-check-circle me-1"},null,-1),c(" Stock ajusté avec succès ",-1)])])):a("",!0)])]),e("div",os,[s[26]||(s[26]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Actions rapides")],-1)),e("div",ns,[e("div",ds,[e("button",{onClick:W,class:"btn btn-primary",disabled:u.value||m.value},[u.value?(i(),o("span",as)):(i(),o("i",cs)),c(" "+d(u.value?"Téléchargement...":"Télécharger le BL"),1)],8,rs),e("button",{onClick:q,class:"btn btn-info",disabled:m.value||u.value},[m.value?(i(),o("span",ms)):(i(),o("i",vs)),c(" "+d(m.value?"Ouverture...":"Imprimer le BL"),1)],8,us),t.deliveryNote.status==="pending"?(i(),j(N(E),{key:0,href:N(y)("delivery-notes.edit",{id:t.deliveryNote.id}),class:P(["btn btn-outline-primary",{disabled:u.value||m.value}]),tabindex:u.value||m.value?-1:0},{default:B(()=>[...s[23]||(s[23]=[e("i",{class:"bi bi-pencil me-1"},null,-1),c(" Modifier le BL ",-1)])]),_:1},8,["href","class","tabindex"])):a("",!0),t.deliveryNote.status==="pending"&&U.value?(i(),o("button",{key:1,onClick:G,class:"btn btn-success",disabled:u.value||m.value},[...s[24]||(s[24]=[e("i",{class:"bi bi-check-circle me-1"},null,-1),c(" Valider le BL ",-1)])],8,bs)):a("",!0),t.deliveryNote.status==="pending"?(i(),o("button",{key:2,onClick:J,class:"btn btn-outline-danger",disabled:u.value||m.value},[...s[25]||(s[25]=[e("i",{class:"bi bi-trash me-1"},null,-1),c(" Supprimer le bon de livraison ",-1)])],8,ys)):a("",!0)])])]),e("div",fs,[e("div",hs,[s[29]||(s[29]=e("h5",{class:"card-title mb-0"},"Facture/BL fournisseur",-1)),F.value?(i(),o("div",gs,[e("a",{href:k.value,target:"_blank",class:"btn btn-sm btn-outline-primary"},[...s[27]||(s[27]=[e("i",{class:"bi bi-eye me-1"},null,-1),c(" Ouvrir ",-1)])],8,_s),e("button",{onClick:O,class:"btn btn-sm btn-outline-danger"},[...s[28]||(s[28]=[e("i",{class:"bi bi-trash me-1"},null,-1),c(" Supprimer ",-1)])])])):a("",!0)]),e("div",ps,[e("div",Ns,[s[32]||(s[32]=e("label",{class:"form-label"},"Choisir un fichier (PDF ou image)",-1)),e("input",{class:"form-control bg-white",type:"file",accept:".pdf,image/*",onChange:A},null,32),f.value?(i(),o("div",xs,[e("small",ws,[s[30]||(s[30]=e("i",{class:"bi bi-check-circle me-1"},null,-1)),s[31]||(s[31]=c(" Fichier sélectionné: ",-1)),e("strong",null,d(f.value.name),1)])])):a("",!0)]),e("div",ks,[e("div",Fs,[e("button",{class:"btn btn-primary",disabled:!f.value,onClick:M},[s[33]||(s[33]=e("i",{class:"bi bi-upload me-1"},null,-1)),c(" "+d(F.value?"Remplacer le fichier":"Uploader le fichier"),1)],8,Cs)]),s[34]||(s[34]=e("div",{class:"mt-2"},[e("small",{class:"text-muted"},[e("i",{class:"bi bi-info-circle me-1"}),c(" Formats acceptés: PDF, JPG, PNG, WEBP. Taille max 2 Mo. ")])],-1))]),F.value?(i(),o("div",Ds,[s[35]||(s[35]=e("label",{class:"form-label text-muted"},"Aperçu",-1)),e("div",Bs,[I.value?(i(),o("img",{key:0,src:k.value,alt:"Aperçu",class:"img-fluid rounded"},null,8,Ls)):$.value?(i(),o("iframe",{key:1,src:k.value,style:{width:"100%",height:"360px"}},null,8,Ss)):(i(),o("div",js,'Type de fichier non prévisualisable. Utilisez le bouton "Ouvrir".')),e("div",Es,[t.deliveryNote.invoice_file_name?(i(),o("div",Ps,"Nom: "+d(t.deliveryNote.invoice_file_name),1)):a("",!0),t.deliveryNote.invoice_file_size?(i(),o("div",Rs,"Taille: "+d(V(t.deliveryNote.invoice_file_size)),1)):a("",!0)])])])):a("",!0)])])])])]),_:1}))}});export{Os as default};
