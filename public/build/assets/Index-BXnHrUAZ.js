import{u as V,B as D}from"./BootstrapLayout-L_TowVZG.js";import{d as A,r as $,c as F,w as I,a as t,b as u,e as p,f,u as b,o,t as m,F as K,g as M,h as d}from"./app-CGqa7dvF.js";import{r as c}from"./routes-Ds1K_LXc.js";import{S as r}from"./sweetalert2.esm.all-NNS-RXd7.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const R={class:"d-flex justify-content-between align-items-center mb-4"},U={class:"d-flex gap-2"},j=["disabled"],q={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},G={key:1,class:"bi bi-plus-circle me-1"},P=["disabled"],J=["disabled"],N={key:0,class:"alert alert-success alert-dismissible fade show",role:"alert"},W={key:1,class:"alert alert-danger alert-dismissible fade show",role:"alert"},H={class:"card"},Q={class:"table-responsive"},X={class:"table table-hover mb-0"},Y={class:"d-flex align-items-center"},Z={class:"fw-medium"},ee={class:"text-muted small"},te={class:"badge bg-secondary"},se={class:"text-muted small"},re={class:"text-end"},ie={class:"btn-group",role:"group"},ae=["onClick"],ne=["onClick"],le=["onClick"],oe={key:0},ue={class:"card mt-4"},ce={class:"card-body"},de={class:"mb-0"},ge=A({__name:"Index",props:{backups:{},disk:{}},setup(h){const{canCreate:x,canDownload:k,canDelete:y,canRestore:w}=V(),n=$(!1),C=s=>new Date(s).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"}),B=s=>new Date(s).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),S=()=>{r.fire({title:"Création de la sauvegarde",html:"La sauvegarde est en cours de création. Cela peut prendre plusieurs minutes selon la taille de votre base de données et de vos fichiers.<br><br>Veuillez patienter...",icon:"info",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{r.showLoading()}}),n.value=!0,d.post(c("admin.backups.store"),{_method:"POST"},{onSuccess:s=>{if(n.value=!1,s.props?.flash?.error){r.close(),r.fire({title:"Erreur !",text:s.props.flash.error,icon:"error"});return}s.props?.flash?.success?r.fire({title:"Succès !",text:s.props.flash.success,icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{d.visit(c("admin.backups.index"),{preserveState:!1,preserveScroll:!1})}):(r.close(),d.visit(c("admin.backups.index"),{preserveState:!1,preserveScroll:!1}))},onFinish:()=>{n.value=!1,r.close()},onError:s=>{n.value=!1,r.close();const e=s?.message||s?.error||"Une erreur est survenue lors de la création de la sauvegarde.";r.fire({title:"Erreur !",text:e,icon:"error"})}})},E=()=>{r.fire({title:"Création de la sauvegarde",html:"La sauvegarde de la base de données est en cours de création. Cela peut prendre quelques minutes selon la taille de votre base de données.<br><br>Veuillez patienter...",icon:"info",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{r.showLoading()}}),n.value=!0,d.post(c("admin.backups.store"),{only_db:!0},{onSuccess:s=>{n.value=!1,r.fire({title:"Succès !",text:"La sauvegarde de la base de données a été créée avec succès.",icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{d.visit(c("admin.backups.index"),{preserveState:!1,preserveScroll:!1})})},onFinish:()=>{n.value=!1,r.close()},onError:s=>{n.value=!1,r.close();const e=s?.message||s?.error||"Une erreur est survenue lors de la création de la sauvegarde.";r.fire({title:"Erreur !",text:e,icon:"error"})}})},_=s=>{window.location.href=c("admin.backups.download",s)},z=s=>{r.fire({title:"Êtes-vous sûr ?",text:`Voulez-vous vraiment supprimer la sauvegarde "${s}" ?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Oui, supprimer",cancelButtonText:"Annuler"}).then(e=>{e.isConfirmed&&d.delete(c("admin.backups.destroy",s),{onSuccess:()=>{r.fire({title:"Supprimé !",text:"La sauvegarde a été supprimée avec succès.",icon:"success",timer:2e3,showConfirmButton:!1})},onError:a=>{const i=a?.message||a?.error||"Une erreur est survenue lors de la suppression.";r.fire({title:"Erreur !",text:i,icon:"error"})}})})},L=s=>{r.fire({title:"Attention !",html:`
      <p class="text-start">Vous êtes sur le point de restaurer la sauvegarde <strong>${s}</strong>.</p>
      <p class="text-start text-danger"><strong>Cette action est irréversible et remplacera toutes les données actuelles.</strong></p>
      <p class="text-start">Assurez-vous d'avoir créé une sauvegarde récente avant de continuer.</p>
    `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Oui, restaurer",cancelButtonText:"Annuler",input:"checkbox",inputPlaceholder:"Je confirme vouloir restaurer cette sauvegarde",inputValidator:e=>{if(!e)return"Vous devez confirmer la restauration"}}).then(e=>{e.isConfirmed&&e.value&&(r.fire({title:"Restauration en cours",html:`Restauration de la sauvegarde <strong>${s}</strong>...<br><br>Cette opération peut prendre plusieurs minutes. Veuillez patienter...`,icon:"info",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{r.showLoading()}}),n.value=!0,d.post(c("admin.backups.restore",s),{confirm:!0},{onSuccess:()=>{n.value=!1,r.close(),r.fire({title:"Succès !",text:"La sauvegarde a été restaurée avec succès. L'application a été restaurée à l'état de la sauvegarde.",icon:"success",confirmButtonText:"OK"}).then(()=>{d.visit(c("admin.backups.index"))})},onError:a=>{n.value=!1,r.close();let i="Une erreur est survenue lors de la restauration.";try{typeof a=="string"?i=a:a&&typeof a=="object"&&(a.message?i=a.message:a.error&&(i=a.error))}catch(l){console.error("Erreur lors de la gestion des erreurs:",l)}r.fire({title:"Erreur !",text:i,icon:"error",confirmButtonText:"OK"})}}))})},O=()=>{r.fire({title:"Importer une sauvegarde",html:`
      <p class="text-start mb-3">Sélectionnez un fichier zip de sauvegarde à importer.</p>
      <input type="file" id="backup-file-input" class="form-control" accept=".zip">
      <p class="text-muted small mt-2 text-start">
        <i class="bi bi-info-circle me-1"></i>
        Le fichier doit être un fichier zip valide contenant une sauvegarde de l'application.
      </p>
    `,icon:"info",showCancelButton:!0,confirmButtonText:"Importer",cancelButtonText:"Annuler",confirmButtonColor:"#198754",cancelButtonColor:"#6c757d",didOpen:()=>{const s=document.getElementById("backup-file-input");s&&s.focus()},preConfirm:()=>{const s=document.getElementById("backup-file-input");if(!s||!s.files||s.files.length===0)return r.showValidationMessage("Veuillez sélectionner un fichier zip."),!1;const e=s.files[0];if(!e.name.endsWith(".zip"))return r.showValidationMessage("Le fichier doit être un fichier zip (.zip)."),!1;const a=10*1024*1024*1024;return e.size>a?(r.showValidationMessage("Le fichier est trop volumineux. Taille maximale : 10 GB."),!1):e}}).then(s=>{if(s.isConfirmed&&s.value){const e=s.value;if(!e||!(e instanceof File)){r.fire({title:"Erreur !",text:"Le fichier sélectionné n'est pas valide.",icon:"error"});return}r.fire({title:"Import en cours",html:`Import du fichier <strong>${e.name}</strong>...<br><br>Veuillez patienter...`,icon:"info",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{r.showLoading()}}),n.value=!0;const a=new FormData;a.append("backup_file",e),d.post(c("admin.backups.import"),a,{forceFormData:!0,preserveState:!1,preserveScroll:!1,onSuccess:i=>{if(n.value=!1,i.props?.flash?.error){r.fire({title:"Erreur !",text:i.props.flash.error,icon:"error"});return}i.props?.flash?.success?r.fire({title:"Succès !",text:i.props.flash.success,icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{d.visit(c("admin.backups.index"),{preserveState:!1,preserveScroll:!1})}):(r.close(),d.visit(c("admin.backups.index"),{preserveState:!1,preserveScroll:!1}))},onFinish:()=>{n.value=!1,r.close()},onError:i=>{n.value=!1,r.close();let l="Une erreur est survenue lors de l'import de la sauvegarde.";try{if(typeof i=="string")l=i;else if(i&&typeof i=="object")if(i.backup_file)Array.isArray(i.backup_file)?l=i.backup_file[0]:typeof i.backup_file=="string"&&(l=i.backup_file);else if(i.message)l=i.message;else if(i.error)l=i.error;else{const g=Object.keys(i);if(g.length>0){const T=g[0],v=i[T];Array.isArray(v)&&v.length>0?l=v[0]:typeof v=="string"&&(l=v)}}}catch(g){console.error("Erreur lors de la gestion des erreurs:",g),l="Une erreur inattendue est survenue lors de l'import de la sauvegarde."}(!l||l.trim()==="")&&(l="Une erreur est survenue lors de l'import de la sauvegarde."),r.fire({title:"Erreur !",html:`<div class="text-start">${l}</div>`,icon:"error",confirmButtonText:"OK",width:"500px"})}})}})};return(s,e)=>(o(),F(D,null,{default:I(()=>[t("div",R,[e[2]||(e[2]=t("div",null,[t("h1",{class:"h2 mb-1"},[t("i",{class:"bi bi-database me-2"}),f(" Gestion des sauvegardes ")]),t("p",{class:"text-muted mb-0"},"Gérez les sauvegardes de votre application")],-1)),t("div",U,[b(x)("backups")?(o(),u("button",{key:0,onClick:S,class:"btn btn-primary",disabled:n.value},[n.value?(o(),u("span",q)):(o(),u("i",G)),f(" "+m(n.value?"Création en cours...":"Créer une sauvegarde"),1)],8,j)):p("",!0),b(x)("backups")?(o(),u("button",{key:1,onClick:E,class:"btn btn-outline-primary",disabled:n.value},[...e[0]||(e[0]=[t("i",{class:"bi bi-database me-1"},null,-1),f(" Sauvegarde DB uniquement ",-1)])],8,P)):p("",!0),b(x)("backups")?(o(),u("button",{key:2,onClick:O,class:"btn btn-outline-success",disabled:n.value},[...e[1]||(e[1]=[t("i",{class:"bi bi-upload me-1"},null,-1),f(" Importer une sauvegarde ",-1)])],8,J)):p("",!0)])]),s.$page.props.flash?.success?(o(),u("div",N,[e[3]||(e[3]=t("i",{class:"bi bi-check-circle me-2"},null,-1)),f(" "+m(s.$page.props.flash.success)+" ",1),e[4]||(e[4]=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"alert","aria-label":"Close"},null,-1))])):p("",!0),s.$page.props.flash?.error?(o(),u("div",W,[e[5]||(e[5]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),f(" "+m(s.$page.props.flash.error)+" ",1),e[6]||(e[6]=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"alert","aria-label":"Close"},null,-1))])):p("",!0),t("div",H,[t("div",Q,[t("table",X,[e[12]||(e[12]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Nom du fichier"),t("th",null,"Taille"),t("th",null,"Date de création"),t("th",{class:"text-end"},"Actions")])],-1)),t("tbody",null,[(o(!0),u(K,null,M(h.backups,a=>(o(),u("tr",{key:a.name},[t("td",null,[t("div",Y,[e[7]||(e[7]=t("div",{class:"flex-shrink-0 me-3"},[t("div",{class:"bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center",style:{width:"40px",height:"40px"}},[t("i",{class:"bi bi-file-zip text-success"})])],-1)),t("div",null,[t("div",Z,m(a.name),1),t("div",ee,m(a.path),1)])])]),t("td",null,[t("span",te,m(a.size),1)]),t("td",null,[t("div",null,m(C(a.date)),1),t("div",se,m(B(a.date)),1)]),t("td",re,[t("div",ie,[b(k)("backups")?(o(),u("button",{key:0,onClick:i=>_(a.name),class:"btn btn-sm btn-outline-primary",title:"Télécharger"},[...e[8]||(e[8]=[t("i",{class:"bi bi-download"},null,-1)])],8,ae)):p("",!0),b(w)("backups")?(o(),u("button",{key:1,onClick:i=>L(a.name),class:"btn btn-sm btn-outline-warning",title:"Restaurer"},[...e[9]||(e[9]=[t("i",{class:"bi bi-arrow-counterclockwise"},null,-1)])],8,ne)):p("",!0),b(y)("backups")?(o(),u("button",{key:2,onClick:i=>z(a.name),class:"btn btn-sm btn-outline-danger",title:"Supprimer"},[...e[10]||(e[10]=[t("i",{class:"bi bi-trash"},null,-1)])],8,le)):p("",!0)])])]))),128)),h.backups.length===0?(o(),u("tr",oe,[...e[11]||(e[11]=[t("td",{colspan:"4",class:"text-center text-muted py-4"},[t("i",{class:"bi bi-inbox fs-1 d-block mb-2"}),f(" Aucune sauvegarde trouvée ")],-1)])])):p("",!0)])])])]),t("div",ue,[e[17]||(e[17]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},[t("i",{class:"bi bi-info-circle me-2"}),f(" Informations ")])],-1)),t("div",ce,[t("ul",de,[e[14]||(e[14]=t("li",null,"Les sauvegardes incluent la base de données et les fichiers de l'application.",-1)),t("li",null,[e[13]||(e[13]=f("Les sauvegardes sont stockées sur le disque: ",-1)),t("strong",null,m(h.disk),1)]),e[15]||(e[15]=t("li",null,"Les anciennes sauvegardes sont automatiquement nettoyées selon la stratégie configurée.",-1)),e[16]||(e[16]=t("li",{class:"text-danger"},[t("strong",null,"Attention:"),f(" La restauration remplacera toutes les données actuelles. Assurez-vous d'avoir une sauvegarde récente avant de restaurer.")],-1))])])])]),_:1}))}});export{ge as default};
