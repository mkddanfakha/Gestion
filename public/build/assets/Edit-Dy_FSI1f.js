import{d as H,i as J,y,c as K,w as q,a as s,j as A,t as c,u as n,l as W,f as v,m as p,b as d,e as _,n as b,o as a,F as w,g as F,p as S,v as f,s as D}from"./app-CKyF0dn4.js";import{_ as X}from"./AppLayout.vue_vue_type_script_setup_true_lang-IbUY7iBr.js";import{r as V}from"./routes-D3G7R3Tx.js";import{u as Y}from"./useSweetAlert-CjcY7Pj8.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-DOjYiQwv.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const tt={class:"d-flex justify-content-between align-items-center mb-4"},st={class:"h2 mb-1"},et={class:"row"},ot={class:"col-lg-8"},nt={class:"card mb-4"},it={class:"card-body"},lt={class:"row g-3"},at={class:"col-md-6"},dt=["value"],rt={key:0,class:"invalid-feedback"},ut={class:"col-md-6"},ct={key:0,class:"invalid-feedback"},mt={class:"col-md-6"},pt={key:0,class:"invalid-feedback"},_t={class:"mt-3"},vt={key:0,class:"invalid-feedback"},bt={class:"card mb-4"},ft={class:"card-header d-flex justify-content-between align-items-center"},yt={class:"d-flex gap-2"},gt={class:"card-body"},xt={key:0,class:"text-center py-4 text-muted"},ht={key:1},kt={class:"row g-3"},qt={class:"col-md-5"},wt=["onUpdate:modelValue","onChange"],Ft=["value","disabled"],St={key:0},Vt={key:0,class:"invalid-feedback"},Ct={class:"col-md-2"},It=["onUpdate:modelValue","onInput"],Nt={class:"col-md-2"},jt={class:"input-group"},Ut=["onUpdate:modelValue","onInput"],At={class:"col-md-2"},Wt={class:"input-group"},Dt=["onUpdate:modelValue"],Pt={class:"col-md-1 d-flex align-items-end"},Mt=["onClick"],Et={class:"col-lg-4"},Tt={class:"card"},zt={class:"card-body"},$t={class:"d-flex justify-content-between mb-2"},Bt={class:"fw-medium"},Rt={class:"d-flex justify-content-between mb-2"},Lt={class:"fw-medium"},Ot={class:"mb-3"},Qt={class:"input-group"},Gt={key:0,class:"invalid-feedback"},Ht={class:"mb-3"},Jt={class:"input-group"},Kt={key:0,class:"invalid-feedback"},Xt={class:"d-flex justify-content-between mb-3"},Yt={class:"fw-bold text-success fs-5"},Zt={class:"d-grid gap-2"},ts=["disabled"],ss={key:0,class:"spinner-border spinner-border-sm me-2"},es={key:1,class:"bi bi-check-circle me-1"},os=H({__name:"Edit",props:{quote:{},customers:{},products:{}},setup(g){const m=g,{success:P,error:C}=Y(),i=J({customer_id:m.quote.customer_id||"",status:m.quote.status,notes:m.quote.notes||"",valid_until:m.quote.valid_until?new Date(m.quote.valid_until).toISOString().split("T")[0]:"",tax_amount:parseFloat(String(m.quote.tax_amount))||0,discount_amount:parseFloat(String(m.quote.discount_amount))||0,items:m.quote.quoteItems?m.quote.quoteItems.map(e=>({product_id:e.product_id||0,quantity:parseInt(String(e.quantity))||1,unit_price:parseFloat(String(e.unit_price))||0,total_price:parseFloat(String(e.total_price))||0})):[]}),M=()=>{i.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},E=e=>{i.items.splice(e,1)},T=e=>{const t=i.items[e],o=m.products.find(u=>u.id===t.product_id);o&&(t.unit_price=o.price,x(e))},x=e=>{const t=i.items[e],o=parseFloat(String(t.quantity))||0,u=parseFloat(String(t.unit_price))||0,l=o*u;t.total_price=isNaN(l)?0:l},h=(e,t)=>e?i.items.some((o,u)=>u!==t&&o.product_id===e):!1,I=e=>{const t=i.items[e];return t.product_id?h(t.product_id,e):!1},z=y(()=>{const e=i.items.map(t=>t.product_id).filter(t=>t>0);return e.length!==new Set(e).size}),$=()=>{const e=new Map;i.items.forEach(t=>{if(t.product_id>0)if(e.has(t.product_id)){const o=e.get(t.product_id);o.quantity+=t.quantity,o.total_price=o.quantity*o.unit_price}else e.set(t.product_id,{...t})}),i.items=Array.from(e.values())},N=e=>{if(!e||e===0||typeof e!="number"||isNaN(e))return"80px";const G=70+e.toFixed(2).length*9;return`${Math.max(70,Math.min(130,G))}px`},j=e=>{if(e==null)return"0 Fcfa";const t=parseFloat(String(e));return isNaN(t)?"0 Fcfa":new Intl.NumberFormat("fr-FR").format(t)+" Fcfa"},B=y(()=>i.items.length),U=y(()=>{const e=i.items.reduce((t,o)=>{const u=parseFloat(String(o.total_price))||0;return t+u},0);return isNaN(e)?0:e}),R=y(()=>parseFloat(String(i.tax_amount))||0),L=y(()=>parseFloat(String(i.discount_amount))||0),O=y(()=>U.value+R.value-L.value),Q=()=>{if(i.items.length===0){C("Veuillez ajouter au moins un article.");return}const e={customer_id:i.customer_id||null,status:i.status,notes:i.notes||null,valid_until:i.valid_until||null,tax_amount:i.tax_amount||0,discount_amount:i.discount_amount||0,items:i.items.map(t=>({product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))};i.transform(()=>e).put(V("quotes.update",{id:m.quote.id}),{onSuccess:()=>{P("Devis modifié avec succès !")},onError:t=>{console.error("Erreurs de validation:",t),C("Erreur lors de la modification du devis.")}})},{errors:r,processing:k}=i;return(e,t)=>(a(),K(X,null,{default:q(()=>[s("div",tt,[s("div",null,[s("h1",st,"Modifier le devis "+c(g.quote.quote_number),1),t[6]||(t[6]=s("p",{class:"text-muted mb-0"},"Modifiez les informations du devis",-1))]),A(n(W),{href:n(V)("quotes.index"),class:"btn btn-outline-secondary"},{default:q(()=>[...t[7]||(t[7]=[s("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),s("form",null,[s("div",et,[s("div",ot,[s("div",nt,[t[15]||(t[15]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Informations générales")],-1)),s("div",it,[s("div",lt,[s("div",at,[t[9]||(t[9]=s("label",{class:"form-label"},"Client",-1)),p(s("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>n(i).customer_id=o),class:b(["form-select",{"is-invalid":n(r).customer_id}])},[t[8]||(t[8]=s("option",{value:""},"Sélectionner un client (optionnel)",-1)),(a(!0),d(w,null,F(g.customers,o=>(a(),d("option",{key:o.id,value:o.id},c(o.name),9,dt))),128))],2),[[S,n(i).customer_id]]),n(r).customer_id?(a(),d("div",rt,c(n(r).customer_id),1)):_("",!0)]),s("div",ut,[t[11]||(t[11]=s("label",{class:"form-label"},"Statut",-1)),p(s("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>n(i).status=o),class:b(["form-select",{"is-invalid":n(r).status}])},[...t[10]||(t[10]=[s("option",{value:"draft"},"Brouillon",-1),s("option",{value:"sent"},"Envoyé",-1),s("option",{value:"accepted"},"Accepté",-1),s("option",{value:"rejected"},"Refusé",-1),s("option",{value:"expired"},"Expiré",-1)])],2),[[S,n(i).status]]),n(r).status?(a(),d("div",ct,c(n(r).status),1)):_("",!0)]),s("div",mt,[t[12]||(t[12]=s("label",{class:"form-label"},"Date de validité (optionnel)",-1)),p(s("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>n(i).valid_until=o),type:"date",class:b(["form-control",{"is-invalid":n(r).valid_until}])},null,2),[[f,n(i).valid_until]]),n(r).valid_until?(a(),d("div",pt,c(n(r).valid_until),1)):_("",!0),t[13]||(t[13]=s("small",{class:"form-text text-muted"},"Date limite de validité du devis",-1))])]),s("div",_t,[t[14]||(t[14]=s("label",{class:"form-label"},"Notes (optionnel)",-1)),p(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=o=>n(i).notes=o),rows:"3",class:b(["form-control",{"is-invalid":n(r).notes}]),placeholder:"Ajoutez des notes sur ce devis..."},null,2),[[f,n(i).notes]]),n(r).notes?(a(),d("div",vt,c(n(r).notes),1)):_("",!0)])])]),s("div",bt,[s("div",ft,[t[18]||(t[18]=s("h5",{class:"card-title mb-0"},"Articles",-1)),s("div",yt,[z.value?(a(),d("button",{key:0,type:"button",onClick:$,class:"btn btn-warning btn-sm"},[...t[16]||(t[16]=[s("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):_("",!0),s("button",{type:"button",onClick:M,class:"btn btn-primary btn-sm"},[...t[17]||(t[17]=[s("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),s("div",gt,[n(i).items.length===0?(a(),d("div",xt,[...t[19]||(t[19]=[s("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),s("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(a(),d("div",ht,[(a(!0),d(w,null,F(n(i).items,(o,u)=>(a(),d("div",{key:u,class:"border rounded p-3 mb-3"},[s("div",kt,[s("div",qt,[t[21]||(t[21]=s("label",{class:"form-label"},[v(" Produit "),s("span",{class:"text-danger"},"*")],-1)),p(s("select",{"onUpdate:modelValue":l=>o.product_id=l,required:"",class:b(["form-select",{"is-invalid":I(u)}]),onChange:l=>T(u)},[t[20]||(t[20]=s("option",{value:""},"Sélectionner un produit",-1)),(a(!0),d(w,null,F(g.products,l=>(a(),d("option",{key:l.id,value:l.id,disabled:h(l.id,u)},[v(c(l.name)+" ",1),h(l.id,u)?(a(),d("span",St," - Déjà sélectionné")):_("",!0)],8,Ft))),128))],42,wt),[[S,o.product_id]]),I(u)?(a(),d("div",Vt," Ce produit est déjà sélectionné dans ce devis. ")):_("",!0)]),s("div",Ct,[t[22]||(t[22]=s("label",{class:"form-label"},[v(" Quantité "),s("span",{class:"text-danger"},"*")],-1)),p(s("input",{"onUpdate:modelValue":l=>o.quantity=l,type:"number",min:"1",required:"",class:"form-control",onInput:l=>x(u)},null,40,It),[[f,o.quantity,void 0,{number:!0}]])]),s("div",Nt,[t[24]||(t[24]=s("label",{class:"form-label"},"Prix unitaire",-1)),s("div",jt,[p(s("input",{"onUpdate:modelValue":l=>o.unit_price=l,type:"number",step:"0.01",min:"0",class:"form-control",style:D({width:N(o.unit_price)}),onInput:l=>x(u)},null,44,Ut),[[f,o.unit_price,void 0,{number:!0}]]),t[23]||(t[23]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",At,[t[26]||(t[26]=s("label",{class:"form-label"},"Total",-1)),s("div",Wt,[p(s("input",{"onUpdate:modelValue":l=>o.total_price=l,type:"number",step:"0.01",readonly:"",class:"form-control",style:D({width:N(o.total_price)})},null,12,Dt),[[f,o.total_price,void 0,{number:!0}]]),t[25]||(t[25]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",Pt,[s("button",{type:"button",onClick:l=>E(u),class:"btn btn-outline-danger w-100"},[...t[27]||(t[27]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Mt)])])]))),128))]))])])]),s("div",Et,[s("div",Tt,[t[37]||(t[37]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Résumé du devis")],-1)),s("div",zt,[s("div",$t,[t[28]||(t[28]=s("span",null,"Nombre d'articles:",-1)),s("span",Bt,c(B.value),1)]),s("div",Rt,[t[29]||(t[29]=s("span",null,"Sous-total:",-1)),s("span",Lt,c(j(U.value)),1)]),s("div",Ot,[t[31]||(t[31]=s("label",{class:"form-label"},"Taxes (Fcfa)",-1)),s("div",Qt,[p(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=o=>n(i).tax_amount=o),step:"0.01",min:"0",class:b(["form-control",{"is-invalid":n(r).tax_amount}]),placeholder:"0.00"},null,2),[[f,n(i).tax_amount,void 0,{number:!0}]]),t[30]||(t[30]=s("span",{class:"input-group-text"},"Fcfa",-1))]),n(r).tax_amount?(a(),d("div",Gt,c(n(r).tax_amount),1)):_("",!0)]),s("div",Ht,[t[33]||(t[33]=s("label",{class:"form-label"},"Remise (Fcfa)",-1)),s("div",Jt,[p(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=o=>n(i).discount_amount=o),step:"0.01",min:"0",class:b(["form-control",{"is-invalid":n(r).discount_amount}]),placeholder:"0.00"},null,2),[[f,n(i).discount_amount,void 0,{number:!0}]]),t[32]||(t[32]=s("span",{class:"input-group-text"},"Fcfa",-1))]),n(r).discount_amount?(a(),d("div",Kt,c(n(r).discount_amount),1)):_("",!0)]),t[36]||(t[36]=s("hr",null,null,-1)),s("div",Xt,[t[34]||(t[34]=s("span",{class:"fw-bold"},"Total:",-1)),s("span",Yt,c(j(O.value)),1)]),s("div",Zt,[s("button",{type:"button",onClick:Q,class:"btn btn-primary",disabled:n(k)||n(i).items.length===0},[n(k)?(a(),d("span",ss)):(a(),d("i",es)),v(" "+c(n(k)?"Modification...":"Modifier le devis"),1)],8,ts),A(n(W),{href:n(V)("quotes.index"),class:"btn btn-outline-secondary"},{default:q(()=>[...t[35]||(t[35]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),_s=Z(os,[["__scopeId","data-v-da29c86e"]]);export{_s as default};
