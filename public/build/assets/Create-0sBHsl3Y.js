import{d as G,i as H,y as f,c as J,w as g,a as s,j as h,u as e,l as A,f as v,m,b as a,e as p,n as b,o as d,F as I,g as U,t as c,p as P,v as _,s as j}from"./app-DG1zKyXK.js";import{_ as K}from"./AppLayout.vue_vue_type_script_setup_true_lang-BeGZtpnK.js";import{r as k}from"./routes-C8N3XD_S.js";import{u as X}from"./useSweetAlert-CjcY7Pj8.js";import{P as Y}from"./ProductAutocomplete-DSGgwAoE.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-BOh8Ux6F.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const tt={class:"d-flex justify-content-between align-items-center mb-4"},st={class:"row"},et={class:"col-lg-8"},ot={class:"card mb-4"},nt={class:"card-body"},lt={class:"row g-3"},it={class:"col-md-6"},dt=["value"],at={key:0,class:"invalid-feedback"},rt={class:"col-md-6"},ut={key:0,class:"invalid-feedback"},ct={class:"col-md-6"},mt=["min"],pt={key:0,class:"invalid-feedback"},vt={class:"mt-3"},_t={key:0,class:"invalid-feedback"},bt={class:"card mb-4"},ft={class:"card-header d-flex justify-content-between align-items-center"},yt={class:"d-flex gap-2"},xt={class:"card-body"},gt={key:0,class:"text-center py-4 text-muted"},ht={key:1},kt={class:"row g-3"},wt={class:"col-md-5"},Vt={key:0,class:"invalid-feedback d-block"},Ct={class:"col-md-2"},Ft=["onUpdate:modelValue","onInput"],St={class:"col-md-2"},qt={class:"input-group"},At=["onUpdate:modelValue","onInput"],It={class:"col-md-2"},Ut={class:"input-group"},Pt=["onUpdate:modelValue"],jt={class:"col-md-1 d-flex align-items-end"},Wt=["onClick"],Dt={class:"col-lg-4"},Et={class:"card"},Nt={class:"card-body"},zt={class:"d-flex justify-content-between mb-2"},Tt={class:"fw-medium"},Mt={class:"mb-3"},Rt={class:"input-group"},Bt={key:0,class:"invalid-feedback"},$t={class:"mb-3"},Lt={class:"input-group"},Ot={key:0,class:"invalid-feedback"},Qt={class:"d-flex justify-content-between mb-3"},Gt={class:"fw-bold text-success fs-5"},Ht={class:"d-grid gap-2"},Jt=["disabled"],Kt={key:0,class:"spinner-border spinner-border-sm me-2"},Xt={key:1,class:"bi bi-check-circle me-1"},Yt=G({__name:"Create",props:{customers:{},products:{}},setup(w){const{success:W,error:V}=X(),o=H({customer_id:"",status:"draft",notes:"",valid_until:"",tax_amount:0,discount_amount:0,items:[]}),D=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},E=l=>{o.items.splice(l,1)},y=l=>{const t=o.items[l];t.total_price=t.quantity*t.unit_price},N=(l,t)=>l?o.items.some((n,u)=>u!==t&&n.product_id===l):!1,C=l=>{const t=o.items[l];return t.product_id?N(t.product_id,l):!1},z=l=>o.items.map((t,n)=>n!==l?t.product_id:null).filter(t=>t!==null&&t>0),T=(l,t)=>{const n=o.items[t];n.product_id=l.id,n.unit_price=l.price,y(t)},M=f(()=>{const l=o.items.map(t=>t.product_id).filter(t=>t>0);return l.length!==new Set(l).size}),R=()=>{const l=new Map;o.items.forEach(t=>{if(t.product_id>0)if(l.has(t.product_id)){const n=l.get(t.product_id);n.quantity+=t.quantity,n.total_price=n.quantity*n.unit_price}else l.set(t.product_id,{...t})}),o.items=Array.from(l.values())},F=l=>{if(!l||l===0||typeof l!="number"||isNaN(l))return"80px";const Q=70+l.toFixed(2).length*9;return`${Math.max(70,Math.min(130,Q))}px`},S=l=>new Intl.NumberFormat("fr-FR").format(l)+" Fcfa",q=f(()=>o.items.reduce((l,t)=>l+t.total_price,0)),B=f(()=>o.tax_amount||0),$=f(()=>o.discount_amount||0),L=f(()=>q.value+B.value-$.value),O=()=>{if(o.items.length===0){V("Veuillez ajouter au moins un article.");return}const l={customer_id:o.customer_id||null,status:o.status,notes:o.notes||null,valid_until:o.valid_until||null,tax_amount:o.tax_amount||0,discount_amount:o.discount_amount||0,items:o.items.map(t=>({product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))};o.transform(()=>l).post(k("quotes.store"),{onSuccess:()=>{W("Devis créé avec succès !"),o.reset()},onError:t=>{console.error("Erreurs de validation:",t),V("Erreur lors de la création du devis.")}})},{errors:i,processing:x}=o;return(l,t)=>(d(),J(K,null,{default:g(()=>[s("div",tt,[t[7]||(t[7]=s("div",null,[s("h1",{class:"h2 mb-1"},"Nouveau devis"),s("p",{class:"text-muted mb-0"},"Créez un nouveau devis")],-1)),h(e(A),{href:e(k)("quotes.index"),class:"btn btn-outline-secondary"},{default:g(()=>[...t[6]||(t[6]=[s("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),s("form",null,[s("div",st,[s("div",et,[s("div",ot,[t[15]||(t[15]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Informations générales")],-1)),s("div",nt,[s("div",lt,[s("div",it,[t[9]||(t[9]=s("label",{class:"form-label"},"Client",-1)),m(s("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>e(o).customer_id=n),class:b(["form-select",{"is-invalid":e(i).customer_id}])},[t[8]||(t[8]=s("option",{value:""},"Sélectionner un client (optionnel)",-1)),(d(!0),a(I,null,U(w.customers,n=>(d(),a("option",{key:n.id,value:n.id},c(n.name),9,dt))),128))],2),[[P,e(o).customer_id]]),e(i).customer_id?(d(),a("div",at,c(e(i).customer_id),1)):p("",!0)]),s("div",rt,[t[11]||(t[11]=s("label",{class:"form-label"},"Statut",-1)),m(s("select",{"onUpdate:modelValue":t[1]||(t[1]=n=>e(o).status=n),class:b(["form-select",{"is-invalid":e(i).status}])},[...t[10]||(t[10]=[s("option",{value:"draft"},"Brouillon",-1),s("option",{value:"sent"},"Envoyé",-1),s("option",{value:"accepted"},"Accepté",-1),s("option",{value:"rejected"},"Refusé",-1),s("option",{value:"expired"},"Expiré",-1)])],2),[[P,e(o).status]]),e(i).status?(d(),a("div",ut,c(e(i).status),1)):p("",!0)]),s("div",ct,[t[12]||(t[12]=s("label",{class:"form-label"},"Date de validité (optionnel)",-1)),m(s("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>e(o).valid_until=n),type:"date",class:b(["form-control",{"is-invalid":e(i).valid_until}]),min:new Date().toISOString().split("T")[0]},null,10,mt),[[_,e(o).valid_until]]),e(i).valid_until?(d(),a("div",pt,c(e(i).valid_until),1)):p("",!0),t[13]||(t[13]=s("small",{class:"form-text text-muted"},"Date limite de validité du devis",-1))])]),s("div",vt,[t[14]||(t[14]=s("label",{class:"form-label"},"Notes (optionnel)",-1)),m(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=n=>e(o).notes=n),rows:"3",class:b(["form-control",{"is-invalid":e(i).notes}]),placeholder:"Ajoutez des notes sur ce devis..."},null,2),[[_,e(o).notes]]),e(i).notes?(d(),a("div",_t,c(e(i).notes),1)):p("",!0)])])]),s("div",bt,[s("div",ft,[t[18]||(t[18]=s("h5",{class:"card-title mb-0"},"Articles",-1)),s("div",yt,[M.value?(d(),a("button",{key:0,type:"button",onClick:R,class:"btn btn-warning btn-sm"},[...t[16]||(t[16]=[s("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):p("",!0),s("button",{type:"button",onClick:D,class:"btn btn-primary btn-sm"},[...t[17]||(t[17]=[s("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),s("div",xt,[e(o).items.length===0?(d(),a("div",gt,[...t[19]||(t[19]=[s("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),s("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(d(),a("div",ht,[(d(!0),a(I,null,U(e(o).items,(n,u)=>(d(),a("div",{key:u,class:"border rounded p-3 mb-3"},[s("div",kt,[s("div",wt,[t[20]||(t[20]=s("label",{class:"form-label"},[v(" Produit "),s("span",{class:"text-danger"},"*")],-1)),h(Y,{modelValue:n.product_id,"onUpdate:modelValue":r=>n.product_id=r,products:w.products,"exclude-product-ids":z(u),"is-invalid":C(u),placeholder:"Rechercher un produit...",onSelected:r=>T(r,u)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),C(u)?(d(),a("div",Vt," Ce produit est déjà sélectionné dans ce devis. ")):p("",!0)]),s("div",Ct,[t[21]||(t[21]=s("label",{class:"form-label"},[v(" Quantité "),s("span",{class:"text-danger"},"*")],-1)),m(s("input",{"onUpdate:modelValue":r=>n.quantity=r,type:"number",min:"1",required:"",class:"form-control",onInput:r=>y(u)},null,40,Ft),[[_,n.quantity,void 0,{number:!0}]])]),s("div",St,[t[23]||(t[23]=s("label",{class:"form-label"},"Prix unitaire",-1)),s("div",qt,[m(s("input",{"onUpdate:modelValue":r=>n.unit_price=r,type:"number",step:"0.01",min:"0",class:"form-control",style:j({width:F(n.unit_price)}),onInput:r=>y(u)},null,44,At),[[_,n.unit_price,void 0,{number:!0}]]),t[22]||(t[22]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",It,[t[25]||(t[25]=s("label",{class:"form-label"},"Total",-1)),s("div",Ut,[m(s("input",{"onUpdate:modelValue":r=>n.total_price=r,type:"number",step:"0.01",readonly:"",class:"form-control",style:j({width:F(n.total_price)})},null,12,Pt),[[_,n.total_price,void 0,{number:!0}]]),t[24]||(t[24]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",jt,[s("button",{type:"button",onClick:r=>E(u),class:"btn btn-outline-danger w-100"},[...t[26]||(t[26]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Wt)])])]))),128))]))])])]),s("div",Dt,[s("div",Et,[t[35]||(t[35]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Résumé du devis")],-1)),s("div",Nt,[s("div",zt,[t[27]||(t[27]=s("span",null,"Sous-total:",-1)),s("span",Tt,c(S(q.value)),1)]),s("div",Mt,[t[29]||(t[29]=s("label",{class:"form-label"},"Taxes (Fcfa)",-1)),s("div",Rt,[m(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=n=>e(o).tax_amount=n),step:"0.01",min:"0",class:b(["form-control",{"is-invalid":e(i).tax_amount}]),placeholder:"0.00"},null,2),[[_,e(o).tax_amount,void 0,{number:!0}]]),t[28]||(t[28]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(i).tax_amount?(d(),a("div",Bt,c(e(i).tax_amount),1)):p("",!0)]),s("div",$t,[t[31]||(t[31]=s("label",{class:"form-label"},"Remise (Fcfa)",-1)),s("div",Lt,[m(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=n=>e(o).discount_amount=n),step:"0.01",min:"0",class:b(["form-control",{"is-invalid":e(i).discount_amount}]),placeholder:"0.00"},null,2),[[_,e(o).discount_amount,void 0,{number:!0}]]),t[30]||(t[30]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(i).discount_amount?(d(),a("div",Ot,c(e(i).discount_amount),1)):p("",!0)]),t[34]||(t[34]=s("hr",null,null,-1)),s("div",Qt,[t[32]||(t[32]=s("span",{class:"fw-bold"},"Total:",-1)),s("span",Gt,c(S(L.value)),1)]),s("div",Ht,[s("button",{type:"button",onClick:O,class:"btn btn-primary",disabled:e(x)||e(o).items.length===0},[e(x)?(d(),a("span",Kt)):(d(),a("i",Xt)),v(" "+c(e(x)?"Enregistrement...":"Enregistrer le devis"),1)],8,Jt),h(e(A),{href:e(k)("quotes.index"),class:"btn btn-outline-secondary"},{default:g(()=>[...t[33]||(t[33]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),us=Z(Yt,[["__scopeId","data-v-4296ebda"]]);export{us as default};
