import{d as ie,r as $,i as oe,y as U,B,z as re,C as le,c as ne,w as C,a as t,t as c,j as P,u as l,l as F,f as v,m as f,b as d,e as m,n as k,o as n,F as O,g as T,p as ue,v as y}from"./app-Ctez1HXG.js";import{_ as de}from"./AppLayout.vue_vue_type_script_setup_true_lang-DkXoEYZQ.js";import{r as A}from"./routes-C8N3XD_S.js";import{u as ae}from"./useSweetAlert-CjcY7Pj8.js";import{P as ce}from"./ProductAutocomplete-BZ_fcfek.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-ri-ER_V1.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const me={class:"d-flex justify-content-between align-items-center mb-4"},_e={class:"text-muted mb-0"},ve={class:"d-flex gap-2"},be={class:"row"},fe={class:"col-lg-8"},ye={class:"card mb-4"},he={class:"card-body"},ke={class:"row g-3"},ge={class:"col-md-6"},Ne=["value"],we={key:0,class:"invalid-feedback"},qe={key:1,class:"invalid-feedback"},xe={class:"col-md-6"},Ve={class:"position-relative"},$e={key:0,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ce=["onClick"],Pe={key:1,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ae={key:2,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Se={key:0,class:"mt-1"},je={key:0,class:"text-danger small"},Ie={key:1,class:"text-danger small"},Le={key:1,class:"mt-2"},Ee={class:"badge bg-primary"},Ue={class:"col-md-6"},Be={key:0,class:"invalid-feedback"},Fe={key:1,class:"invalid-feedback"},Oe={class:"col-md-6"},Te={key:0,class:"invalid-feedback"},ze={class:"col-12"},Me={key:0,class:"invalid-feedback"},De={class:"card mb-4"},Re={class:"card-body"},Qe={key:0,class:"text-center py-4 text-muted"},Xe={key:1},Ge={class:"row g-3"},He={class:"col-md-5"},Je={key:0,class:"invalid-feedback d-block"},Ke={key:1,class:"invalid-feedback d-block"},We={class:"col-md-2"},Ye=["onUpdate:modelValue","onInput","onBlur"],Ze={key:0,class:"invalid-feedback"},et={class:"col-md-3"},tt=["onUpdate:modelValue","onInput","onBlur"],st={key:0,class:"invalid-feedback"},it={class:"col-md-2"},ot=["value"],rt={class:"col-12 text-end"},lt=["onClick"],nt={class:"col-lg-4"},ut={class:"card sticky-top",style:{top:"20px"}},dt={class:"card-body"},at={class:"mb-3"},ct={class:"d-flex justify-content-between mb-2"},pt={class:"fw-medium"},mt={class:"d-flex justify-content-between mb-2"},_t={class:"fw-medium"},vt={class:"d-flex justify-content-between mb-2"},bt={class:"d-flex justify-content-between mb-2"},ft={class:"d-flex justify-content-between"},yt={class:"fw-bold text-success fs-5"},ht={class:"d-grid gap-2"},kt=["disabled"],gt={key:0,class:"spinner-border spinner-border-sm me-2"},Nt={key:1,class:"bi bi-check-circle me-1"},wt=ie({__name:"Edit",props:{deliveryNote:{},suppliers:{},products:{},purchaseOrders:{}},setup(N){const p=N,{success:D,error:R}=ae(),b=$(""),h=$(!1),g=$(null),Q=s=>{if(!s)return"";const e=new Date(s);return isNaN(e.getTime())?"":e.toISOString().split("T")[0]},o=oe({supplier_id:p.deliveryNote.supplier_id,purchase_order_id:p.deliveryNote.purchase_order_id,delivery_date:Q(p.deliveryNote.delivery_date),status:p.deliveryNote.status,notes:p.deliveryNote.notes||"",invoice_number:p.deliveryNote.invoice_number||"",tax_amount:Number(p.deliveryNote.tax_amount)||0,discount_amount:Number(p.deliveryNote.discount_amount)||0,subtotal:Number(p.deliveryNote.subtotal)||0,total_amount:Number(p.deliveryNote.total_amount)||0,items:(p.deliveryNote.items||[]).map(s=>({id:s.id,product_id:s.product_id,quantity:Number(s.quantity)||1,unit_price:Number(s.unit_price)||0,total_price:Number(s.quantity||1)*Number(s.unit_price||0)}))}),S=U(()=>{if(!o.supplier_id)return[];let s=p.purchaseOrders.filter(e=>e.supplier_id===Number(o.supplier_id));if(b.value){const e=b.value.toLowerCase();s=s.filter(i=>i.po_number.toLowerCase().includes(e))}return s}),X=()=>{h.value=!0},G=s=>{g.value=s,o.purchase_order_id=s.id,b.value=s.po_number,h.value=!1},H=()=>{o.purchase_order_id="",o.items=[],b.value="",g.value=null,h.value=!1};B(()=>o.supplier_id,()=>{o.supplier_id&&(o.purchase_order_id="",o.items=[],b.value="",g.value=null,h.value=!1)});const J=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},K=s=>{o.items.splice(s,1),w()},j=s=>{const e=o.items[s];if(!e)return;const i=Number(e.quantity)||0,r=Number(e.unit_price)||0;e.total_price=i*r,w()},w=()=>{const s=o.items.reduce((e,i)=>{const r=Number(i.total_price)||0;return e+r},0);o.subtotal=s,x()},x=()=>{const s=Number(o.subtotal)||0,e=Number(o.tax_amount)||0,i=Number(o.discount_amount)||0;o.total_amount=s+e-i},z=U(()=>o.items.reduce((s,e)=>{const i=Number(e.total_price)||0;return s+i},0)),W=U(()=>{const s=z.value,e=Number(o.tax_amount)||0,i=Number(o.discount_amount)||0;return s+e-i}),I=s=>new Intl.NumberFormat("fr-FR").format(s)+" Fcfa",a=$({}),Y=(s,e)=>!s||s===0?!1:o.items.some((i,r)=>r!==e&&i.product_id===s),V=s=>{const e=o.items[s];return!e.product_id||e.product_id===0?!1:Y(e.product_id,s)},Z=s=>o.items.map((e,i)=>i!==s?e.product_id:null).filter(e=>e!==null&&e>0),ee=(s,e)=>{const i=o.items[e];i.product_id=s.id;const r=p.products.find(u=>u.id===s.id);if(r){const u=r.cost_price!=null&&r.cost_price>0?r.cost_price:null,E=r.price!=null&&r.price>0?r.price:null;i.unit_price=u??E??0}else{const u=s.cost_price!=null&&s.cost_price>0?s.cost_price:null,E=s.price!=null&&s.price>0?s.price:null;i.unit_price=u??E??0}j(e),q(e,"product_id",i.product_id)},te=()=>{const s={};return o.supplier_id||(s.supplier_id="Le fournisseur est requis"),o.purchase_order_id||(s.purchase_order_id="Le bon de commande est requis"),o.delivery_date||(s.delivery_date="La date de livraison est requise"),o.items.length===0&&(s.items="Au moins un article est requis"),o.items.forEach((e,i)=>{!e.product_id||e.product_id===0?s[`items.${i}.product_id`]="Le produit est requis":V(i)&&(s[`items.${i}.product_id`]="Ce produit est déjà sélectionné"),(!e.quantity||e.quantity<1)&&(s[`items.${i}.quantity`]="La quantité doit être supérieure à 0"),(!e.unit_price||e.unit_price<0)&&(s[`items.${i}.unit_price`]="Le prix unitaire est requis et doit être positif")}),Object.keys(s).length>0?s:null},q=(s,e,i)=>{const r=`items.${s}.${e}`;a.value[r]&&delete a.value[r];let u="";switch(e){case"product_id":!i||i===0?u="Le produit est requis":V(s)&&(u="Ce produit est déjà sélectionné");break;case"quantity":(!i||i<1)&&(u="La quantité doit être supérieure à 0");break;case"unit_price":(!i||i<0)&&(u="Le prix unitaire est requis et doit être positif");break}u&&(a.value[r]=u)},se=()=>{a.value={};const s=te();if(s){a.value=s;return}o.items.forEach((e,i)=>{const r=Number(e.quantity)||0,u=Number(e.unit_price)||0;e.total_price=r*u}),w(),o.put(A("delivery-notes.update",{id:p.deliveryNote.id}),{onSuccess:()=>{D("Bon de livraison modifié avec succès !"),a.value={}},onError:()=>{R("Erreur lors de la modification du bon de livraison.")}})};B(()=>o.items.map(s=>({quantity:s.quantity,unit_price:s.unit_price,total_price:s.total_price})),()=>{o.items.forEach((s,e)=>{const i=Number(s.quantity)||0,r=Number(s.unit_price)||0;s.total_price=i*r}),w()},{deep:!0}),B([()=>o.tax_amount,()=>o.discount_amount],()=>{x()});const{errors:_,processing:L}=o;re(()=>{const s=p.purchaseOrders.find(e=>e.id===p.deliveryNote.purchase_order_id);s&&(g.value=s,b.value=s.po_number),o.items.length>0&&w(),document.addEventListener("click",M)}),le(()=>{document.removeEventListener("click",M)});const M=s=>{s.target.closest(".position-relative")||(h.value=!1)};return(s,e)=>(n(),ne(de,null,{default:C(()=>[t("div",me,[t("div",null,[e[8]||(e[8]=t("h1",{class:"h2 mb-1"},"Modifier le bon de livraison",-1)),t("p",_e,c(N.deliveryNote.delivery_number),1)]),t("div",ve,[P(l(F),{href:l(A)("delivery-notes.show",{id:N.deliveryNote.id}),class:"btn btn-outline-primary"},{default:C(()=>[...e[9]||(e[9]=[t("i",{class:"bi bi-eye me-1"},null,-1),v(" Voir le bon de livraison ",-1)])]),_:1},8,["href"]),P(l(F),{href:l(A)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:C(()=>[...e[10]||(e[10]=[t("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])])]),t("form",null,[t("div",be,[t("div",fe,[t("div",ye,[e[20]||(e[20]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Informations générales")],-1)),t("div",he,[t("div",ke,[t("div",ge,[e[12]||(e[12]=t("label",{class:"form-label"},[v(" Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),f(t("select",{"onUpdate:modelValue":e[0]||(e[0]=i=>l(o).supplier_id=i),required:"",class:k(["form-select",{"is-invalid":l(_).supplier_id||a.value.supplier_id}]),onChange:H},[e[11]||(e[11]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(n(!0),d(O,null,T(N.suppliers,i=>(n(),d("option",{key:i.id,value:i.id},c(i.name),9,Ne))),128))],34),[[ue,l(o).supplier_id]]),l(_).supplier_id?(n(),d("div",we,c(l(_).supplier_id),1)):m("",!0),a.value.supplier_id?(n(),d("div",qe,c(a.value.supplier_id),1)):m("",!0)]),t("div",xe,[e[16]||(e[16]=t("label",{class:"form-label"},[v(" Bon de commande "),t("span",{class:"text-danger"},"*")],-1)),t("div",Ve,[f(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=i=>b.value=i),onInput:X,onFocus:e[2]||(e[2]=i=>h.value=!0),placeholder:"Rechercher un bon de commande...",class:k(["form-control",{"is-invalid":l(_).purchase_order_id||a.value.purchase_order_id}])},null,34),[[y,b.value]]),h.value&&S.value.length>0?(n(),d("div",$e,[(n(!0),d(O,null,T(S.value,i=>(n(),d("a",{key:i.id,onClick:r=>G(i),class:"dropdown-item"},c(i.po_number),9,Ce))),128))])):m("",!0),b.value&&S.value.length===0&&p.purchaseOrders.length>0?(n(),d("div",Pe,[...e[13]||(e[13]=[t("div",{class:"dropdown-item text-muted"}," Aucun bon de commande trouvé ",-1)])])):m("",!0),b.value&&!l(o).supplier_id?(n(),d("div",Ae,[...e[14]||(e[14]=[t("div",{class:"dropdown-item text-muted"}," Veuillez d'abord sélectionner un fournisseur ",-1)])])):m("",!0)]),l(_).purchase_order_id||a.value.purchase_order_id?(n(),d("div",Se,[l(_).purchase_order_id?(n(),d("div",je,c(l(_).purchase_order_id),1)):m("",!0),a.value.purchase_order_id?(n(),d("div",Ie,c(a.value.purchase_order_id),1)):m("",!0)])):m("",!0),g.value?(n(),d("div",Le,[t("span",Ee,[e[15]||(e[15]=t("i",{class:"bi bi-check-circle me-1"},null,-1)),v(" "+c(g.value.po_number),1)])])):m("",!0)]),t("div",Ue,[e[17]||(e[17]=t("label",{class:"form-label"},[v(" Date de livraison "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>l(o).delivery_date=i),type:"date",required:"",class:k(["form-control",{"is-invalid":l(_).delivery_date||a.value.delivery_date}])},null,2),[[y,l(o).delivery_date]]),l(_).delivery_date?(n(),d("div",Be,c(l(_).delivery_date),1)):m("",!0),a.value.delivery_date?(n(),d("div",Fe,c(a.value.delivery_date),1)):m("",!0)]),t("div",Oe,[e[18]||(e[18]=t("label",{class:"form-label"},"Numéro de facture fournisseur",-1)),f(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>l(o).invoice_number=i),type:"text",class:k(["form-control",{"is-invalid":l(_).invoice_number}]),placeholder:"EX: FACT-2025-001"},null,2),[[y,l(o).invoice_number]]),l(_).invoice_number?(n(),d("div",Te,c(l(_).invoice_number),1)):m("",!0)]),t("div",ze,[e[19]||(e[19]=t("label",{class:"form-label"},"Notes",-1)),f(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=i=>l(o).notes=i),rows:"3",class:k(["form-control",{"is-invalid":l(_).notes}]),placeholder:"Ajoutez des notes sur cette livraison..."},null,2),[[y,l(o).notes]]),l(_).notes?(n(),d("div",Me,c(l(_).notes),1)):m("",!0)])])])]),t("div",De,[t("div",{class:"card-header d-flex justify-content-between align-items-center"},[e[22]||(e[22]=t("h5",{class:"card-title mb-0"},"Articles livrés",-1)),t("button",{type:"button",onClick:J,class:"btn btn-primary btn-sm"},[...e[21]||(e[21]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])]),t("div",Re,[l(o).items.length===0?(n(),d("div",Qe,[...e[23]||(e[23]=[t("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),t("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(n(),d("div",Xe,[(n(!0),d(O,null,T(l(o).items,(i,r)=>(n(),d("div",{key:r,class:"border rounded p-3 mb-3"},[t("div",Ge,[t("div",He,[e[24]||(e[24]=t("label",{class:"form-label"},[v("Produit "),t("span",{class:"text-danger"},"*")],-1)),P(ce,{modelValue:i.product_id,"onUpdate:modelValue":u=>i.product_id=u,products:N.products,"exclude-product-ids":Z(r),"is-invalid":V(r)||!!a.value[`items.${r}.product_id`],placeholder:"Rechercher un produit...",onSelected:u=>ee(u,r)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),a.value[`items.${r}.product_id`]?(n(),d("div",Je,c(a.value[`items.${r}.product_id`]),1)):m("",!0),V(r)?(n(),d("div",Ke," Ce produit est déjà sélectionné dans ce bon de livraison. ")):m("",!0)]),t("div",We,[e[25]||(e[25]=t("label",{class:"form-label"},[v("Quantité "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":u=>i.quantity=u,type:"number",min:"1",required:"",class:k(["form-control",{"is-invalid":a.value[`items.${r}.quantity`]}]),onInput:u=>{j(r),q(r,"quantity",i.quantity)},onBlur:u=>q(r,"quantity",i.quantity)},null,42,Ye),[[y,i.quantity,void 0,{number:!0}]]),a.value[`items.${r}.quantity`]?(n(),d("div",Ze,c(a.value[`items.${r}.quantity`]),1)):m("",!0)]),t("div",et,[e[26]||(e[26]=t("label",{class:"form-label"},[v("Prix d'achat unitaire "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":u=>i.unit_price=u,type:"number",step:"0.01",min:"0",required:"",class:k(["form-control",{"is-invalid":a.value[`items.${r}.unit_price`]}]),onInput:u=>{j(r),q(r,"unit_price",i.unit_price)},onBlur:u=>q(r,"unit_price",i.unit_price)},null,42,tt),[[y,i.unit_price,void 0,{number:!0}]]),a.value[`items.${r}.unit_price`]?(n(),d("div",st,c(a.value[`items.${r}.unit_price`]),1)):m("",!0)]),t("div",it,[e[27]||(e[27]=t("label",{class:"form-label"},"Total",-1)),t("input",{value:I(i.total_price),type:"text",class:"form-control",readonly:""},null,8,ot)]),t("div",rt,[t("button",{type:"button",onClick:u=>K(r),class:"btn btn-sm btn-outline-danger"},[...e[28]||(e[28]=[t("i",{class:"bi bi-trash me-1"},null,-1),v(" Supprimer ",-1)])],8,lt)])])]))),128))]))])])]),t("div",nt,[t("div",ut,[e[37]||(e[37]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Résumé")],-1)),t("div",dt,[t("div",at,[t("div",ct,[e[29]||(e[29]=t("span",null,"Articles:",-1)),t("span",pt,c(l(o).items.length),1)]),t("div",mt,[e[30]||(e[30]=t("span",null,"Sous-total:",-1)),t("span",_t,c(I(z.value)),1)]),t("div",vt,[e[31]||(e[31]=t("span",null,"Taxes:",-1)),f(t("input",{"onUpdate:modelValue":e[6]||(e[6]=i=>l(o).tax_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[y,l(o).tax_amount,void 0,{number:!0}]])]),t("div",bt,[e[32]||(e[32]=t("span",null,"Remise:",-1)),f(t("input",{"onUpdate:modelValue":e[7]||(e[7]=i=>l(o).discount_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[y,l(o).discount_amount,void 0,{number:!0}]])]),e[34]||(e[34]=t("hr",null,null,-1)),t("div",ft,[e[33]||(e[33]=t("span",{class:"fw-bold"},"Total:",-1)),t("span",yt,c(I(W.value)),1)])]),e[36]||(e[36]=t("div",{class:"alert alert-warning"},[t("i",{class:"bi bi-exclamation-triangle me-1"}),v(" Attention : Modifier ce bon de livraison après validation ne modifiera pas le stock. Seul un nouveau BL peut ajuster le stock. ")],-1)),t("div",ht,[t("button",{type:"button",onClick:se,class:"btn btn-success",disabled:l(L)||l(o).items.length===0},[l(L)?(n(),d("span",gt)):(n(),d("i",Nt)),v(" "+c(l(L)?"Modification...":"Modifier le bon de livraison"),1)],8,kt),P(l(F),{href:l(A)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:C(()=>[...e[35]||(e[35]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),jt=pe(wt,[["__scopeId","data-v-1b866fe6"]]);export{jt as default};
