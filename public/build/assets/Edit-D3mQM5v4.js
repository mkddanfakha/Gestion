import{d as se,r as C,i as ie,y as E,B as F,z as oe,C as ne,c as re,w as V,a as t,t as c,j as O,u as n,l as T,f as _,m as f,b as u,e as p,n as y,o as l,F as j,g as A,p as D,v as h}from"./app-CGqa7dvF.js";import{_ as le}from"./AppLayout.vue_vue_type_script_setup_true_lang-CUowRV7B.js";import{r as S}from"./routes-Ds1K_LXc.js";import{u as ue}from"./useSweetAlert-CjcY7Pj8.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-L_TowVZG.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const ae={class:"d-flex justify-content-between align-items-center mb-4"},ce={class:"text-muted mb-0"},pe={class:"d-flex gap-2"},me={class:"row"},ve={class:"col-lg-8"},_e={class:"card mb-4"},be={class:"card-body"},fe={class:"row g-3"},ye={class:"col-md-6"},he=["value"],ke={key:0,class:"invalid-feedback"},ge={key:1,class:"invalid-feedback"},Ne={class:"col-md-6"},we={class:"position-relative"},qe={key:0,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},xe=["onClick"],$e={key:1,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ce={key:2,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ve={key:0,class:"mt-1"},je={key:0,class:"text-danger small"},Ae={key:1,class:"text-danger small"},Se={key:1,class:"mt-2"},Ie={class:"badge bg-primary"},Le={class:"col-md-6"},Pe={key:0,class:"invalid-feedback"},Be={key:1,class:"invalid-feedback"},Ue={class:"col-md-6"},Ee={key:0,class:"invalid-feedback"},Fe={class:"col-12"},Oe={key:0,class:"invalid-feedback"},Te={class:"card mb-4"},ze={class:"card-body"},Me={key:0,class:"text-center py-4 text-muted"},De={key:1},Re={class:"row g-3"},Qe={class:"col-md-5"},Xe=["onUpdate:modelValue","onChange","onBlur"],Ge=["value","disabled"],He={key:0},Je={key:0,class:"invalid-feedback"},Ke={key:1,class:"invalid-feedback"},We={class:"col-md-2"},Ye=["onUpdate:modelValue","onInput","onBlur"],Ze={key:0,class:"invalid-feedback"},et={class:"col-md-3"},tt=["onUpdate:modelValue","onInput","onBlur"],st={key:0,class:"invalid-feedback"},it={class:"col-md-2"},ot=["value"],nt={class:"col-12 text-end"},rt=["onClick"],lt={class:"col-lg-4"},ut={class:"card sticky-top",style:{top:"20px"}},dt={class:"card-body"},at={class:"mb-3"},ct={class:"d-flex justify-content-between mb-2"},pt={class:"fw-medium"},mt={class:"d-flex justify-content-between mb-2"},vt={class:"fw-medium"},_t={class:"d-flex justify-content-between mb-2"},bt={class:"d-flex justify-content-between mb-2"},ft={class:"d-flex justify-content-between"},yt={class:"fw-bold text-success fs-5"},ht={class:"d-grid gap-2"},kt=["disabled"],gt={key:0,class:"spinner-border spinner-border-sm me-2"},Nt={key:1,class:"bi bi-check-circle me-1"},wt=se({__name:"Edit",props:{deliveryNote:{},suppliers:{},products:{},purchaseOrders:{}},setup(w){const m=w,{success:R,error:Q}=ue(),b=C(""),k=C(!1),g=C(null),X=s=>{if(!s)return"";const e=new Date(s);return isNaN(e.getTime())?"":e.toISOString().split("T")[0]},o=ie({supplier_id:m.deliveryNote.supplier_id,purchase_order_id:m.deliveryNote.purchase_order_id,delivery_date:X(m.deliveryNote.delivery_date),status:m.deliveryNote.status,notes:m.deliveryNote.notes||"",invoice_number:m.deliveryNote.invoice_number||"",tax_amount:Number(m.deliveryNote.tax_amount)||0,discount_amount:Number(m.deliveryNote.discount_amount)||0,subtotal:Number(m.deliveryNote.subtotal)||0,total_amount:Number(m.deliveryNote.total_amount)||0,items:(m.deliveryNote.items||[]).map(s=>({id:s.id,product_id:s.product_id,quantity:Number(s.quantity)||1,unit_price:Number(s.unit_price)||0,total_price:Number(s.quantity||1)*Number(s.unit_price||0)}))}),I=E(()=>{if(!o.supplier_id)return[];let s=m.purchaseOrders.filter(e=>e.supplier_id===Number(o.supplier_id));if(b.value){const e=b.value.toLowerCase();s=s.filter(i=>i.po_number.toLowerCase().includes(e))}return s}),G=()=>{k.value=!0},H=s=>{g.value=s,o.purchase_order_id=s.id,b.value=s.po_number,k.value=!1},J=()=>{o.purchase_order_id="",o.items=[],b.value="",g.value=null,k.value=!1};F(()=>o.supplier_id,()=>{o.supplier_id&&(o.purchase_order_id="",o.items=[],b.value="",g.value=null,k.value=!1)});const K=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},W=s=>{o.items.splice(s,1),q()},Y=s=>{const e=o.items[s],i=m.products.find(r=>r.id===e.product_id);i&&(e.unit_price=i.cost_price||i.price,L(s))},L=s=>{const e=o.items[s];if(!e)return;const i=Number(e.quantity)||0,r=Number(e.unit_price)||0;e.total_price=i*r,q()},q=()=>{const s=o.items.reduce((e,i)=>{const r=Number(i.total_price)||0;return e+r},0);o.subtotal=s,x()},x=()=>{const s=Number(o.subtotal)||0,e=Number(o.tax_amount)||0,i=Number(o.discount_amount)||0;o.total_amount=s+e-i},z=E(()=>o.items.reduce((s,e)=>{const i=Number(e.total_price)||0;return s+i},0)),Z=E(()=>{const s=z.value,e=Number(o.tax_amount)||0,i=Number(o.discount_amount)||0;return s+e-i}),P=s=>new Intl.NumberFormat("fr-FR").format(s)+" Fcfa",a=C({}),B=(s,e)=>!s||s===0?!1:o.items.some((i,r)=>r!==e&&i.product_id===s),$=s=>{const e=o.items[s];return!e.product_id||e.product_id===0?!1:B(e.product_id,s)},ee=()=>{const s={};return o.supplier_id||(s.supplier_id="Le fournisseur est requis"),o.purchase_order_id||(s.purchase_order_id="Le bon de commande est requis"),o.delivery_date||(s.delivery_date="La date de livraison est requise"),o.items.length===0&&(s.items="Au moins un article est requis"),o.items.forEach((e,i)=>{!e.product_id||e.product_id===0?s[`items.${i}.product_id`]="Le produit est requis":$(i)&&(s[`items.${i}.product_id`]="Ce produit est déjà sélectionné"),(!e.quantity||e.quantity<1)&&(s[`items.${i}.quantity`]="La quantité doit être supérieure à 0"),(!e.unit_price||e.unit_price<0)&&(s[`items.${i}.unit_price`]="Le prix unitaire est requis et doit être positif")}),Object.keys(s).length>0?s:null},N=(s,e,i)=>{const r=`items.${s}.${e}`;a.value[r]&&delete a.value[r];let d="";switch(e){case"product_id":!i||i===0?d="Le produit est requis":$(s)&&(d="Ce produit est déjà sélectionné");break;case"quantity":(!i||i<1)&&(d="La quantité doit être supérieure à 0");break;case"unit_price":(!i||i<0)&&(d="Le prix unitaire est requis et doit être positif");break}d&&(a.value[r]=d)},te=()=>{a.value={};const s=ee();if(s){a.value=s;return}o.items.forEach((e,i)=>{const r=Number(e.quantity)||0,d=Number(e.unit_price)||0;e.total_price=r*d}),q(),o.put(S("delivery-notes.update",{id:m.deliveryNote.id}),{onSuccess:()=>{R("Bon de livraison modifié avec succès !"),a.value={}},onError:()=>{Q("Erreur lors de la modification du bon de livraison.")}})};F(()=>o.items.map(s=>({quantity:s.quantity,unit_price:s.unit_price,total_price:s.total_price})),()=>{o.items.forEach((s,e)=>{const i=Number(s.quantity)||0,r=Number(s.unit_price)||0;s.total_price=i*r}),q()},{deep:!0}),F([()=>o.tax_amount,()=>o.discount_amount],()=>{x()});const{errors:v,processing:U}=o;oe(()=>{const s=m.purchaseOrders.find(e=>e.id===m.deliveryNote.purchase_order_id);s&&(g.value=s,b.value=s.po_number),o.items.length>0&&q(),document.addEventListener("click",M)}),ne(()=>{document.removeEventListener("click",M)});const M=s=>{s.target.closest(".position-relative")||(k.value=!1)};return(s,e)=>(l(),re(le,null,{default:V(()=>[t("div",ae,[t("div",null,[e[8]||(e[8]=t("h1",{class:"h2 mb-1"},"Modifier le bon de livraison",-1)),t("p",ce,c(w.deliveryNote.delivery_number),1)]),t("div",pe,[O(n(T),{href:n(S)("delivery-notes.show",{id:w.deliveryNote.id}),class:"btn btn-outline-primary"},{default:V(()=>[...e[9]||(e[9]=[t("i",{class:"bi bi-eye me-1"},null,-1),_(" Voir le bon de livraison ",-1)])]),_:1},8,["href"]),O(n(T),{href:n(S)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:V(()=>[...e[10]||(e[10]=[t("i",{class:"bi bi-arrow-left me-1"},null,-1),_(" Retour à la liste ",-1)])]),_:1},8,["href"])])]),t("form",null,[t("div",me,[t("div",ve,[t("div",_e,[e[20]||(e[20]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Informations générales")],-1)),t("div",be,[t("div",fe,[t("div",ye,[e[12]||(e[12]=t("label",{class:"form-label"},[_(" Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),f(t("select",{"onUpdate:modelValue":e[0]||(e[0]=i=>n(o).supplier_id=i),required:"",class:y(["form-select",{"is-invalid":n(v).supplier_id||a.value.supplier_id}]),onChange:J},[e[11]||(e[11]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(l(!0),u(j,null,A(w.suppliers,i=>(l(),u("option",{key:i.id,value:i.id},c(i.name),9,he))),128))],34),[[D,n(o).supplier_id]]),n(v).supplier_id?(l(),u("div",ke,c(n(v).supplier_id),1)):p("",!0),a.value.supplier_id?(l(),u("div",ge,c(a.value.supplier_id),1)):p("",!0)]),t("div",Ne,[e[16]||(e[16]=t("label",{class:"form-label"},[_(" Bon de commande "),t("span",{class:"text-danger"},"*")],-1)),t("div",we,[f(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=i=>b.value=i),onInput:G,onFocus:e[2]||(e[2]=i=>k.value=!0),placeholder:"Rechercher un bon de commande...",class:y(["form-control",{"is-invalid":n(v).purchase_order_id||a.value.purchase_order_id}])},null,34),[[h,b.value]]),k.value&&I.value.length>0?(l(),u("div",qe,[(l(!0),u(j,null,A(I.value,i=>(l(),u("a",{key:i.id,onClick:r=>H(i),class:"dropdown-item"},c(i.po_number),9,xe))),128))])):p("",!0),b.value&&I.value.length===0&&m.purchaseOrders.length>0?(l(),u("div",$e,[...e[13]||(e[13]=[t("div",{class:"dropdown-item text-muted"}," Aucun bon de commande trouvé ",-1)])])):p("",!0),b.value&&!n(o).supplier_id?(l(),u("div",Ce,[...e[14]||(e[14]=[t("div",{class:"dropdown-item text-muted"}," Veuillez d'abord sélectionner un fournisseur ",-1)])])):p("",!0)]),n(v).purchase_order_id||a.value.purchase_order_id?(l(),u("div",Ve,[n(v).purchase_order_id?(l(),u("div",je,c(n(v).purchase_order_id),1)):p("",!0),a.value.purchase_order_id?(l(),u("div",Ae,c(a.value.purchase_order_id),1)):p("",!0)])):p("",!0),g.value?(l(),u("div",Se,[t("span",Ie,[e[15]||(e[15]=t("i",{class:"bi bi-check-circle me-1"},null,-1)),_(" "+c(g.value.po_number),1)])])):p("",!0)]),t("div",Le,[e[17]||(e[17]=t("label",{class:"form-label"},[_(" Date de livraison "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>n(o).delivery_date=i),type:"date",required:"",class:y(["form-control",{"is-invalid":n(v).delivery_date||a.value.delivery_date}])},null,2),[[h,n(o).delivery_date]]),n(v).delivery_date?(l(),u("div",Pe,c(n(v).delivery_date),1)):p("",!0),a.value.delivery_date?(l(),u("div",Be,c(a.value.delivery_date),1)):p("",!0)]),t("div",Ue,[e[18]||(e[18]=t("label",{class:"form-label"},"Numéro de facture fournisseur",-1)),f(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>n(o).invoice_number=i),type:"text",class:y(["form-control",{"is-invalid":n(v).invoice_number}]),placeholder:"EX: FACT-2025-001"},null,2),[[h,n(o).invoice_number]]),n(v).invoice_number?(l(),u("div",Ee,c(n(v).invoice_number),1)):p("",!0)]),t("div",Fe,[e[19]||(e[19]=t("label",{class:"form-label"},"Notes",-1)),f(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=i=>n(o).notes=i),rows:"3",class:y(["form-control",{"is-invalid":n(v).notes}]),placeholder:"Ajoutez des notes sur cette livraison..."},null,2),[[h,n(o).notes]]),n(v).notes?(l(),u("div",Oe,c(n(v).notes),1)):p("",!0)])])])]),t("div",Te,[t("div",{class:"card-header d-flex justify-content-between align-items-center"},[e[22]||(e[22]=t("h5",{class:"card-title mb-0"},"Articles livrés",-1)),t("button",{type:"button",onClick:K,class:"btn btn-primary btn-sm"},[...e[21]||(e[21]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),_(" Ajouter un article ",-1)])])]),t("div",ze,[n(o).items.length===0?(l(),u("div",Me,[...e[23]||(e[23]=[t("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),t("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),u("div",De,[(l(!0),u(j,null,A(n(o).items,(i,r)=>(l(),u("div",{key:r,class:"border rounded p-3 mb-3"},[t("div",Re,[t("div",Qe,[e[25]||(e[25]=t("label",{class:"form-label"},[_("Produit "),t("span",{class:"text-danger"},"*")],-1)),f(t("select",{"onUpdate:modelValue":d=>i.product_id=d,required:"",class:y(["form-select",{"is-invalid":a.value[`items.${r}.product_id`]||$(r)}]),onChange:d=>{Y(r),N(r,"product_id",i.product_id)},onBlur:d=>N(r,"product_id",i.product_id)},[e[24]||(e[24]=t("option",{value:"0"},"Sélectionner un produit",-1)),(l(!0),u(j,null,A(w.products,d=>(l(),u("option",{key:d.id,value:d.id,disabled:B(d.id,r)},[_(c(d.name)+" ",1),B(d.id,r)?(l(),u("span",He," - Déjà sélectionné")):p("",!0)],8,Ge))),128))],42,Xe),[[D,i.product_id]]),$(r)?(l(),u("div",Je," Ce produit est déjà sélectionné dans ce bon de livraison. ")):p("",!0),a.value[`items.${r}.product_id`]?(l(),u("div",Ke,c(a.value[`items.${r}.product_id`]),1)):p("",!0)]),t("div",We,[e[26]||(e[26]=t("label",{class:"form-label"},[_("Quantité "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":d=>i.quantity=d,type:"number",min:"1",required:"",class:y(["form-control",{"is-invalid":a.value[`items.${r}.quantity`]}]),onInput:d=>{L(r),N(r,"quantity",i.quantity)},onBlur:d=>N(r,"quantity",i.quantity)},null,42,Ye),[[h,i.quantity,void 0,{number:!0}]]),a.value[`items.${r}.quantity`]?(l(),u("div",Ze,c(a.value[`items.${r}.quantity`]),1)):p("",!0)]),t("div",et,[e[27]||(e[27]=t("label",{class:"form-label"},[_("Prix d'achat unitaire "),t("span",{class:"text-danger"},"*")],-1)),f(t("input",{"onUpdate:modelValue":d=>i.unit_price=d,type:"number",step:"0.01",min:"0",required:"",class:y(["form-control",{"is-invalid":a.value[`items.${r}.unit_price`]}]),onInput:d=>{L(r),N(r,"unit_price",i.unit_price)},onBlur:d=>N(r,"unit_price",i.unit_price)},null,42,tt),[[h,i.unit_price,void 0,{number:!0}]]),a.value[`items.${r}.unit_price`]?(l(),u("div",st,c(a.value[`items.${r}.unit_price`]),1)):p("",!0)]),t("div",it,[e[28]||(e[28]=t("label",{class:"form-label"},"Total",-1)),t("input",{value:P(i.total_price),type:"text",class:"form-control",readonly:""},null,8,ot)]),t("div",nt,[t("button",{type:"button",onClick:d=>W(r),class:"btn btn-sm btn-outline-danger"},[...e[29]||(e[29]=[t("i",{class:"bi bi-trash me-1"},null,-1),_(" Supprimer ",-1)])],8,rt)])])]))),128))]))])])]),t("div",lt,[t("div",ut,[e[38]||(e[38]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Résumé")],-1)),t("div",dt,[t("div",at,[t("div",ct,[e[30]||(e[30]=t("span",null,"Articles:",-1)),t("span",pt,c(n(o).items.length),1)]),t("div",mt,[e[31]||(e[31]=t("span",null,"Sous-total:",-1)),t("span",vt,c(P(z.value)),1)]),t("div",_t,[e[32]||(e[32]=t("span",null,"Taxes:",-1)),f(t("input",{"onUpdate:modelValue":e[6]||(e[6]=i=>n(o).tax_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[h,n(o).tax_amount,void 0,{number:!0}]])]),t("div",bt,[e[33]||(e[33]=t("span",null,"Remise:",-1)),f(t("input",{"onUpdate:modelValue":e[7]||(e[7]=i=>n(o).discount_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[h,n(o).discount_amount,void 0,{number:!0}]])]),e[35]||(e[35]=t("hr",null,null,-1)),t("div",ft,[e[34]||(e[34]=t("span",{class:"fw-bold"},"Total:",-1)),t("span",yt,c(P(Z.value)),1)])]),e[37]||(e[37]=t("div",{class:"alert alert-warning"},[t("i",{class:"bi bi-exclamation-triangle me-1"}),_(" Attention : Modifier ce bon de livraison après validation ne modifiera pas le stock. Seul un nouveau BL peut ajuster le stock. ")],-1)),t("div",ht,[t("button",{type:"button",onClick:te,class:"btn btn-success",disabled:n(U)||n(o).items.length===0},[n(U)?(l(),u("span",gt)):(l(),u("i",Nt)),_(" "+c(n(U)?"Modification...":"Modifier le bon de livraison"),1)],8,kt),O(n(T),{href:n(S)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:V(()=>[...e[36]||(e[36]=[_(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),St=de(wt,[["__scopeId","data-v-0b944407"]]);export{St as default};
