import{d as st,r as ot,i as nt,y as h,c as at,w as C,a as e,j as F,u as a,l as W,f,m as _,b as d,e as c,n as v,o as l,F as M,g as $,t as u,p as D,v as b,s as z}from"./app-oFHxr63-.js";import{_ as it}from"./AppLayout.vue_vue_type_script_setup_true_lang-oJPXENP6.js";import{r as A}from"./routes-D3G7R3Tx.js";import{u as lt}from"./useSweetAlert-CjcY7Pj8.js";import{P as dt}from"./ProductAutocomplete-BvVEAyKR.js";import{_ as ut}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-CedOSUd9.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const rt={class:"d-flex justify-content-between align-items-center mb-4"},mt={class:"row"},ct={class:"col-lg-8"},pt={class:"card mb-4"},_t={class:"card-body"},vt={class:"row g-3"},ft={class:"col-md-6"},bt=["value"],yt={key:0,class:"invalid-feedback"},ht={class:"col-md-6"},kt={key:0,class:"invalid-feedback"},gt={key:1,class:"invalid-feedback"},xt={class:"col-md-6"},wt=["min"],qt={key:0,class:"invalid-feedback"},Vt={class:"mt-3"},St={key:0,class:"invalid-feedback"},Ct={class:"card mb-4"},Ft={class:"card-header d-flex justify-content-between align-items-center"},At={class:"d-flex gap-2"},It={class:"card-body"},Ut={key:0,class:"text-center py-4 text-muted"},Lt={key:1},jt={class:"row g-3"},Et={class:"col-md-4"},Pt={key:0,class:"invalid-feedback d-block"},Wt={class:"col-md-2"},Mt=["onUpdate:modelValue","max","onInput"],$t={key:0,class:"invalid-feedback"},Dt={key:1,class:"form-text text-muted"},zt={class:"col-md-2"},Tt={class:"input-group"},Nt=["onUpdate:modelValue","onInput"],Rt={class:"col-md-2"},Bt={class:"input-group"},Ot=["onUpdate:modelValue"],Qt={class:"col-md-2 d-flex align-items-end"},Gt=["onClick"],Ht={class:"col-lg-4"},Jt={class:"card"},Kt={class:"card-body"},Xt={class:"d-flex justify-content-between mb-2"},Yt={class:"fw-medium"},Zt={class:"mb-3"},te={class:"input-group"},ee={key:0,class:"invalid-feedback"},se={key:1,class:"invalid-feedback"},oe={class:"mb-3"},ne={class:"input-group"},ae={key:0,class:"invalid-feedback"},ie={key:1,class:"invalid-feedback"},le={class:"mb-3"},de={class:"input-group"},ue=["max"],re={key:0,class:"invalid-feedback"},me={key:1,class:"invalid-feedback"},ce={class:"form-text text-muted"},pe={class:"d-flex justify-content-between mb-2"},_e={class:"fw-bold text-success fs-5"},ve={key:0,class:"d-flex justify-content-between mb-2"},fe={class:"fw-medium text-primary"},be={key:1,class:"d-flex justify-content-between mb-3"},ye={class:"fw-bold text-warning fs-5"},he={class:"d-grid gap-2"},ke=["disabled"],ge={key:0,class:"spinner-border spinner-border-sm me-2"},xe={key:1,class:"bi bi-check-circle me-1"},we=st({__name:"Create",props:{customers:{},products:{}},setup(w){const I=w,{success:T,error:q}=lt(),m=ot({}),n=nt({customer_id:"",payment_method:"",notes:"",due_date:"",tax_amount:0,discount_amount:0,down_payment_amount:0,items:[]}),N=()=>{n.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},R=o=>{n.items.splice(o,1)},B=(o,t)=>{const s=n.items[t];s.product_id=o.id,s.unit_price=o.price,V(t)},O=o=>n.items.map((t,s)=>s!==o?t.product_id:null).filter(t=>t!==null&&t>0),V=o=>{const t=n.items[o];t.total_price=t.quantity*t.unit_price},Q=(o,t)=>o?n.items.some((s,i)=>i!==t&&s.product_id===o):!1,U=o=>{const t=n.items[o];return t.product_id?Q(t.product_id,o):!1},G=h(()=>{const o=n.items.map(t=>t.product_id).filter(t=>t>0);return o.length!==new Set(o).size}),H=()=>{const o=new Map;n.items.forEach(t=>{if(t.product_id>0)if(o.has(t.product_id)){const s=o.get(t.product_id);s.quantity+=t.quantity,s.total_price=s.quantity*s.unit_price}else o.set(t.product_id,{...t})}),n.items=Array.from(o.values())},g=o=>{const t=n.items[o];if(!t.product_id||!t.quantity)return!1;const s=x(o);return t.quantity>s},x=o=>{const t=n.items[o];if(!t.product_id)return 0;const s=I.products.find(i=>i.id===t.product_id);return s?s.stock_quantity:0},L=o=>{const t=n.items[o];if(!t.product_id)return"";const s=I.products.find(i=>i.id===t.product_id);return s?s.unit:""},J=o=>x(o),j=o=>{if(!o||o===0||typeof o!="number"||isNaN(o))return"80px";const et=70+o.toFixed(2).length*9;return`${Math.max(70,Math.min(130,et))}px`},k=o=>new Intl.NumberFormat("fr-FR").format(o)+" Fcfa",E=h(()=>n.items.reduce((o,t)=>o+t.total_price,0)),K=h(()=>n.tax_amount||0),X=h(()=>n.discount_amount||0),y=h(()=>E.value+K.value-X.value),Y=h(()=>y.value-(n.down_payment_amount||0)),Z=()=>{const o={};return n.payment_method||(o.payment_method="Le mode de paiement est requis"),n.tax_amount<0&&(o.tax_amount="Le montant de la taxe ne peut pas être négatif"),n.discount_amount<0&&(o.discount_amount="Le montant de la remise ne peut pas être négatif"),n.down_payment_amount<0&&(o.down_payment_amount="L'acompte ne peut pas être négatif"),n.down_payment_amount>y.value&&(o.down_payment_amount="L'acompte ne peut pas dépasser le montant total"),n.items.forEach((t,s)=>{t.product_id||(o[`items.${s}.product_id`]="Le produit est requis"),(!t.quantity||t.quantity<1)&&(o[`items.${s}.quantity`]="La quantité doit être au moins 1"),(!t.unit_price||t.unit_price<0)&&(o[`items.${s}.unit_price`]="Le prix unitaire doit être positif"),g(s)&&(o[`items.${s}.quantity`]="La quantité dépasse le stock disponible")}),Object.keys(o).length===0?null:o},P=(o,t)=>{m.value[o]&&delete m.value[o];let s="";switch(o){case"payment_method":t||(s="Le mode de paiement est requis");break;case"tax_amount":t<0&&(s="Le montant de la taxe ne peut pas être négatif");break;case"discount_amount":t<0&&(s="Le montant de la remise ne peut pas être négatif");break;case"down_payment_amount":t<0?s="L'acompte ne peut pas être négatif":t>y.value&&(s="L'acompte ne peut pas dépasser le montant total");break}s&&(m.value[o]=s)},tt=()=>{m.value={};const o=Z();if(o){m.value=o;return}if(n.items.length===0){q("Veuillez ajouter au moins un article.");return}if(n.items.some((i,p)=>g(p))){q("Veuillez corriger les quantités qui dépassent le stock disponible.");return}const s={customer_id:n.customer_id||null,payment_method:n.payment_method,notes:n.notes||null,tax_amount:n.tax_amount||0,discount_amount:n.discount_amount||0,down_payment_amount:n.down_payment_amount||0,items:n.items.map(i=>({product_id:i.product_id,quantity:i.quantity,unit_price:i.unit_price}))};n.transform(()=>s).post(A("sales.store"),{onSuccess:()=>{T("Vente enregistrée avec succès !"),n.reset(),m.value={}},onError:i=>{console.error("Erreurs de validation:",i),q("Erreur lors de l'enregistrement de la vente.")}})},{errors:r,processing:S}=n;return(o,t)=>(l(),at(it,null,{default:C(()=>[e("div",rt,[t[10]||(t[10]=e("div",null,[e("h1",{class:"h2 mb-1"},"Nouvelle vente"),e("p",{class:"text-muted mb-0"},"Enregistrez une nouvelle vente")],-1)),F(a(W),{href:a(A)("sales.index"),class:"btn btn-outline-secondary"},{default:C(()=>[...t[9]||(t[9]=[e("i",{class:"bi bi-arrow-left me-1"},null,-1),f(" Retour à la liste ",-1)])]),_:1},8,["href"])]),e("form",null,[e("div",mt,[e("div",ct,[e("div",pt,[t[18]||(t[18]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Informations générales")],-1)),e("div",_t,[e("div",vt,[e("div",ft,[t[12]||(t[12]=e("label",{class:"form-label"},"Client",-1)),_(e("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>a(n).customer_id=s),class:v(["form-select",{"is-invalid":a(r).customer_id}])},[t[11]||(t[11]=e("option",{value:""},"Sélectionner un client (optionnel)",-1)),(l(!0),d(M,null,$(w.customers,s=>(l(),d("option",{key:s.id,value:s.id},u(s.name),9,bt))),128))],2),[[D,a(n).customer_id]]),a(r).customer_id?(l(),d("div",yt,u(a(r).customer_id),1)):c("",!0)]),e("div",ht,[t[14]||(t[14]=e("label",{class:"form-label"},[f(" Mode de paiement "),e("span",{class:"text-danger"},"*")],-1)),_(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>a(n).payment_method=s),required:"",class:v(["form-select",{"is-invalid":a(r).payment_method||m.value.payment_method}]),onBlur:t[2]||(t[2]=s=>P("payment_method",a(n).payment_method)),onChange:t[3]||(t[3]=s=>P("payment_method",a(n).payment_method))},[...t[13]||(t[13]=[e("option",{value:""},"Sélectionner un mode de paiement",-1),e("option",{value:"cash"},"Espèces",-1),e("option",{value:"card"},"Carte",-1),e("option",{value:"bank_transfer"},"Virement bancaire",-1),e("option",{value:"check"},"Chèque",-1),e("option",{value:"orange_money"},"Orange Money",-1),e("option",{value:"wave"},"Wave",-1)])],34),[[D,a(n).payment_method]]),a(r).payment_method?(l(),d("div",kt,u(a(r).payment_method),1)):c("",!0),m.value.payment_method?(l(),d("div",gt,u(m.value.payment_method),1)):c("",!0)]),e("div",xt,[t[15]||(t[15]=e("label",{class:"form-label"},"Date d'échéance (optionnel)",-1)),_(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>a(n).due_date=s),type:"date",class:v(["form-control",{"is-invalid":a(r).due_date}]),min:new Date().toISOString().split("T")[0]},null,10,wt),[[b,a(n).due_date]]),a(r).due_date?(l(),d("div",qt,u(a(r).due_date),1)):c("",!0),t[16]||(t[16]=e("small",{class:"form-text text-muted"},"Date limite de paiement",-1))])]),e("div",Vt,[t[17]||(t[17]=e("label",{class:"form-label"},"Notes (optionnel)",-1)),_(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>a(n).notes=s),rows:"3",class:v(["form-control",{"is-invalid":a(r).notes}]),placeholder:"Ajoutez des notes sur cette vente..."},null,2),[[b,a(n).notes]]),a(r).notes?(l(),d("div",St,u(a(r).notes),1)):c("",!0)])])]),e("div",Ct,[e("div",Ft,[t[21]||(t[21]=e("h5",{class:"card-title mb-0"},"Articles",-1)),e("div",At,[G.value?(l(),d("button",{key:0,type:"button",onClick:H,class:"btn btn-warning btn-sm"},[...t[19]||(t[19]=[e("i",{class:"bi bi-arrow-down-up me-1"},null,-1),f(" Fusionner les doublons ",-1)])])):c("",!0),e("button",{type:"button",onClick:N,class:"btn btn-primary btn-sm"},[...t[20]||(t[20]=[e("i",{class:"bi bi-plus-circle me-1"},null,-1),f(" Ajouter un article ",-1)])])])]),e("div",It,[a(n).items.length===0?(l(),d("div",Ut,[...t[22]||(t[22]=[e("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),e("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),d("div",Lt,[(l(!0),d(M,null,$(a(n).items,(s,i)=>(l(),d("div",{key:i,class:"border rounded p-3 mb-3"},[e("div",jt,[e("div",Et,[t[23]||(t[23]=e("label",{class:"form-label"},[f(" Produit "),e("span",{class:"text-danger"},"*")],-1)),F(dt,{modelValue:s.product_id,"onUpdate:modelValue":p=>s.product_id=p,products:w.products,"exclude-product-ids":O(i),"is-invalid":U(i),placeholder:"Rechercher un produit...",onSelected:p=>B(p,i)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),U(i)?(l(),d("div",Pt," Ce produit est déjà sélectionné dans cette vente. ")):c("",!0)]),e("div",Wt,[t[24]||(t[24]=e("label",{class:"form-label"},[f(" Quantité "),e("span",{class:"text-danger"},"*")],-1)),_(e("input",{"onUpdate:modelValue":p=>s.quantity=p,type:"number",min:"1",max:J(i),required:"",class:v(["form-control",{"is-invalid":g(i)}]),onInput:p=>V(i)},null,42,Mt),[[b,s.quantity,void 0,{number:!0}]]),g(i)?(l(),d("div",$t," Stock insuffisant. Disponible: "+u(x(i))+" "+u(L(i)),1)):s.product_id?(l(),d("div",Dt," Stock disponible: "+u(x(i))+" "+u(L(i)),1)):c("",!0)]),e("div",zt,[t[26]||(t[26]=e("label",{class:"form-label"},"Prix unitaire",-1)),e("div",Tt,[_(e("input",{"onUpdate:modelValue":p=>s.unit_price=p,type:"number",step:"0.01",min:"0",class:v(["form-control",{"is-invalid":!1}]),style:z({width:j(s.unit_price)}),onInput:p=>V(i)},null,44,Nt),[[b,s.unit_price,void 0,{number:!0}]]),t[25]||(t[25]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Rt,[t[28]||(t[28]=e("label",{class:"form-label"},"Total",-1)),e("div",Bt,[_(e("input",{"onUpdate:modelValue":p=>s.total_price=p,type:"number",step:"0.01",readonly:"",class:"form-control",style:z({width:j(s.total_price)})},null,12,Ot),[[b,s.total_price,void 0,{number:!0}]]),t[27]||(t[27]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Qt,[e("button",{type:"button",onClick:p=>R(i),class:"btn btn-outline-danger w-100"},[...t[29]||(t[29]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Gt)])])]))),128))]))])])]),e("div",Ht,[e("div",Jt,[t[42]||(t[42]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Résumé de la vente")],-1)),e("div",Kt,[e("div",Xt,[t[30]||(t[30]=e("span",null,"Sous-total:",-1)),e("span",Yt,u(k(E.value)),1)]),e("div",Zt,[t[32]||(t[32]=e("label",{class:"form-label"},"Taxes (Fcfa)",-1)),e("div",te,[_(e("input",{type:"number","onUpdate:modelValue":t[6]||(t[6]=s=>a(n).tax_amount=s),step:"0.01",min:"0",class:v(["form-control",{"is-invalid":a(r).tax_amount||m.value.tax_amount}]),placeholder:"0.00"},null,2),[[b,a(n).tax_amount,void 0,{number:!0}]]),t[31]||(t[31]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(r).tax_amount?(l(),d("div",ee,u(a(r).tax_amount),1)):c("",!0),m.value.tax_amount?(l(),d("div",se,u(m.value.tax_amount),1)):c("",!0)]),e("div",oe,[t[34]||(t[34]=e("label",{class:"form-label"},"Remise (Fcfa)",-1)),e("div",ne,[_(e("input",{type:"number","onUpdate:modelValue":t[7]||(t[7]=s=>a(n).discount_amount=s),step:"0.01",min:"0",class:v(["form-control",{"is-invalid":a(r).discount_amount||m.value.discount_amount}]),placeholder:"0.00"},null,2),[[b,a(n).discount_amount,void 0,{number:!0}]]),t[33]||(t[33]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(r).discount_amount?(l(),d("div",ae,u(a(r).discount_amount),1)):c("",!0),m.value.discount_amount?(l(),d("div",ie,u(m.value.discount_amount),1)):c("",!0)]),e("div",le,[t[36]||(t[36]=e("label",{class:"form-label"},"Acompte (Fcfa)",-1)),e("div",de,[_(e("input",{type:"number","onUpdate:modelValue":t[8]||(t[8]=s=>a(n).down_payment_amount=s),step:"0.01",min:"0",max:y.value,class:v(["form-control",{"is-invalid":a(r).down_payment_amount||m.value.down_payment_amount}]),placeholder:"0.00"},null,10,ue),[[b,a(n).down_payment_amount,void 0,{number:!0}]]),t[35]||(t[35]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(r).down_payment_amount?(l(),d("div",re,u(a(r).down_payment_amount),1)):c("",!0),m.value.down_payment_amount?(l(),d("div",me,u(m.value.down_payment_amount),1)):c("",!0),e("div",ce," Montant maximum: "+u(k(y.value)),1)]),t[41]||(t[41]=e("hr",null,null,-1)),e("div",pe,[t[37]||(t[37]=e("span",{class:"fw-bold"},"Total:",-1)),e("span",_e,u(k(y.value)),1)]),a(n).down_payment_amount>0?(l(),d("div",ve,[t[38]||(t[38]=e("span",null,"Acompte:",-1)),e("span",fe,u(k(a(n).down_payment_amount)),1)])):c("",!0),a(n).down_payment_amount>0?(l(),d("div",be,[t[39]||(t[39]=e("span",{class:"fw-bold"},"Reste à payer:",-1)),e("span",ye,u(k(Y.value)),1)])):c("",!0),e("div",he,[e("button",{type:"button",onClick:tt,class:"btn btn-success",disabled:a(S)||a(n).items.length===0},[a(S)?(l(),d("span",ge)):(l(),d("i",xe)),f(" "+u(a(S)?"Enregistrement...":"Enregistrer la vente"),1)],8,ke),F(a(W),{href:a(A)("sales.index"),class:"btn btn-outline-secondary"},{default:C(()=>[...t[40]||(t[40]=[f(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),Pe=ut(we,[["__scopeId","data-v-26795c85"]]);export{Pe as default};
