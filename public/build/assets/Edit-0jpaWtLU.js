import{d as J,i as K,y as f,c as X,w as k,a as s,j as q,t as c,u as n,l as N,f as v,m as p,b as r,e as _,n as y,o as a,F as A,g as P,p as U,v as b,s as j}from"./app-DG1zKyXK.js";import{_ as Y}from"./AppLayout.vue_vue_type_script_setup_true_lang-BeGZtpnK.js";import{r as w}from"./routes-C8N3XD_S.js";import{u as Z}from"./useSweetAlert-CjcY7Pj8.js";import{P as tt}from"./ProductAutocomplete-DSGgwAoE.js";import{_ as st}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-BOh8Ux6F.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const et={class:"d-flex justify-content-between align-items-center mb-4"},ot={class:"h2 mb-1"},nt={class:"row"},it={class:"col-lg-8"},lt={class:"card mb-4"},at={class:"card-body"},dt={class:"row g-3"},rt={class:"col-md-6"},ut=["value"],ct={key:0,class:"invalid-feedback"},mt={class:"col-md-6"},pt={key:0,class:"invalid-feedback"},_t={class:"col-md-6"},vt={key:0,class:"invalid-feedback"},bt={class:"mt-3"},ft={key:0,class:"invalid-feedback"},yt={class:"card mb-4"},gt={class:"card-header d-flex justify-content-between align-items-center"},xt={class:"d-flex gap-2"},ht={class:"card-body"},kt={key:0,class:"text-center py-4 text-muted"},qt={key:1},wt={class:"row g-3"},Ft={class:"col-md-5"},St={key:0,class:"invalid-feedback d-block"},Vt={class:"col-md-2"},It=["onUpdate:modelValue","onInput"],Ct={class:"col-md-2"},Nt={class:"input-group"},At=["onUpdate:modelValue","onInput"],Pt={class:"col-md-2"},Ut={class:"input-group"},jt=["onUpdate:modelValue"],Wt={class:"col-md-1 d-flex align-items-end"},Dt=["onClick"],Et={class:"col-lg-4"},Mt={class:"card"},Tt={class:"card-body"},zt={class:"d-flex justify-content-between mb-2"},Rt={class:"fw-medium"},Bt={class:"d-flex justify-content-between mb-2"},$t={class:"fw-medium"},Lt={class:"mb-3"},Ot={class:"input-group"},Qt={key:0,class:"invalid-feedback"},Gt={class:"mb-3"},Ht={class:"input-group"},Jt={key:0,class:"invalid-feedback"},Kt={class:"d-flex justify-content-between mb-3"},Xt={class:"fw-bold text-success fs-5"},Yt={class:"d-grid gap-2"},Zt=["disabled"],ts={key:0,class:"spinner-border spinner-border-sm me-2"},ss={key:1,class:"bi bi-check-circle me-1"},es=J({__name:"Edit",props:{quote:{},customers:{},products:{}},setup(g){const m=g,{success:W,error:F}=Z(),i=K({customer_id:m.quote.customer_id||"",status:m.quote.status,notes:m.quote.notes||"",valid_until:m.quote.valid_until?new Date(m.quote.valid_until).toISOString().split("T")[0]:"",tax_amount:parseFloat(String(m.quote.tax_amount))||0,discount_amount:parseFloat(String(m.quote.discount_amount))||0,items:m.quote.quoteItems?m.quote.quoteItems.map(e=>({product_id:e.product_id||0,quantity:parseInt(String(e.quantity))||1,unit_price:parseFloat(String(e.unit_price))||0,total_price:parseFloat(String(e.total_price))||0})):[]}),D=()=>{i.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},E=e=>{i.items.splice(e,1)},x=e=>{const t=i.items[e],o=parseFloat(String(t.quantity))||0,u=parseFloat(String(t.unit_price))||0,d=o*u;t.total_price=isNaN(d)?0:d},M=(e,t)=>e?i.items.some((o,u)=>u!==t&&o.product_id===e):!1,S=e=>{const t=i.items[e];return t.product_id?M(t.product_id,e):!1},T=e=>i.items.map((t,o)=>o!==e?t.product_id:null).filter(t=>t!==null&&t>0),z=(e,t)=>{const o=i.items[t];o.product_id=e.id,o.unit_price=e.price,x(t)},R=f(()=>{const e=i.items.map(t=>t.product_id).filter(t=>t>0);return e.length!==new Set(e).size}),B=()=>{const e=new Map;i.items.forEach(t=>{if(t.product_id>0)if(e.has(t.product_id)){const o=e.get(t.product_id);o.quantity+=t.quantity,o.total_price=o.quantity*o.unit_price}else e.set(t.product_id,{...t})}),i.items=Array.from(e.values())},V=e=>{if(!e||e===0||typeof e!="number"||isNaN(e))return"80px";const H=70+e.toFixed(2).length*9;return`${Math.max(70,Math.min(130,H))}px`},I=e=>{if(e==null)return"0 Fcfa";const t=parseFloat(String(e));return isNaN(t)?"0 Fcfa":new Intl.NumberFormat("fr-FR").format(t)+" Fcfa"},$=f(()=>i.items.length),C=f(()=>{const e=i.items.reduce((t,o)=>{const u=parseFloat(String(o.total_price))||0;return t+u},0);return isNaN(e)?0:e}),L=f(()=>parseFloat(String(i.tax_amount))||0),O=f(()=>parseFloat(String(i.discount_amount))||0),Q=f(()=>C.value+L.value-O.value),G=()=>{if(i.items.length===0){F("Veuillez ajouter au moins un article.");return}const e={customer_id:i.customer_id||null,status:i.status,notes:i.notes||null,valid_until:i.valid_until||null,tax_amount:i.tax_amount||0,discount_amount:i.discount_amount||0,items:i.items.map(t=>({product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))};i.transform(()=>e).put(w("quotes.update",{id:m.quote.id}),{onSuccess:()=>{W("Devis modifié avec succès !")},onError:t=>{console.error("Erreurs de validation:",t),F("Erreur lors de la modification du devis.")}})},{errors:l,processing:h}=i;return(e,t)=>(a(),X(Y,null,{default:k(()=>[s("div",et,[s("div",null,[s("h1",ot,"Modifier le devis "+c(g.quote.quote_number),1),t[6]||(t[6]=s("p",{class:"text-muted mb-0"},"Modifiez les informations du devis",-1))]),q(n(N),{href:n(w)("quotes.index"),class:"btn btn-outline-secondary"},{default:k(()=>[...t[7]||(t[7]=[s("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),s("form",null,[s("div",nt,[s("div",it,[s("div",lt,[t[15]||(t[15]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Informations générales")],-1)),s("div",at,[s("div",dt,[s("div",rt,[t[9]||(t[9]=s("label",{class:"form-label"},"Client",-1)),p(s("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>n(i).customer_id=o),class:y(["form-select",{"is-invalid":n(l).customer_id}])},[t[8]||(t[8]=s("option",{value:""},"Sélectionner un client (optionnel)",-1)),(a(!0),r(A,null,P(g.customers,o=>(a(),r("option",{key:o.id,value:o.id},c(o.name),9,ut))),128))],2),[[U,n(i).customer_id]]),n(l).customer_id?(a(),r("div",ct,c(n(l).customer_id),1)):_("",!0)]),s("div",mt,[t[11]||(t[11]=s("label",{class:"form-label"},"Statut",-1)),p(s("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>n(i).status=o),class:y(["form-select",{"is-invalid":n(l).status}])},[...t[10]||(t[10]=[s("option",{value:"draft"},"Brouillon",-1),s("option",{value:"sent"},"Envoyé",-1),s("option",{value:"accepted"},"Accepté",-1),s("option",{value:"rejected"},"Refusé",-1),s("option",{value:"expired"},"Expiré",-1)])],2),[[U,n(i).status]]),n(l).status?(a(),r("div",pt,c(n(l).status),1)):_("",!0)]),s("div",_t,[t[12]||(t[12]=s("label",{class:"form-label"},"Date de validité (optionnel)",-1)),p(s("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>n(i).valid_until=o),type:"date",class:y(["form-control",{"is-invalid":n(l).valid_until}])},null,2),[[b,n(i).valid_until]]),n(l).valid_until?(a(),r("div",vt,c(n(l).valid_until),1)):_("",!0),t[13]||(t[13]=s("small",{class:"form-text text-muted"},"Date limite de validité du devis",-1))])]),s("div",bt,[t[14]||(t[14]=s("label",{class:"form-label"},"Notes (optionnel)",-1)),p(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=o=>n(i).notes=o),rows:"3",class:y(["form-control",{"is-invalid":n(l).notes}]),placeholder:"Ajoutez des notes sur ce devis..."},null,2),[[b,n(i).notes]]),n(l).notes?(a(),r("div",ft,c(n(l).notes),1)):_("",!0)])])]),s("div",yt,[s("div",gt,[t[18]||(t[18]=s("h5",{class:"card-title mb-0"},"Articles",-1)),s("div",xt,[R.value?(a(),r("button",{key:0,type:"button",onClick:B,class:"btn btn-warning btn-sm"},[...t[16]||(t[16]=[s("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):_("",!0),s("button",{type:"button",onClick:D,class:"btn btn-primary btn-sm"},[...t[17]||(t[17]=[s("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),s("div",ht,[n(i).items.length===0?(a(),r("div",kt,[...t[19]||(t[19]=[s("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),s("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(a(),r("div",qt,[(a(!0),r(A,null,P(n(i).items,(o,u)=>(a(),r("div",{key:u,class:"border rounded p-3 mb-3"},[s("div",wt,[s("div",Ft,[t[20]||(t[20]=s("label",{class:"form-label"},[v(" Produit "),s("span",{class:"text-danger"},"*")],-1)),q(tt,{modelValue:o.product_id,"onUpdate:modelValue":d=>o.product_id=d,products:g.products,"exclude-product-ids":T(u),"is-invalid":S(u),placeholder:"Rechercher un produit...",onSelected:d=>z(d,u)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),S(u)?(a(),r("div",St," Ce produit est déjà sélectionné dans ce devis. ")):_("",!0)]),s("div",Vt,[t[21]||(t[21]=s("label",{class:"form-label"},[v(" Quantité "),s("span",{class:"text-danger"},"*")],-1)),p(s("input",{"onUpdate:modelValue":d=>o.quantity=d,type:"number",min:"1",required:"",class:"form-control",onInput:d=>x(u)},null,40,It),[[b,o.quantity,void 0,{number:!0}]])]),s("div",Ct,[t[23]||(t[23]=s("label",{class:"form-label"},"Prix unitaire",-1)),s("div",Nt,[p(s("input",{"onUpdate:modelValue":d=>o.unit_price=d,type:"number",step:"0.01",min:"0",class:"form-control",style:j({width:V(o.unit_price)}),onInput:d=>x(u)},null,44,At),[[b,o.unit_price,void 0,{number:!0}]]),t[22]||(t[22]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",Pt,[t[25]||(t[25]=s("label",{class:"form-label"},"Total",-1)),s("div",Ut,[p(s("input",{"onUpdate:modelValue":d=>o.total_price=d,type:"number",step:"0.01",readonly:"",class:"form-control",style:j({width:V(o.total_price)})},null,12,jt),[[b,o.total_price,void 0,{number:!0}]]),t[24]||(t[24]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",Wt,[s("button",{type:"button",onClick:d=>E(u),class:"btn btn-outline-danger w-100"},[...t[26]||(t[26]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Dt)])])]))),128))]))])])]),s("div",Et,[s("div",Mt,[t[36]||(t[36]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Résumé du devis")],-1)),s("div",Tt,[s("div",zt,[t[27]||(t[27]=s("span",null,"Nombre d'articles:",-1)),s("span",Rt,c($.value),1)]),s("div",Bt,[t[28]||(t[28]=s("span",null,"Sous-total:",-1)),s("span",$t,c(I(C.value)),1)]),s("div",Lt,[t[30]||(t[30]=s("label",{class:"form-label"},"Taxes (Fcfa)",-1)),s("div",Ot,[p(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=o=>n(i).tax_amount=o),step:"0.01",min:"0",class:y(["form-control",{"is-invalid":n(l).tax_amount}]),placeholder:"0.00"},null,2),[[b,n(i).tax_amount,void 0,{number:!0}]]),t[29]||(t[29]=s("span",{class:"input-group-text"},"Fcfa",-1))]),n(l).tax_amount?(a(),r("div",Qt,c(n(l).tax_amount),1)):_("",!0)]),s("div",Gt,[t[32]||(t[32]=s("label",{class:"form-label"},"Remise (Fcfa)",-1)),s("div",Ht,[p(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=o=>n(i).discount_amount=o),step:"0.01",min:"0",class:y(["form-control",{"is-invalid":n(l).discount_amount}]),placeholder:"0.00"},null,2),[[b,n(i).discount_amount,void 0,{number:!0}]]),t[31]||(t[31]=s("span",{class:"input-group-text"},"Fcfa",-1))]),n(l).discount_amount?(a(),r("div",Jt,c(n(l).discount_amount),1)):_("",!0)]),t[35]||(t[35]=s("hr",null,null,-1)),s("div",Kt,[t[33]||(t[33]=s("span",{class:"fw-bold"},"Total:",-1)),s("span",Xt,c(I(Q.value)),1)]),s("div",Yt,[s("button",{type:"button",onClick:G,class:"btn btn-primary",disabled:n(h)||n(i).items.length===0},[n(h)?(a(),r("span",ts)):(a(),r("i",ss)),v(" "+c(n(h)?"Modification...":"Modifier le devis"),1)],8,Zt),q(n(N),{href:n(w)("quotes.index"),class:"btn btn-outline-secondary"},{default:k(()=>[...t[34]||(t[34]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),_s=st(es,[["__scopeId","data-v-0fdbc997"]]);export{_s as default};
