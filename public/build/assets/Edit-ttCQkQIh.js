import{d as it,r as lt,i as dt,y as k,B as rt,c as ut,w as A,a as e,j as I,t as r,u as a,l as D,f,m as v,b as d,e as _,n as y,o as l,F as $,g as z,p as T,v as g,s as R}from"./app-oFHxr63-.js";import{_ as mt}from"./AppLayout.vue_vue_type_script_setup_true_lang-oJPXENP6.js";import{r as S}from"./routes-D3G7R3Tx.js";import{u as ct}from"./useSweetAlert-CjcY7Pj8.js";import{P as pt}from"./ProductAutocomplete-BvVEAyKR.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-CedOSUd9.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const ft={class:"d-flex justify-content-between align-items-center mb-4"},vt={class:"h2 mb-1"},bt={class:"row"},yt={class:"col-lg-8"},gt={class:"card mb-4"},kt={class:"card-body"},wt={class:"row g-3"},ht={class:"col-md-6"},xt=["value"],St={key:0,class:"invalid-feedback"},qt={class:"col-md-6"},Ft={key:0,class:"invalid-feedback"},Vt={key:1,class:"invalid-feedback"},Ct={class:"col-md-6"},Mt={key:0,class:"invalid-feedback"},Nt={class:"mt-3"},At={key:0,class:"invalid-feedback"},It={class:"card mb-4"},Pt={class:"card-header d-flex justify-content-between align-items-center"},jt={class:"d-flex gap-2"},Ut={class:"card-body"},Et={key:0,class:"text-center py-4 text-muted"},Lt={key:1},Wt={class:"row g-3"},Dt={class:"col-md-4"},$t={key:0,class:"invalid-feedback d-block"},zt={class:"col-md-2"},Tt=["onUpdate:modelValue","max","onInput"],Rt={key:0,class:"invalid-feedback"},Bt={key:1,class:"form-text text-muted"},Ot={class:"col-md-2"},Qt={class:"input-group"},Gt=["onUpdate:modelValue","onInput"],Ht={class:"col-md-2"},Jt={class:"input-group"},Kt=["onUpdate:modelValue"],Xt={class:"col-md-2 d-flex align-items-end"},Yt=["onClick"],Zt={class:"col-lg-4"},te={class:"card"},ee={class:"card-body"},se={class:"d-flex justify-content-between mb-2"},ne={class:"fw-medium"},oe={class:"d-flex justify-content-between mb-2"},ae={class:"fw-medium"},ie={class:"mb-3"},le={class:"input-group"},de={key:0,class:"invalid-feedback"},re={key:1,class:"invalid-feedback"},ue={class:"mb-3"},me={class:"input-group"},ce={key:0,class:"invalid-feedback"},pe={key:1,class:"invalid-feedback"},_e={class:"mb-3"},fe={class:"input-group"},ve=["max"],be={key:0,class:"invalid-feedback"},ye={key:1,class:"invalid-feedback"},ge={class:"form-text text-muted"},ke={class:"d-flex justify-content-between mb-2"},we={class:"fw-bold text-success fs-5"},he={key:0,class:"d-flex justify-content-between mb-2"},xe={class:"fw-medium text-primary"},Se={key:1,class:"d-flex justify-content-between mb-3"},qe={class:"fw-bold text-warning fs-5"},Fe={class:"d-grid gap-2"},Ve=["disabled"],Ce={key:0,class:"spinner-border spinner-border-sm me-2"},Me={key:1,class:"bi bi-check-circle me-1"},Ne=["disabled"],Ae=["disabled"],Ie=it({__name:"Edit",props:{sale:{},customers:{},products:{}},setup(q){const m=q,{success:M,error:w,confirmWithDetails:P}=ct(),c=lt({}),o=dt({customer_id:m.sale.customer_id||"",payment_method:m.sale.payment_method,notes:m.sale.notes||"",due_date:m.sale.due_date?new Date(m.sale.due_date).toISOString().split("T")[0]:"",tax_amount:parseFloat(String(m.sale.tax_amount))||0,discount_amount:parseFloat(String(m.sale.discount_amount))||0,down_payment_amount:parseFloat(String(m.sale.down_payment_amount))||0,payment_status:m.sale.payment_status||"pending",items:m.sale.saleItems?m.sale.saleItems.map(s=>({product_id:s.product_id||0,quantity:parseInt(String(s.quantity))||1,unit_price:parseFloat(String(s.unit_price))||0,total_price:parseFloat(String(s.total_price))||0})):[]}),B=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},O=s=>{o.items.splice(s,1)},Q=(s,t)=>{const n=o.items[t];n.product_id=s.id,n.unit_price=s.price,N(t)},G=s=>o.items.map((t,n)=>n!==s?t.product_id:null).filter(t=>t!==null&&t>0),N=s=>{const t=o.items[s],n=parseFloat(String(t.quantity))||0,i=parseFloat(String(t.unit_price))||0,p=n*i;t.total_price=isNaN(p)?0:p},H=(s,t)=>s?o.items.some((n,i)=>i!==t&&n.product_id===s):!1,j=s=>{const t=o.items[s];return t.product_id?H(t.product_id,s):!1},J=k(()=>{const s=o.items.map(t=>t.product_id).filter(t=>t>0);return s.length!==new Set(s).size}),K=()=>{const s=new Map;o.items.forEach(t=>{if(t.product_id>0)if(s.has(t.product_id)){const n=s.get(t.product_id);n.quantity+=t.quantity,n.total_price=n.quantity*n.unit_price}else s.set(t.product_id,{...t})}),o.items=Array.from(s.values())},F=s=>{const t=o.items[s];if(!t.product_id||!t.quantity)return!1;const n=V(s);return t.quantity>n},V=s=>{const t=o.items[s];if(!t.product_id)return 0;const n=m.products.find(i=>i.id===t.product_id);return n?n.stock_quantity:0},U=s=>{const t=o.items[s];if(!t.product_id)return"";const n=m.products.find(i=>i.id===t.product_id);return n?n.unit:""},X=s=>V(s),E=s=>{if(!s||s===0||typeof s!="number"||isNaN(s))return"80px";const C=70+s.toFixed(2).length*9;return`${Math.max(70,Math.min(130,C))}px`},h=s=>{if(s==null)return"0 Fcfa";const t=parseFloat(String(s));return isNaN(t)?"0 Fcfa":new Intl.NumberFormat("fr-FR").format(t)+" Fcfa"},Y=k(()=>o.items.length),L=k(()=>{const s=o.items.reduce((t,n)=>{const i=parseFloat(String(n.quantity))||0,p=parseFloat(String(n.unit_price))||0,C=i*p;return t+(isNaN(C)?0:C)},0);return isNaN(s)?0:s}),Z=k(()=>{const s=parseFloat(String(o.tax_amount))||0;return isNaN(s)?0:s}),tt=k(()=>{const s=parseFloat(String(o.discount_amount))||0;return isNaN(s)?0:s}),b=k(()=>{const s=L.value,t=Z.value,n=tt.value,i=s+t-n;return isNaN(i)?0:i}),et=k(()=>b.value-(o.down_payment_amount||0));rt([()=>o.down_payment_amount,b],()=>{const s=o.down_payment_amount||0,t=b.value||0;s>=t&&t>0?o.payment_status="paid":s>0&&t-s>0?o.payment_status="partial":s===0&&t>0&&(o.payment_status="pending")});const st=()=>{const s={};return o.payment_method||(s.payment_method="Le mode de paiement est requis"),o.tax_amount<0&&(s.tax_amount="Le montant de la taxe ne peut pas être négatif"),o.discount_amount<0&&(s.discount_amount="Le montant de la remise ne peut pas être négatif"),o.down_payment_amount<0&&(s.down_payment_amount="L'acompte ne peut pas être négatif"),o.down_payment_amount>b.value&&(s.down_payment_amount="L'acompte ne peut pas dépasser le montant total"),o.items.forEach((t,n)=>{t.product_id||(s[`items.${n}.product_id`]="Le produit est requis"),(!t.quantity||t.quantity<1)&&(s[`items.${n}.quantity`]="La quantité doit être au moins 1"),(!t.unit_price||t.unit_price<0)&&(s[`items.${n}.unit_price`]="Le prix unitaire doit être positif"),F(n)&&(s[`items.${n}.quantity`]="La quantité dépasse le stock disponible")}),Object.keys(s).length===0?null:s},W=(s,t)=>{c.value[s]&&delete c.value[s];let n="";switch(s){case"payment_method":t||(n="Le mode de paiement est requis");break;case"tax_amount":t<0&&(n="Le montant de la taxe ne peut pas être négatif");break;case"discount_amount":t<0&&(n="Le montant de la remise ne peut pas être négatif");break;case"down_payment_amount":t<0?n="L'acompte ne peut pas être négatif":t>b.value&&(n="L'acompte ne peut pas dépasser le montant total");break}n&&(c.value[s]=n)},nt=()=>{c.value={};const s=st();if(s){c.value=s;return}if(o.items.length===0){w("Veuillez ajouter au moins un article.");return}if(o.items.some((n,i)=>F(i))){w("Veuillez corriger les quantités qui dépassent le stock disponible.");return}o.put(S("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente modifiée avec succès !"),c.value={}},onError:()=>{w("Erreur lors de la modification de la vente.")}})},ot=async()=>{await P("Êtes-vous sûr de vouloir marquer cette vente comme payée ?","Confirmer le paiement",`Cela va :<br>• Marquer le statut comme "payé"<br>• Définir l'acompte égal au montant total<br>• Mettre le reste à payer à 0`)&&(o.payment_status="paid",o.down_payment_amount=b.value,o.put(S("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente marquée comme payée avec succès !")},onError:()=>{w("Erreur lors de la mise à jour du statut de paiement."),o.payment_status=m.sale.payment_status||"pending",o.down_payment_amount=parseFloat(String(m.sale.down_payment_amount))||0}}))},at=async()=>{await P("Êtes-vous sûr de vouloir marquer cette vente comme non payée ?","Confirmer le non-paiement",`Cela va :<br>• Marquer le statut comme "en attente"<br>• Remettre l'acompte à 0<br>• Le reste à payer sera égal au montant total`)&&(o.payment_status="pending",o.down_payment_amount=0,o.put(S("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente marquée comme non payée avec succès !")},onError:()=>{w("Erreur lors de la mise à jour du statut de paiement."),o.payment_status=m.sale.payment_status||"pending",o.down_payment_amount=parseFloat(String(m.sale.down_payment_amount))||0}}))},{errors:u,processing:x}=o;return(s,t)=>(l(),ut(mt,null,{default:A(()=>[e("div",ft,[e("div",null,[e("h1",vt,"Modifier la vente "+r(q.sale.sale_number),1),t[9]||(t[9]=e("p",{class:"text-muted mb-0"},"Modifiez les informations de la vente",-1))]),I(a(D),{href:a(S)("sales.index"),class:"btn btn-outline-secondary"},{default:A(()=>[...t[10]||(t[10]=[e("i",{class:"bi bi-arrow-left me-1"},null,-1),f(" Retour à la liste ",-1)])]),_:1},8,["href"])]),e("form",null,[e("div",bt,[e("div",yt,[e("div",gt,[t[18]||(t[18]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Informations générales")],-1)),e("div",kt,[e("div",wt,[e("div",ht,[t[12]||(t[12]=e("label",{class:"form-label"},"Client",-1)),v(e("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>a(o).customer_id=n),class:y(["form-select",{"is-invalid":a(u).customer_id}])},[t[11]||(t[11]=e("option",{value:""},"Sélectionner un client (optionnel)",-1)),(l(!0),d($,null,z(q.customers,n=>(l(),d("option",{key:n.id,value:n.id},r(n.name),9,xt))),128))],2),[[T,a(o).customer_id]]),a(u).customer_id?(l(),d("div",St,r(a(u).customer_id),1)):_("",!0)]),e("div",qt,[t[14]||(t[14]=e("label",{class:"form-label"},[f(" Mode de paiement "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{"onUpdate:modelValue":t[1]||(t[1]=n=>a(o).payment_method=n),required:"",class:y(["form-select",{"is-invalid":a(u).payment_method||c.value.payment_method}]),onBlur:t[2]||(t[2]=n=>W("payment_method",a(o).payment_method)),onChange:t[3]||(t[3]=n=>W("payment_method",a(o).payment_method))},[...t[13]||(t[13]=[e("option",{value:""},"Sélectionner un mode de paiement",-1),e("option",{value:"cash"},"Espèces",-1),e("option",{value:"card"},"Carte",-1),e("option",{value:"bank_transfer"},"Virement bancaire",-1),e("option",{value:"check"},"Chèque",-1),e("option",{value:"orange_money"},"Orange Money",-1),e("option",{value:"wave"},"Wave",-1)])],34),[[T,a(o).payment_method]]),a(u).payment_method?(l(),d("div",Ft,r(a(u).payment_method),1)):_("",!0),c.value.payment_method?(l(),d("div",Vt,r(c.value.payment_method),1)):_("",!0)]),e("div",Ct,[t[15]||(t[15]=e("label",{class:"form-label"},"Date d'échéance (optionnel)",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>a(o).due_date=n),type:"date",class:y(["form-control",{"is-invalid":a(u).due_date}])},null,2),[[g,a(o).due_date]]),a(u).due_date?(l(),d("div",Mt,r(a(u).due_date),1)):_("",!0),t[16]||(t[16]=e("small",{class:"form-text text-muted"},"Date limite de paiement",-1))])]),e("div",Nt,[t[17]||(t[17]=e("label",{class:"form-label"},"Notes (optionnel)",-1)),v(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=n=>a(o).notes=n),rows:"3",class:y(["form-control",{"is-invalid":a(u).notes}]),placeholder:"Ajoutez des notes sur cette vente..."},null,2),[[g,a(o).notes]]),a(u).notes?(l(),d("div",At,r(a(u).notes),1)):_("",!0)])])]),e("div",It,[e("div",Pt,[t[21]||(t[21]=e("h5",{class:"card-title mb-0"},"Articles",-1)),e("div",jt,[J.value?(l(),d("button",{key:0,type:"button",onClick:K,class:"btn btn-warning btn-sm"},[...t[19]||(t[19]=[e("i",{class:"bi bi-arrow-down-up me-1"},null,-1),f(" Fusionner les doublons ",-1)])])):_("",!0),e("button",{type:"button",onClick:B,class:"btn btn-primary btn-sm"},[...t[20]||(t[20]=[e("i",{class:"bi bi-plus-circle me-1"},null,-1),f(" Ajouter un article ",-1)])])])]),e("div",Ut,[a(o).items.length===0?(l(),d("div",Et,[...t[22]||(t[22]=[e("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),e("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),d("div",Lt,[(l(!0),d($,null,z(a(o).items,(n,i)=>(l(),d("div",{key:i,class:"border rounded p-3 mb-3"},[e("div",Wt,[e("div",Dt,[t[23]||(t[23]=e("label",{class:"form-label"},[f(" Produit "),e("span",{class:"text-danger"},"*")],-1)),I(pt,{modelValue:n.product_id,"onUpdate:modelValue":p=>n.product_id=p,products:q.products,"exclude-product-ids":G(i),"is-invalid":j(i),placeholder:"Rechercher un produit...",onSelected:p=>Q(p,i)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),j(i)?(l(),d("div",$t," Ce produit est déjà sélectionné dans cette vente. ")):_("",!0)]),e("div",zt,[t[24]||(t[24]=e("label",{class:"form-label"},[f(" Quantité "),e("span",{class:"text-danger"},"*")],-1)),v(e("input",{"onUpdate:modelValue":p=>n.quantity=p,type:"number",min:"1",max:X(i),required:"",class:y(["form-control",{"is-invalid":F(i)}]),onInput:p=>N(i)},null,42,Tt),[[g,n.quantity,void 0,{number:!0}]]),F(i)?(l(),d("div",Rt," Stock insuffisant. Disponible: "+r(V(i))+" "+r(U(i)),1)):n.product_id?(l(),d("div",Bt," Stock disponible: "+r(V(i))+" "+r(U(i)),1)):_("",!0)]),e("div",Ot,[t[26]||(t[26]=e("label",{class:"form-label"},"Prix unitaire",-1)),e("div",Qt,[v(e("input",{"onUpdate:modelValue":p=>n.unit_price=p,type:"number",step:"0.01",min:"0",class:"form-control",style:R({width:E(n.unit_price)}),onInput:p=>N(i)},null,44,Gt),[[g,n.unit_price,void 0,{number:!0}]]),t[25]||(t[25]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Ht,[t[28]||(t[28]=e("label",{class:"form-label"},"Total",-1)),e("div",Jt,[v(e("input",{"onUpdate:modelValue":p=>n.total_price=p,type:"number",step:"0.01",readonly:"",class:"form-control",style:R({width:E(n.total_price)})},null,12,Kt),[[g,n.total_price,void 0,{number:!0}]]),t[27]||(t[27]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Xt,[e("button",{type:"button",onClick:p=>O(i),class:"btn btn-outline-danger w-100"},[...t[29]||(t[29]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Yt)])])]))),128))]))])])]),e("div",Zt,[e("div",te,[t[45]||(t[45]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Résumé de la vente")],-1)),e("div",ee,[e("div",se,[t[30]||(t[30]=e("span",null,"Nombre d'articles:",-1)),e("span",ne,r(Y.value),1)]),e("div",oe,[t[31]||(t[31]=e("span",null,"Sous-total:",-1)),e("span",ae,r(h(L.value)),1)]),e("div",ie,[t[33]||(t[33]=e("label",{class:"form-label"},"Taxes (Fcfa)",-1)),e("div",le,[v(e("input",{type:"number","onUpdate:modelValue":t[6]||(t[6]=n=>a(o).tax_amount=n),step:"0.01",min:"0",class:y(["form-control",{"is-invalid":a(u).tax_amount||c.value.tax_amount}]),placeholder:"0.00"},null,2),[[g,a(o).tax_amount,void 0,{number:!0}]]),t[32]||(t[32]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).tax_amount?(l(),d("div",de,r(a(u).tax_amount),1)):_("",!0),c.value.tax_amount?(l(),d("div",re,r(c.value.tax_amount),1)):_("",!0)]),e("div",ue,[t[35]||(t[35]=e("label",{class:"form-label"},"Remise (Fcfa)",-1)),e("div",me,[v(e("input",{type:"number","onUpdate:modelValue":t[7]||(t[7]=n=>a(o).discount_amount=n),step:"0.01",min:"0",class:y(["form-control",{"is-invalid":a(u).discount_amount||c.value.discount_amount}]),placeholder:"0.00"},null,2),[[g,a(o).discount_amount,void 0,{number:!0}]]),t[34]||(t[34]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).discount_amount?(l(),d("div",ce,r(a(u).discount_amount),1)):_("",!0),c.value.discount_amount?(l(),d("div",pe,r(c.value.discount_amount),1)):_("",!0)]),e("div",_e,[t[37]||(t[37]=e("label",{class:"form-label"},"Acompte (Fcfa)",-1)),e("div",fe,[v(e("input",{type:"number","onUpdate:modelValue":t[8]||(t[8]=n=>a(o).down_payment_amount=n),step:"0.01",min:"0",max:b.value,class:y(["form-control",{"is-invalid":a(u).down_payment_amount||c.value.down_payment_amount}]),placeholder:"0.00"},null,10,ve),[[g,a(o).down_payment_amount,void 0,{number:!0}]]),t[36]||(t[36]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).down_payment_amount?(l(),d("div",be,r(a(u).down_payment_amount),1)):_("",!0),c.value.down_payment_amount?(l(),d("div",ye,r(c.value.down_payment_amount),1)):_("",!0),e("div",ge," Montant maximum: "+r(h(b.value)),1)]),t[44]||(t[44]=e("hr",null,null,-1)),e("div",ke,[t[38]||(t[38]=e("span",{class:"fw-bold"},"Total:",-1)),e("span",we,r(h(b.value)),1)]),a(o).down_payment_amount>0?(l(),d("div",he,[t[39]||(t[39]=e("span",null,"Acompte:",-1)),e("span",xe,r(h(a(o).down_payment_amount)),1)])):_("",!0),a(o).down_payment_amount>0?(l(),d("div",Se,[t[40]||(t[40]=e("span",{class:"fw-bold"},"Reste à payer:",-1)),e("span",qe,r(h(et.value)),1)])):_("",!0),e("div",Fe,[e("button",{type:"button",onClick:nt,class:"btn btn-success",disabled:a(x)||a(o).items.length===0},[a(x)?(l(),d("span",Ce)):(l(),d("i",Me)),f(" "+r(a(x)?"Modification...":"Modifier la vente"),1)],8,Ve),a(o).payment_status!=="paid"?(l(),d("button",{key:0,type:"button",onClick:ot,class:"btn btn-primary",disabled:a(x)},[...t[41]||(t[41]=[e("i",{class:"bi bi-credit-card me-1"},null,-1),f(" Marquer comme payé ",-1)])],8,Ne)):_("",!0),a(o).payment_status==="paid"?(l(),d("button",{key:1,type:"button",onClick:at,class:"btn btn-warning",disabled:a(x)},[...t[42]||(t[42]=[e("i",{class:"bi bi-x-circle me-1"},null,-1),f(" Marquer comme non payé ",-1)])],8,Ae)):_("",!0),I(a(D),{href:a(S)("sales.index"),class:"btn btn-outline-secondary"},{default:A(()=>[...t[43]||(t[43]=[f(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),Be=_t(Ie,[["__scopeId","data-v-87d1f989"]]);export{Be as default};
