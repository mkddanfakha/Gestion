import{d as se,r as $,i as ie,y as j,B as I,z as oe,C as re,D as ne,c as le,w as L,a as t,j as U,u as r,l as D,f as v,m as y,b as a,e as p,n as g,o as u,F as E,g as B,t as c,p as ue,v as h}from"./app-Ctez1HXG.js";import{_ as ae}from"./AppLayout.vue_vue_type_script_setup_true_lang-DkXoEYZQ.js";import{r as F}from"./routes-C8N3XD_S.js";import{u as de}from"./useSweetAlert-CjcY7Pj8.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-ri-ER_V1.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const pe={class:"d-flex justify-content-between align-items-center mb-4"},me={class:"row"},_e={class:"col-lg-8"},ve={class:"card mb-4"},be={class:"card-body"},fe={class:"row g-3"},ye={class:"col-md-6"},he=["value"],ke={key:0,class:"invalid-feedback"},ge={key:1,class:"invalid-feedback"},qe={class:"col-md-6"},we={class:"position-relative"},xe={key:0,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ce=["onClick"],Ne={key:1,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},$e={key:2,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ve={key:0,class:"mt-1"},Pe={key:0,class:"text-danger small"},Ae={key:1,class:"text-danger small"},Oe={key:1,class:"mt-2"},Se={class:"badge bg-primary"},je={class:"col-md-6"},Ie={key:0,class:"invalid-feedback"},Le={key:1,class:"invalid-feedback"},Ue={class:"col-md-6"},Ee={key:0,class:"invalid-feedback"},Be={class:"col-12"},Fe={key:0,class:"invalid-feedback"},Te={class:"card mb-4"},ze={class:"card-body"},De={key:0,class:"text-center py-4 text-muted"},Re={key:1},Me={class:"row g-3"},Qe={class:"col-md-5"},Xe={key:0,class:"invalid-feedback d-block"},Ge={key:1,class:"invalid-feedback d-block"},He={class:"col-md-2"},Je=["onUpdate:modelValue","onInput","onBlur"],Ke={key:0,class:"invalid-feedback"},We={class:"col-md-3"},Ye=["onUpdate:modelValue","onInput","onBlur"],Ze={key:0,class:"invalid-feedback"},et={class:"col-md-2"},tt=["value"],st={class:"col-12 text-end"},it=["onClick"],ot={class:"col-lg-4"},rt={class:"card sticky-top",style:{top:"20px"}},nt={class:"card-body"},lt={class:"mb-3"},ut={class:"d-flex justify-content-between mb-2"},at={class:"fw-medium"},dt={class:"d-flex justify-content-between mb-2"},ct={class:"fw-medium"},pt={class:"d-flex justify-content-between mb-2"},mt={class:"d-flex justify-content-between mb-2"},_t={class:"d-flex justify-content-between"},vt={class:"fw-bold text-success fs-5"},bt={class:"d-grid gap-2"},ft=["disabled"],yt={key:0,class:"spinner-border spinner-border-sm me-2"},ht={key:1,class:"bi bi-check-circle me-1"},kt=se({__name:"Create",props:{suppliers:{},products:{},purchaseOrders:{},purchaseOrder:{}},setup(V){const f=V,{success:R,error:M}=de(),b=$(""),k=$(!1),q=$(null),o=ie({supplier_id:f.purchaseOrder?.supplier_id||"",purchase_order_id:f.purchaseOrder?.id||"",delivery_date:new Date().toISOString().split("T")[0],status:"pending",notes:"",invoice_number:"",tax_amount:0,discount_amount:0,subtotal:0,total_amount:0,items:f.purchaseOrder?.items?.map(s=>({product_id:s.product_id||0,quantity:Number(s.quantity)||1,unit_price:Number(s.unit_price)||0,total_price:Number(s.quantity||1)*Number(s.unit_price||0)}))||[]}),P=j(()=>{if(!o.supplier_id)return[];let s=f.purchaseOrders.filter(e=>e.supplier_id===Number(o.supplier_id));if(b.value){const e=b.value.toLowerCase();s=s.filter(n=>n.po_number.toLowerCase().includes(e))}return s}),Q=()=>{k.value=!0},X=s=>{q.value=s,o.purchase_order_id=s.id,b.value=s.po_number,k.value=!1},G=()=>{o.purchase_order_id="",o.items=[],b.value="",q.value=null,k.value=!1};I(()=>o.supplier_id,()=>{o.supplier_id&&(o.purchase_order_id="",o.items=[],b.value="",q.value=null,k.value=!1)}),I(()=>o.items.map(s=>({quantity:s.quantity,unit_price:s.unit_price,total_price:s.total_price})),()=>{o.items.forEach((s,e)=>{const n=Number(s.quantity)||0,i=Number(s.unit_price)||0;s.total_price=n*i}),w()},{deep:!0}),I([()=>o.tax_amount,()=>o.discount_amount],()=>{x()});const H=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},J=s=>{o.items.splice(s,1),w()},A=s=>{const e=o.items[s];if(!e)return;const n=Number(e.quantity)||0,i=Number(e.unit_price)||0;e.total_price=n*i,w()},w=()=>{const s=o.items.reduce((e,n)=>{const i=Number(n.total_price)||0;return e+i},0);o.subtotal=s,x()},x=()=>{const s=Number(o.subtotal)||0,e=Number(o.tax_amount)||0,n=Number(o.discount_amount)||0;o.total_amount=s+e-n},T=j(()=>o.items.reduce((s,e)=>{const n=Number(e.total_price)||0;return s+n},0)),K=j(()=>{const s=T.value,e=Number(o.tax_amount)||0,n=Number(o.discount_amount)||0;return s+e-n}),O=s=>new Intl.NumberFormat("fr-FR").format(s)+" Fcfa",W=()=>{d.value={};const s=te();if(s){d.value=s;return}o.items.forEach((e,n)=>{const i=Number(e.quantity)||0,l=Number(e.unit_price)||0;e.total_price=i*l}),w(),o.post(F("delivery-notes.store"),{onSuccess:()=>{R("Bon de livraison créé avec succès !"),d.value={}},onError:()=>{M("Erreur lors de la création du bon de livraison.")}})},d=$({}),{errors:m,processing:S}=o,Y=(s,e)=>!s||s===0?!1:o.items.some((n,i)=>i!==e&&n.product_id===s),C=s=>{const e=o.items[s];return!e.product_id||e.product_id===0?!1:Y(e.product_id,s)},Z=s=>o.items.map((e,n)=>n!==s?e.product_id:null).filter(e=>e!==null&&e>0),ee=(s,e)=>{const n=o.items[e];n.product_id=s.id;const i=f.products.find(l=>l.id===s.id);if(i){const l=i.cost_price!=null&&i.cost_price>0?i.cost_price:null,_=i.price!=null&&i.price>0?i.price:null;n.unit_price=l??_??0}else{const l=s.cost_price!=null&&s.cost_price>0?s.cost_price:null,_=s.price!=null&&s.price>0?s.price:null;n.unit_price=l??_??0}A(e)},te=()=>{const s={};return o.supplier_id||(s.supplier_id="Le fournisseur est requis"),o.purchase_order_id||(s.purchase_order_id="Le bon de commande est requis"),o.delivery_date||(s.delivery_date="La date de livraison est requise"),o.items.length===0&&(s.items="Au moins un article est requis"),o.items.forEach((e,n)=>{!e.product_id||e.product_id===0?s[`items.${n}.product_id`]="Le produit est requis":C(n)&&(s[`items.${n}.product_id`]="Ce produit est déjà sélectionné"),(!e.quantity||e.quantity<1)&&(s[`items.${n}.quantity`]="La quantité doit être supérieure à 0"),(!e.unit_price||e.unit_price<0)&&(s[`items.${n}.unit_price`]="Le prix unitaire est requis et doit être positif")}),Object.keys(s).length>0?s:null},N=(s,e,n)=>{const i=`items.${s}.${e}`;d.value[i]&&delete d.value[i];let l="";switch(e){case"product_id":!n||n===0?l="Le produit est requis":C(s)&&(l="Ce produit est déjà sélectionné");break;case"quantity":(!n||n<1)&&(l="La quantité doit être supérieure à 0");break;case"unit_price":(!n||n<0)&&(l="Le prix unitaire est requis et doit être positif");break}l&&(d.value[i]=l)};oe(()=>{f.purchaseOrder&&(q.value=f.purchaseOrder,b.value=f.purchaseOrder.po_number),o.items.length>0&&w(),document.addEventListener("click",z)}),re(()=>{document.removeEventListener("click",z)});const z=s=>{s.target.closest(".position-relative")||(k.value=!1)};return(s,e)=>{const n=ne("ProductAutocomplete");return u(),le(ae,null,{default:L(()=>[t("div",pe,[e[9]||(e[9]=t("div",null,[t("h1",{class:"h2 mb-1"},"Nouveau bon de livraison"),t("p",{class:"text-muted mb-0"},"Enregistrez une nouvelle livraison fournisseur")],-1)),U(r(D),{href:r(F)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:L(()=>[...e[8]||(e[8]=[t("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),t("form",null,[t("div",me,[t("div",_e,[t("div",ve,[e[19]||(e[19]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Informations générales")],-1)),t("div",be,[t("div",fe,[t("div",ye,[e[11]||(e[11]=t("label",{class:"form-label"},[v(" Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),y(t("select",{"onUpdate:modelValue":e[0]||(e[0]=i=>r(o).supplier_id=i),required:"",class:g(["form-select",{"is-invalid":r(m).supplier_id||d.value.supplier_id}]),onChange:G},[e[10]||(e[10]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(u(!0),a(E,null,B(V.suppliers,i=>(u(),a("option",{key:i.id,value:i.id},c(i.name),9,he))),128))],34),[[ue,r(o).supplier_id]]),r(m).supplier_id?(u(),a("div",ke,c(r(m).supplier_id),1)):p("",!0),d.value.supplier_id?(u(),a("div",ge,c(d.value.supplier_id),1)):p("",!0)]),t("div",qe,[e[15]||(e[15]=t("label",{class:"form-label"},[v(" Bon de commande "),t("span",{class:"text-danger"},"*")],-1)),t("div",we,[y(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=i=>b.value=i),onInput:Q,onFocus:e[2]||(e[2]=i=>k.value=!0),placeholder:"Rechercher un bon de commande...",class:g(["form-control",{"is-invalid":r(m).purchase_order_id||d.value.purchase_order_id}])},null,34),[[h,b.value]]),k.value&&P.value.length>0?(u(),a("div",xe,[(u(!0),a(E,null,B(P.value,i=>(u(),a("a",{key:i.id,onClick:l=>X(i),class:"dropdown-item"},c(i.po_number),9,Ce))),128))])):p("",!0),b.value&&P.value.length===0&&f.purchaseOrders.length>0?(u(),a("div",Ne,[...e[12]||(e[12]=[t("div",{class:"dropdown-item text-muted"}," Aucun bon de commande trouvé ",-1)])])):p("",!0),b.value&&!r(o).supplier_id?(u(),a("div",$e,[...e[13]||(e[13]=[t("div",{class:"dropdown-item text-muted"}," Veuillez d'abord sélectionner un fournisseur ",-1)])])):p("",!0)]),r(m).purchase_order_id||d.value.purchase_order_id?(u(),a("div",Ve,[r(m).purchase_order_id?(u(),a("div",Pe,c(r(m).purchase_order_id),1)):p("",!0),d.value.purchase_order_id?(u(),a("div",Ae,c(d.value.purchase_order_id),1)):p("",!0)])):p("",!0),q.value?(u(),a("div",Oe,[t("span",Se,[e[14]||(e[14]=t("i",{class:"bi bi-check-circle me-1"},null,-1)),v(" "+c(q.value.po_number),1)])])):p("",!0)]),t("div",je,[e[16]||(e[16]=t("label",{class:"form-label"},[v(" Date de livraison "),t("span",{class:"text-danger"},"*")],-1)),y(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>r(o).delivery_date=i),type:"date",required:"",class:g(["form-control",{"is-invalid":r(m).delivery_date||d.value.delivery_date}])},null,2),[[h,r(o).delivery_date]]),r(m).delivery_date?(u(),a("div",Ie,c(r(m).delivery_date),1)):p("",!0),d.value.delivery_date?(u(),a("div",Le,c(d.value.delivery_date),1)):p("",!0)]),t("div",Ue,[e[17]||(e[17]=t("label",{class:"form-label"},"Numéro de facture fournisseur",-1)),y(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>r(o).invoice_number=i),type:"text",class:g(["form-control",{"is-invalid":r(m).invoice_number}]),placeholder:"EX: FACT-2025-001"},null,2),[[h,r(o).invoice_number]]),r(m).invoice_number?(u(),a("div",Ee,c(r(m).invoice_number),1)):p("",!0)]),t("div",Be,[e[18]||(e[18]=t("label",{class:"form-label"},"Notes",-1)),y(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=i=>r(o).notes=i),rows:"3",class:g(["form-control",{"is-invalid":r(m).notes}]),placeholder:"Ajoutez des notes sur cette livraison..."},null,2),[[h,r(o).notes]]),r(m).notes?(u(),a("div",Fe,c(r(m).notes),1)):p("",!0)])])])]),t("div",Te,[t("div",{class:"card-header d-flex justify-content-between align-items-center"},[e[21]||(e[21]=t("h5",{class:"card-title mb-0"},"Articles livrés",-1)),t("button",{type:"button",onClick:H,class:"btn btn-primary btn-sm"},[...e[20]||(e[20]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])]),t("div",ze,[r(o).items.length===0?(u(),a("div",De,[...e[22]||(e[22]=[t("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),t("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(u(),a("div",Re,[(u(!0),a(E,null,B(r(o).items,(i,l)=>(u(),a("div",{key:l,class:"border rounded p-3 mb-3"},[t("div",Me,[t("div",Qe,[e[23]||(e[23]=t("label",{class:"form-label"},[v("Produit "),t("span",{class:"text-danger"},"*")],-1)),U(n,{modelValue:i.product_id,"onUpdate:modelValue":_=>i.product_id=_,products:V.products,"exclude-product-ids":Z(l),"is-invalid":C(l)||!!d.value[`items.${l}.product_id`],placeholder:"Rechercher un produit...",onSelected:_=>ee(_,l)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),d.value[`items.${l}.product_id`]?(u(),a("div",Xe,c(d.value[`items.${l}.product_id`]),1)):p("",!0),C(l)?(u(),a("div",Ge," Ce produit est déjà sélectionné dans ce bon de livraison. ")):p("",!0)]),t("div",He,[e[24]||(e[24]=t("label",{class:"form-label"},[v("Quantité "),t("span",{class:"text-danger"},"*")],-1)),y(t("input",{"onUpdate:modelValue":_=>i.quantity=_,type:"number",min:"1",required:"",class:g(["form-control",{"is-invalid":d.value[`items.${l}.quantity`]}]),onInput:_=>{A(l),N(l,"quantity",i.quantity)},onBlur:_=>N(l,"quantity",i.quantity)},null,42,Je),[[h,i.quantity,void 0,{number:!0}]]),d.value[`items.${l}.quantity`]?(u(),a("div",Ke,c(d.value[`items.${l}.quantity`]),1)):p("",!0)]),t("div",We,[e[25]||(e[25]=t("label",{class:"form-label"},[v("Prix d'achat unitaire "),t("span",{class:"text-danger"},"*")],-1)),y(t("input",{"onUpdate:modelValue":_=>i.unit_price=_,type:"number",step:"0.01",min:"0",required:"",class:g(["form-control",{"is-invalid":d.value[`items.${l}.unit_price`]}]),onInput:_=>{A(l),N(l,"unit_price",i.unit_price)},onBlur:_=>N(l,"unit_price",i.unit_price)},null,42,Ye),[[h,i.unit_price,void 0,{number:!0}]]),d.value[`items.${l}.unit_price`]?(u(),a("div",Ze,c(d.value[`items.${l}.unit_price`]),1)):p("",!0)]),t("div",et,[e[26]||(e[26]=t("label",{class:"form-label"},"Total",-1)),t("input",{value:O(i.total_price),type:"text",class:"form-control",readonly:""},null,8,tt)]),t("div",st,[t("button",{type:"button",onClick:_=>J(l),class:"btn btn-sm btn-outline-danger"},[...e[27]||(e[27]=[t("i",{class:"bi bi-trash me-1"},null,-1),v(" Supprimer ",-1)])],8,it)])])]))),128))]))])])]),t("div",ot,[t("div",rt,[e[36]||(e[36]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Résumé")],-1)),t("div",nt,[t("div",lt,[t("div",ut,[e[28]||(e[28]=t("span",null,"Articles:",-1)),t("span",at,c(r(o).items.length),1)]),t("div",dt,[e[29]||(e[29]=t("span",null,"Sous-total:",-1)),t("span",ct,c(O(T.value)),1)]),t("div",pt,[e[30]||(e[30]=t("span",null,"Taxes:",-1)),y(t("input",{"onUpdate:modelValue":e[6]||(e[6]=i=>r(o).tax_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[h,r(o).tax_amount,void 0,{number:!0}]])]),t("div",mt,[e[31]||(e[31]=t("span",null,"Remise:",-1)),y(t("input",{"onUpdate:modelValue":e[7]||(e[7]=i=>r(o).discount_amount=i),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:x},null,544),[[h,r(o).discount_amount,void 0,{number:!0}]])]),e[33]||(e[33]=t("hr",null,null,-1)),t("div",_t,[e[32]||(e[32]=t("span",{class:"fw-bold"},"Total:",-1)),t("span",vt,c(O(K.value)),1)])]),e[35]||(e[35]=t("div",{class:"alert alert-info"},[t("i",{class:"bi bi-info-circle me-1"}),v(" Le stock sera ajusté automatiquement après la validation du bon de livraison. ")],-1)),t("div",bt,[t("button",{type:"button",onClick:W,class:"btn btn-success",disabled:r(S)||r(o).items.length===0},[r(S)?(u(),a("span",yt)):(u(),a("i",ht)),v(" "+c(r(S)?"Création...":"Créer le bon de livraison"),1)],8,ft),U(r(D),{href:r(F)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:L(()=>[...e[34]||(e[34]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1})}}}),Vt=ce(kt,[["__scopeId","data-v-ab49ef47"]]);export{Vt as default};
