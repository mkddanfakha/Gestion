import{d as G,i as H,y,D as J,c as K,w as h,a as s,j as k,u as e,l as I,f as v,m as p,b as a,e as _,n as f,o as d,F as U,g as P,t as c,p as j,v as b,s as W}from"./app-eRcTGwFI.js";import{_ as X}from"./AppLayout.vue_vue_type_script_setup_true_lang-zUMOXHOC.js";import{r as w}from"./routes-C8N3XD_S.js";import{u as Y}from"./useSweetAlert-CjcY7Pj8.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-COb8ORXi.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const tt={class:"d-flex justify-content-between align-items-center mb-4"},st={class:"row"},et={class:"col-lg-8"},ot={class:"card mb-4"},nt={class:"card-body"},lt={class:"row g-3"},it={class:"col-md-6"},dt=["value"],at={key:0,class:"invalid-feedback"},rt={class:"col-md-6"},ut={key:0,class:"invalid-feedback"},ct={class:"col-md-6"},mt=["min"],pt={key:0,class:"invalid-feedback"},_t={class:"mt-3"},vt={key:0,class:"invalid-feedback"},bt={class:"card mb-4"},ft={class:"card-header d-flex justify-content-between align-items-center"},yt={class:"d-flex gap-2"},xt={class:"card-body"},gt={key:0,class:"text-center py-4 text-muted"},ht={key:1},kt={class:"row g-3"},wt={class:"col-md-5"},Vt={key:0,class:"invalid-feedback d-block"},Ct={class:"col-md-2"},At=["onUpdate:modelValue","onInput"],Ft={class:"col-md-2"},St={class:"input-group"},qt=["onUpdate:modelValue","onInput"],It={class:"col-md-2"},Ut={class:"input-group"},Pt=["onUpdate:modelValue"],jt={class:"col-md-1 d-flex align-items-end"},Wt=["onClick"],Dt={class:"col-lg-4"},Et={class:"card"},Nt={class:"card-body"},zt={class:"d-flex justify-content-between mb-2"},Tt={class:"fw-medium"},Mt={class:"mb-3"},Rt={class:"input-group"},Bt={key:0,class:"invalid-feedback"},$t={class:"mb-3"},Lt={class:"input-group"},Ot={key:0,class:"invalid-feedback"},Qt={class:"d-flex justify-content-between mb-3"},Gt={class:"fw-bold text-success fs-5"},Ht={class:"d-grid gap-2"},Jt=["disabled"],Kt={key:0,class:"spinner-border spinner-border-sm me-2"},Xt={key:1,class:"bi bi-check-circle me-1"},Yt=G({__name:"Create",props:{customers:{},products:{}},setup(V){const{success:D,error:C}=Y(),o=H({customer_id:"",status:"draft",notes:"",valid_until:"",tax_amount:0,discount_amount:0,items:[]}),E=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},N=n=>{o.items.splice(n,1)},x=n=>{const t=o.items[n];t.total_price=t.quantity*t.unit_price},z=(n,t)=>n?o.items.some((r,l)=>l!==t&&r.product_id===n):!1,A=n=>{const t=o.items[n];return t.product_id?z(t.product_id,n):!1},T=n=>o.items.map((t,r)=>r!==n?t.product_id:null).filter(t=>t!==null&&t>0),M=(n,t)=>{const r=o.items[t];r.product_id=n.id,r.unit_price=n.price,x(t)},R=y(()=>{const n=o.items.map(t=>t.product_id).filter(t=>t>0);return n.length!==new Set(n).size}),B=()=>{const n=new Map;o.items.forEach(t=>{if(t.product_id>0)if(n.has(t.product_id)){const r=n.get(t.product_id);r.quantity+=t.quantity,r.total_price=r.quantity*r.unit_price}else n.set(t.product_id,{...t})}),o.items=Array.from(n.values())},F=n=>{if(!n||n===0||typeof n!="number"||isNaN(n))return"80px";const u=70+n.toFixed(2).length*9;return`${Math.max(70,Math.min(130,u))}px`},S=n=>new Intl.NumberFormat("fr-FR").format(n)+" Fcfa",q=y(()=>o.items.reduce((n,t)=>n+t.total_price,0)),$=y(()=>o.tax_amount||0),L=y(()=>o.discount_amount||0),O=y(()=>q.value+$.value-L.value),Q=()=>{if(o.items.length===0){C("Veuillez ajouter au moins un article.");return}const n={customer_id:o.customer_id||null,status:o.status,notes:o.notes||null,valid_until:o.valid_until||null,tax_amount:o.tax_amount||0,discount_amount:o.discount_amount||0,items:o.items.map(t=>({product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))};o.transform(()=>n).post(w("quotes.store"),{onSuccess:()=>{D("Devis créé avec succès !"),o.reset()},onError:t=>{console.error("Erreurs de validation:",t),C("Erreur lors de la création du devis.")}})},{errors:i,processing:g}=o;return(n,t)=>{const r=J("ProductAutocomplete");return d(),K(X,null,{default:h(()=>[s("div",tt,[t[7]||(t[7]=s("div",null,[s("h1",{class:"h2 mb-1"},"Nouveau devis"),s("p",{class:"text-muted mb-0"},"Créez un nouveau devis")],-1)),k(e(I),{href:e(w)("quotes.index"),class:"btn btn-outline-secondary"},{default:h(()=>[...t[6]||(t[6]=[s("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),s("form",null,[s("div",st,[s("div",et,[s("div",ot,[t[15]||(t[15]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Informations générales")],-1)),s("div",nt,[s("div",lt,[s("div",it,[t[9]||(t[9]=s("label",{class:"form-label"},"Client",-1)),p(s("select",{"onUpdate:modelValue":t[0]||(t[0]=l=>e(o).customer_id=l),class:f(["form-select",{"is-invalid":e(i).customer_id}])},[t[8]||(t[8]=s("option",{value:""},"Sélectionner un client (optionnel)",-1)),(d(!0),a(U,null,P(V.customers,l=>(d(),a("option",{key:l.id,value:l.id},c(l.name),9,dt))),128))],2),[[j,e(o).customer_id]]),e(i).customer_id?(d(),a("div",at,c(e(i).customer_id),1)):_("",!0)]),s("div",rt,[t[11]||(t[11]=s("label",{class:"form-label"},"Statut",-1)),p(s("select",{"onUpdate:modelValue":t[1]||(t[1]=l=>e(o).status=l),class:f(["form-select",{"is-invalid":e(i).status}])},[...t[10]||(t[10]=[s("option",{value:"draft"},"Brouillon",-1),s("option",{value:"sent"},"Envoyé",-1),s("option",{value:"accepted"},"Accepté",-1),s("option",{value:"rejected"},"Refusé",-1),s("option",{value:"expired"},"Expiré",-1)])],2),[[j,e(o).status]]),e(i).status?(d(),a("div",ut,c(e(i).status),1)):_("",!0)]),s("div",ct,[t[12]||(t[12]=s("label",{class:"form-label"},"Date de validité (optionnel)",-1)),p(s("input",{"onUpdate:modelValue":t[2]||(t[2]=l=>e(o).valid_until=l),type:"date",class:f(["form-control",{"is-invalid":e(i).valid_until}]),min:new Date().toISOString().split("T")[0]},null,10,mt),[[b,e(o).valid_until]]),e(i).valid_until?(d(),a("div",pt,c(e(i).valid_until),1)):_("",!0),t[13]||(t[13]=s("small",{class:"form-text text-muted"},"Date limite de validité du devis",-1))])]),s("div",_t,[t[14]||(t[14]=s("label",{class:"form-label"},"Notes (optionnel)",-1)),p(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=l=>e(o).notes=l),rows:"3",class:f(["form-control",{"is-invalid":e(i).notes}]),placeholder:"Ajoutez des notes sur ce devis..."},null,2),[[b,e(o).notes]]),e(i).notes?(d(),a("div",vt,c(e(i).notes),1)):_("",!0)])])]),s("div",bt,[s("div",ft,[t[18]||(t[18]=s("h5",{class:"card-title mb-0"},"Articles",-1)),s("div",yt,[R.value?(d(),a("button",{key:0,type:"button",onClick:B,class:"btn btn-warning btn-sm"},[...t[16]||(t[16]=[s("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):_("",!0),s("button",{type:"button",onClick:E,class:"btn btn-primary btn-sm"},[...t[17]||(t[17]=[s("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),s("div",xt,[e(o).items.length===0?(d(),a("div",gt,[...t[19]||(t[19]=[s("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),s("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(d(),a("div",ht,[(d(!0),a(U,null,P(e(o).items,(l,m)=>(d(),a("div",{key:m,class:"border rounded p-3 mb-3"},[s("div",kt,[s("div",wt,[t[20]||(t[20]=s("label",{class:"form-label"},[v(" Produit "),s("span",{class:"text-danger"},"*")],-1)),k(r,{modelValue:l.product_id,"onUpdate:modelValue":u=>l.product_id=u,products:V.products,"exclude-product-ids":T(m),"is-invalid":A(m),placeholder:"Rechercher un produit...",onSelected:u=>M(u,m)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),A(m)?(d(),a("div",Vt," Ce produit est déjà sélectionné dans ce devis. ")):_("",!0)]),s("div",Ct,[t[21]||(t[21]=s("label",{class:"form-label"},[v(" Quantité "),s("span",{class:"text-danger"},"*")],-1)),p(s("input",{"onUpdate:modelValue":u=>l.quantity=u,type:"number",min:"1",required:"",class:"form-control",onInput:u=>x(m)},null,40,At),[[b,l.quantity,void 0,{number:!0}]])]),s("div",Ft,[t[23]||(t[23]=s("label",{class:"form-label"},"Prix unitaire",-1)),s("div",St,[p(s("input",{"onUpdate:modelValue":u=>l.unit_price=u,type:"number",step:"0.01",min:"0",class:"form-control",style:W({width:F(l.unit_price)}),onInput:u=>x(m)},null,44,qt),[[b,l.unit_price,void 0,{number:!0}]]),t[22]||(t[22]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",It,[t[25]||(t[25]=s("label",{class:"form-label"},"Total",-1)),s("div",Ut,[p(s("input",{"onUpdate:modelValue":u=>l.total_price=u,type:"number",step:"0.01",readonly:"",class:"form-control",style:W({width:F(l.total_price)})},null,12,Pt),[[b,l.total_price,void 0,{number:!0}]]),t[24]||(t[24]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",jt,[s("button",{type:"button",onClick:u=>N(m),class:"btn btn-outline-danger w-100"},[...t[26]||(t[26]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Wt)])])]))),128))]))])])]),s("div",Dt,[s("div",Et,[t[35]||(t[35]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Résumé du devis")],-1)),s("div",Nt,[s("div",zt,[t[27]||(t[27]=s("span",null,"Sous-total:",-1)),s("span",Tt,c(S(q.value)),1)]),s("div",Mt,[t[29]||(t[29]=s("label",{class:"form-label"},"Taxes (Fcfa)",-1)),s("div",Rt,[p(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=l=>e(o).tax_amount=l),step:"0.01",min:"0",class:f(["form-control",{"is-invalid":e(i).tax_amount}]),placeholder:"0.00"},null,2),[[b,e(o).tax_amount,void 0,{number:!0}]]),t[28]||(t[28]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(i).tax_amount?(d(),a("div",Bt,c(e(i).tax_amount),1)):_("",!0)]),s("div",$t,[t[31]||(t[31]=s("label",{class:"form-label"},"Remise (Fcfa)",-1)),s("div",Lt,[p(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=l=>e(o).discount_amount=l),step:"0.01",min:"0",class:f(["form-control",{"is-invalid":e(i).discount_amount}]),placeholder:"0.00"},null,2),[[b,e(o).discount_amount,void 0,{number:!0}]]),t[30]||(t[30]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(i).discount_amount?(d(),a("div",Ot,c(e(i).discount_amount),1)):_("",!0)]),t[34]||(t[34]=s("hr",null,null,-1)),s("div",Qt,[t[32]||(t[32]=s("span",{class:"fw-bold"},"Total:",-1)),s("span",Gt,c(S(O.value)),1)]),s("div",Ht,[s("button",{type:"button",onClick:Q,class:"btn btn-primary",disabled:e(g)||e(o).items.length===0},[e(g)?(d(),a("span",Kt)):(d(),a("i",Xt)),v(" "+c(e(g)?"Enregistrement...":"Enregistrer le devis"),1)],8,Jt),k(e(I),{href:e(w)("quotes.index"),class:"btn btn-outline-secondary"},{default:h(()=>[...t[33]||(t[33]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1})}}}),rs=Z(Yt,[["__scopeId","data-v-6d54956f"]]);export{rs as default};
