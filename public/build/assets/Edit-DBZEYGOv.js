import{d as nt,r as ot,i as at,y as g,B as it,c as lt,w as I,a as e,j as A,t as r,u as a,l as D,f,b as d,e as _,o as l,m as v,n as k,p as dt,v as y,F as rt,g as ut,s as $}from"./app--1_n6QmE.js";import{_ as mt}from"./AppLayout.vue_vue_type_script_setup_true_lang-DiNSmrMh.js";import{r as q}from"./routes-BdA70M5q.js";import{u as ct}from"./useSweetAlert-CjcY7Pj8.js";import{C as pt,P as _t}from"./CustomerAutocomplete-CrP7dFYW.js";import{_ as ft}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-DS_PED8n.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const bt={class:"d-flex justify-content-between align-items-center mb-4"},vt={class:"h2 mb-1"},yt={class:"row"},gt={class:"col-lg-8"},kt={class:"card mb-4"},ht={class:"card-body"},wt={class:"row g-3"},xt={class:"col-md-6"},qt={key:0,class:"invalid-feedback d-block"},St={class:"col-md-6"},Ft={key:0,class:"invalid-feedback"},Vt={key:1,class:"invalid-feedback"},Ct={class:"col-md-6"},At={key:0,class:"invalid-feedback"},Mt={class:"mt-3"},Nt={key:0,class:"invalid-feedback"},It={class:"card mb-4"},Pt={class:"card-header d-flex justify-content-between align-items-center"},jt={class:"d-flex gap-2"},Ut={class:"card-body"},Et={key:0,class:"text-center py-4 text-muted"},Lt={key:1},Wt={class:"row g-3"},Dt={class:"col-md-4"},$t={key:0,class:"invalid-feedback d-block"},zt={class:"col-md-2"},Rt=["onUpdate:modelValue","max","onInput"],Tt={key:0,class:"invalid-feedback"},Bt={key:1,class:"form-text text-muted"},Ot={class:"col-md-2"},Qt={class:"input-group"},Gt=["onUpdate:modelValue","onInput"],Ht={class:"col-md-2"},Jt={class:"input-group"},Kt=["onUpdate:modelValue"],Xt={class:"col-md-2 d-flex align-items-end"},Yt=["onClick"],Zt={class:"col-lg-4"},te={class:"card"},ee={class:"card-body"},se={class:"d-flex justify-content-between mb-2"},ne={class:"fw-medium"},oe={class:"d-flex justify-content-between mb-2"},ae={class:"fw-medium"},ie={class:"mb-3"},le={class:"input-group"},de={key:0,class:"invalid-feedback"},re={key:1,class:"invalid-feedback"},ue={class:"mb-3"},me={class:"input-group"},ce={key:0,class:"invalid-feedback"},pe={key:1,class:"invalid-feedback"},_e={class:"mb-3"},fe={class:"input-group"},be=["max"],ve={key:0,class:"invalid-feedback"},ye={key:1,class:"invalid-feedback"},ge={class:"form-text text-muted"},ke={class:"d-flex justify-content-between mb-2"},he={class:"fw-bold text-success fs-5"},we={key:0,class:"d-flex justify-content-between mb-2"},xe={class:"fw-medium text-primary"},qe={key:1,class:"d-flex justify-content-between mb-3"},Se={class:"fw-bold text-warning fs-5"},Fe={class:"d-grid gap-2"},Ve=["disabled"],Ce={key:0,class:"spinner-border spinner-border-sm me-2"},Ae={key:1,class:"bi bi-check-circle me-1"},Me=["disabled"],Ne=["disabled"],Ie=nt({__name:"Edit",props:{sale:{},customers:{},products:{}},setup(S){const m=S,{success:M,error:h,confirmWithDetails:P}=ct(),c=ot({}),o=at({customer_id:m.sale.customer_id||"",payment_method:m.sale.payment_method,notes:m.sale.notes||"",due_date:m.sale.due_date?new Date(m.sale.due_date).toISOString().split("T")[0]:"",tax_amount:parseFloat(String(m.sale.tax_amount))||0,discount_amount:parseFloat(String(m.sale.discount_amount))||0,down_payment_amount:parseFloat(String(m.sale.down_payment_amount))||0,payment_status:m.sale.payment_status||"pending",items:m.sale.saleItems?m.sale.saleItems.map(s=>({product_id:s.product_id||0,quantity:parseInt(String(s.quantity))||1,unit_price:parseFloat(String(s.unit_price))||0,total_price:parseFloat(String(s.total_price))||0})):[]}),z=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},R=s=>{o.items.splice(s,1)},T=(s,t)=>{const n=o.items[t];n.product_id=s.id,n.unit_price=s.price,N(t)},B=s=>o.items.map((t,n)=>n!==s?t.product_id:null).filter(t=>t!==null&&t>0),N=s=>{const t=o.items[s],n=parseFloat(String(t.quantity))||0,i=parseFloat(String(t.unit_price))||0,p=n*i;t.total_price=isNaN(p)?0:p},O=(s,t)=>s?o.items.some((n,i)=>i!==t&&n.product_id===s):!1,j=s=>{const t=o.items[s];return t.product_id?O(t.product_id,s):!1},Q=g(()=>{const s=o.items.map(t=>t.product_id).filter(t=>t>0);return s.length!==new Set(s).size}),G=()=>{const s=new Map;o.items.forEach(t=>{if(t.product_id>0)if(s.has(t.product_id)){const n=s.get(t.product_id);n.quantity+=t.quantity,n.total_price=n.quantity*n.unit_price}else s.set(t.product_id,{...t})}),o.items=Array.from(s.values())},F=s=>{const t=o.items[s];if(!t.product_id||!t.quantity)return!1;const n=V(s);return t.quantity>n},V=s=>{const t=o.items[s];if(!t.product_id)return 0;const n=m.products.find(i=>i.id===t.product_id);return n?n.stock_quantity:0},U=s=>{const t=o.items[s];if(!t.product_id)return"";const n=m.products.find(i=>i.id===t.product_id);return n?n.unit:""},H=s=>V(s),E=s=>{if(!s||s===0||typeof s!="number"||isNaN(s))return"80px";const C=70+s.toFixed(2).length*9;return`${Math.max(70,Math.min(130,C))}px`},w=s=>{if(s==null)return"0 Fcfa";const t=parseFloat(String(s));return isNaN(t)?"0 Fcfa":new Intl.NumberFormat("fr-FR").format(t)+" Fcfa"},J=g(()=>o.items.length),L=g(()=>{const s=o.items.reduce((t,n)=>{const i=parseFloat(String(n.quantity))||0,p=parseFloat(String(n.unit_price))||0,C=i*p;return t+(isNaN(C)?0:C)},0);return isNaN(s)?0:s}),K=g(()=>{const s=parseFloat(String(o.tax_amount))||0;return isNaN(s)?0:s}),X=g(()=>{const s=parseFloat(String(o.discount_amount))||0;return isNaN(s)?0:s}),b=g(()=>{const s=L.value,t=K.value,n=X.value,i=s+t-n;return isNaN(i)?0:i}),Y=g(()=>b.value-(o.down_payment_amount||0));it([()=>o.down_payment_amount,b],()=>{const s=o.down_payment_amount||0,t=b.value||0;s>=t&&t>0?o.payment_status="paid":s>0&&t-s>0?o.payment_status="partial":s===0&&t>0&&(o.payment_status="pending")});const Z=()=>{const s={};return o.payment_method||(s.payment_method="Le mode de paiement est requis"),o.tax_amount<0&&(s.tax_amount="Le montant de la taxe ne peut pas être négatif"),o.discount_amount<0&&(s.discount_amount="Le montant de la remise ne peut pas être négatif"),o.down_payment_amount<0&&(s.down_payment_amount="L'acompte ne peut pas être négatif"),o.down_payment_amount>b.value&&(s.down_payment_amount="L'acompte ne peut pas dépasser le montant total"),o.items.forEach((t,n)=>{t.product_id||(s[`items.${n}.product_id`]="Le produit est requis"),(!t.quantity||t.quantity<1)&&(s[`items.${n}.quantity`]="La quantité doit être au moins 1"),(!t.unit_price||t.unit_price<0)&&(s[`items.${n}.unit_price`]="Le prix unitaire doit être positif"),F(n)&&(s[`items.${n}.quantity`]="La quantité dépasse le stock disponible")}),Object.keys(s).length===0?null:s},W=(s,t)=>{c.value[s]&&delete c.value[s];let n="";switch(s){case"payment_method":t||(n="Le mode de paiement est requis");break;case"tax_amount":t<0&&(n="Le montant de la taxe ne peut pas être négatif");break;case"discount_amount":t<0&&(n="Le montant de la remise ne peut pas être négatif");break;case"down_payment_amount":t<0?n="L'acompte ne peut pas être négatif":t>b.value&&(n="L'acompte ne peut pas dépasser le montant total");break}n&&(c.value[s]=n)},tt=()=>{c.value={};const s=Z();if(s){c.value=s;return}if(o.items.length===0){h("Veuillez ajouter au moins un article.");return}if(o.items.some((n,i)=>F(i))){h("Veuillez corriger les quantités qui dépassent le stock disponible.");return}o.put(q("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente modifiée avec succès !"),c.value={}},onError:()=>{h("Erreur lors de la modification de la vente.")}})},et=async()=>{await P("Êtes-vous sûr de vouloir marquer cette vente comme payée ?","Confirmer le paiement",`Cela va :<br>• Marquer le statut comme "payé"<br>• Définir l'acompte égal au montant total<br>• Mettre le reste à payer à 0`)&&(o.payment_status="paid",o.down_payment_amount=b.value,o.put(q("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente marquée comme payée avec succès !")},onError:()=>{h("Erreur lors de la mise à jour du statut de paiement."),o.payment_status=m.sale.payment_status||"pending",o.down_payment_amount=parseFloat(String(m.sale.down_payment_amount))||0}}))},st=async()=>{await P("Êtes-vous sûr de vouloir marquer cette vente comme non payée ?","Confirmer le non-paiement",`Cela va :<br>• Marquer le statut comme "en attente"<br>• Remettre l'acompte à 0<br>• Le reste à payer sera égal au montant total`)&&(o.payment_status="pending",o.down_payment_amount=0,o.put(q("sales.update",{id:m.sale.id}),{onSuccess:()=>{M("Vente marquée comme non payée avec succès !")},onError:()=>{h("Erreur lors de la mise à jour du statut de paiement."),o.payment_status=m.sale.payment_status||"pending",o.down_payment_amount=parseFloat(String(m.sale.down_payment_amount))||0}}))},{errors:u,processing:x}=o;return(s,t)=>(l(),lt(mt,null,{default:I(()=>[e("div",bt,[e("div",null,[e("h1",vt,"Modifier la vente "+r(S.sale.sale_number),1),t[9]||(t[9]=e("p",{class:"text-muted mb-0"},"Modifiez les informations de la vente",-1))]),A(a(D),{href:a(q)("sales.index"),class:"btn btn-outline-secondary"},{default:I(()=>[...t[10]||(t[10]=[e("i",{class:"bi bi-arrow-left me-1"},null,-1),f(" Retour à la liste ",-1)])]),_:1},8,["href"])]),e("form",null,[e("div",yt,[e("div",gt,[e("div",kt,[t[17]||(t[17]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Informations générales")],-1)),e("div",ht,[e("div",wt,[e("div",xt,[t[11]||(t[11]=e("label",{class:"form-label"},"Client",-1)),A(pt,{customers:S.customers,modelValue:a(o).customer_id,"onUpdate:modelValue":t[0]||(t[0]=n=>a(o).customer_id=n),placeholder:"Rechercher un client (optionnel)...","is-invalid":!!a(u).customer_id},null,8,["customers","modelValue","is-invalid"]),a(u).customer_id?(l(),d("div",qt,r(a(u).customer_id),1)):_("",!0)]),e("div",St,[t[13]||(t[13]=e("label",{class:"form-label"},[f(" Mode de paiement "),e("span",{class:"text-danger"},"*")],-1)),v(e("select",{"onUpdate:modelValue":t[1]||(t[1]=n=>a(o).payment_method=n),required:"",class:k(["form-select",{"is-invalid":a(u).payment_method||c.value.payment_method}]),onBlur:t[2]||(t[2]=n=>W("payment_method",a(o).payment_method)),onChange:t[3]||(t[3]=n=>W("payment_method",a(o).payment_method))},[...t[12]||(t[12]=[e("option",{value:""},"Sélectionner un mode de paiement",-1),e("option",{value:"cash"},"Espèces",-1),e("option",{value:"card"},"Carte",-1),e("option",{value:"bank_transfer"},"Virement bancaire",-1),e("option",{value:"check"},"Chèque",-1),e("option",{value:"orange_money"},"Orange Money",-1),e("option",{value:"wave"},"Wave",-1)])],34),[[dt,a(o).payment_method]]),a(u).payment_method?(l(),d("div",Ft,r(a(u).payment_method),1)):_("",!0),c.value.payment_method?(l(),d("div",Vt,r(c.value.payment_method),1)):_("",!0)]),e("div",Ct,[t[14]||(t[14]=e("label",{class:"form-label"},"Date d'échéance (optionnel)",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>a(o).due_date=n),type:"date",class:k(["form-control",{"is-invalid":a(u).due_date}])},null,2),[[y,a(o).due_date]]),a(u).due_date?(l(),d("div",At,r(a(u).due_date),1)):_("",!0),t[15]||(t[15]=e("small",{class:"form-text text-muted"},"Date limite de paiement",-1))])]),e("div",Mt,[t[16]||(t[16]=e("label",{class:"form-label"},"Notes (optionnel)",-1)),v(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=n=>a(o).notes=n),rows:"3",class:k(["form-control",{"is-invalid":a(u).notes}]),placeholder:"Ajoutez des notes sur cette vente..."},null,2),[[y,a(o).notes]]),a(u).notes?(l(),d("div",Nt,r(a(u).notes),1)):_("",!0)])])]),e("div",It,[e("div",Pt,[t[20]||(t[20]=e("h5",{class:"card-title mb-0"},"Articles",-1)),e("div",jt,[Q.value?(l(),d("button",{key:0,type:"button",onClick:G,class:"btn btn-warning btn-sm"},[...t[18]||(t[18]=[e("i",{class:"bi bi-arrow-down-up me-1"},null,-1),f(" Fusionner les doublons ",-1)])])):_("",!0),e("button",{type:"button",onClick:z,class:"btn btn-primary btn-sm"},[...t[19]||(t[19]=[e("i",{class:"bi bi-plus-circle me-1"},null,-1),f(" Ajouter un article ",-1)])])])]),e("div",Ut,[a(o).items.length===0?(l(),d("div",Et,[...t[21]||(t[21]=[e("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),e("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),d("div",Lt,[(l(!0),d(rt,null,ut(a(o).items,(n,i)=>(l(),d("div",{key:i,class:"border rounded p-3 mb-3"},[e("div",Wt,[e("div",Dt,[t[22]||(t[22]=e("label",{class:"form-label"},[f(" Produit "),e("span",{class:"text-danger"},"*")],-1)),A(_t,{modelValue:n.product_id,"onUpdate:modelValue":p=>n.product_id=p,products:S.products,"exclude-product-ids":B(i),"is-invalid":j(i),placeholder:"Rechercher un produit...",onSelected:p=>T(p,i)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),j(i)?(l(),d("div",$t," Ce produit est déjà sélectionné dans cette vente. ")):_("",!0)]),e("div",zt,[t[23]||(t[23]=e("label",{class:"form-label"},[f(" Quantité "),e("span",{class:"text-danger"},"*")],-1)),v(e("input",{"onUpdate:modelValue":p=>n.quantity=p,type:"number",min:"1",max:H(i),required:"",class:k(["form-control",{"is-invalid":F(i)}]),onInput:p=>N(i)},null,42,Rt),[[y,n.quantity,void 0,{number:!0}]]),F(i)?(l(),d("div",Tt," Stock insuffisant. Disponible: "+r(V(i))+" "+r(U(i)),1)):n.product_id?(l(),d("div",Bt," Stock disponible: "+r(V(i))+" "+r(U(i)),1)):_("",!0)]),e("div",Ot,[t[25]||(t[25]=e("label",{class:"form-label"},"Prix unitaire",-1)),e("div",Qt,[v(e("input",{"onUpdate:modelValue":p=>n.unit_price=p,type:"number",step:"0.01",min:"0",class:"form-control",style:$({width:E(n.unit_price)}),onInput:p=>N(i)},null,44,Gt),[[y,n.unit_price,void 0,{number:!0}]]),t[24]||(t[24]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Ht,[t[27]||(t[27]=e("label",{class:"form-label"},"Total",-1)),e("div",Jt,[v(e("input",{"onUpdate:modelValue":p=>n.total_price=p,type:"number",step:"0.01",readonly:"",class:"form-control",style:$({width:E(n.total_price)})},null,12,Kt),[[y,n.total_price,void 0,{number:!0}]]),t[26]||(t[26]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Xt,[e("button",{type:"button",onClick:p=>R(i),class:"btn btn-outline-danger w-100"},[...t[28]||(t[28]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Yt)])])]))),128))]))])])]),e("div",Zt,[e("div",te,[t[44]||(t[44]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Résumé de la vente")],-1)),e("div",ee,[e("div",se,[t[29]||(t[29]=e("span",null,"Nombre d'articles:",-1)),e("span",ne,r(J.value),1)]),e("div",oe,[t[30]||(t[30]=e("span",null,"Sous-total:",-1)),e("span",ae,r(w(L.value)),1)]),e("div",ie,[t[32]||(t[32]=e("label",{class:"form-label"},"Taxes (Fcfa)",-1)),e("div",le,[v(e("input",{type:"number","onUpdate:modelValue":t[6]||(t[6]=n=>a(o).tax_amount=n),step:"0.01",min:"0",class:k(["form-control",{"is-invalid":a(u).tax_amount||c.value.tax_amount}]),placeholder:"0.00"},null,2),[[y,a(o).tax_amount,void 0,{number:!0}]]),t[31]||(t[31]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).tax_amount?(l(),d("div",de,r(a(u).tax_amount),1)):_("",!0),c.value.tax_amount?(l(),d("div",re,r(c.value.tax_amount),1)):_("",!0)]),e("div",ue,[t[34]||(t[34]=e("label",{class:"form-label"},"Remise (Fcfa)",-1)),e("div",me,[v(e("input",{type:"number","onUpdate:modelValue":t[7]||(t[7]=n=>a(o).discount_amount=n),step:"0.01",min:"0",class:k(["form-control",{"is-invalid":a(u).discount_amount||c.value.discount_amount}]),placeholder:"0.00"},null,2),[[y,a(o).discount_amount,void 0,{number:!0}]]),t[33]||(t[33]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).discount_amount?(l(),d("div",ce,r(a(u).discount_amount),1)):_("",!0),c.value.discount_amount?(l(),d("div",pe,r(c.value.discount_amount),1)):_("",!0)]),e("div",_e,[t[36]||(t[36]=e("label",{class:"form-label"},"Acompte (Fcfa)",-1)),e("div",fe,[v(e("input",{type:"number","onUpdate:modelValue":t[8]||(t[8]=n=>a(o).down_payment_amount=n),step:"0.01",min:"0",max:b.value,class:k(["form-control",{"is-invalid":a(u).down_payment_amount||c.value.down_payment_amount}]),placeholder:"0.00"},null,10,be),[[y,a(o).down_payment_amount,void 0,{number:!0}]]),t[35]||(t[35]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).down_payment_amount?(l(),d("div",ve,r(a(u).down_payment_amount),1)):_("",!0),c.value.down_payment_amount?(l(),d("div",ye,r(c.value.down_payment_amount),1)):_("",!0),e("div",ge," Montant maximum: "+r(w(b.value)),1)]),t[43]||(t[43]=e("hr",null,null,-1)),e("div",ke,[t[37]||(t[37]=e("span",{class:"fw-bold"},"Total:",-1)),e("span",he,r(w(b.value)),1)]),a(o).down_payment_amount>0?(l(),d("div",we,[t[38]||(t[38]=e("span",null,"Acompte:",-1)),e("span",xe,r(w(a(o).down_payment_amount)),1)])):_("",!0),a(o).down_payment_amount>0?(l(),d("div",qe,[t[39]||(t[39]=e("span",{class:"fw-bold"},"Reste à payer:",-1)),e("span",Se,r(w(Y.value)),1)])):_("",!0),e("div",Fe,[e("button",{type:"button",onClick:tt,class:"btn btn-success",disabled:a(x)||a(o).items.length===0},[a(x)?(l(),d("span",Ce)):(l(),d("i",Ae)),f(" "+r(a(x)?"Modification...":"Modifier la vente"),1)],8,Ve),a(o).payment_status!=="paid"?(l(),d("button",{key:0,type:"button",onClick:et,class:"btn btn-primary",disabled:a(x)},[...t[40]||(t[40]=[e("i",{class:"bi bi-credit-card me-1"},null,-1),f(" Marquer comme payé ",-1)])],8,Me)):_("",!0),a(o).payment_status==="paid"?(l(),d("button",{key:1,type:"button",onClick:st,class:"btn btn-warning",disabled:a(x)},[...t[41]||(t[41]=[e("i",{class:"bi bi-x-circle me-1"},null,-1),f(" Marquer comme non payé ",-1)])],8,Ne)):_("",!0),A(a(D),{href:a(q)("sales.index"),class:"btn btn-outline-secondary"},{default:I(()=>[...t[42]||(t[42]=[f(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),Be=ft(Ie,[["__scopeId","data-v-9938f41b"]]);export{Be as default};
