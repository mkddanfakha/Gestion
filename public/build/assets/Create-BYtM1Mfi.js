import{d as te,r as N,i as se,y as P,B as U,z as ie,C as oe,c as re,w as B,a as t,j as z,u as n,l as D,f as _,m as b,b as u,e as p,n as y,o as l,F as $,g as V,t as c,p as R,v as h}from"./app-CKyF0dn4.js";import{_ as ne}from"./AppLayout.vue_vue_type_script_setup_true_lang-IbUY7iBr.js";import{r as E}from"./routes-D3G7R3Tx.js";import{u as le}from"./useSweetAlert-CjcY7Pj8.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-DOjYiQwv.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const ae={class:"d-flex justify-content-between align-items-center mb-4"},de={class:"row"},ce={class:"col-lg-8"},pe={class:"card mb-4"},me={class:"card-body"},_e={class:"row g-3"},ve={class:"col-md-6"},be=["value"],fe={key:0,class:"invalid-feedback"},ye={key:1,class:"invalid-feedback"},he={class:"col-md-6"},ke={class:"position-relative"},ge={key:0,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},qe=["onClick"],we={key:1,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},Ce={key:2,class:"dropdown-menu show w-100",style:{position:"absolute",top:"100%","z-index":"1000"}},xe={key:0,class:"mt-1"},Ne={key:0,class:"text-danger small"},$e={key:1,class:"text-danger small"},Ve={key:1,class:"mt-2"},je={class:"badge bg-primary"},Oe={class:"col-md-6"},Ae={key:0,class:"invalid-feedback"},Se={key:1,class:"invalid-feedback"},Ie={class:"col-md-6"},Le={key:0,class:"invalid-feedback"},Pe={class:"col-12"},Ue={key:0,class:"invalid-feedback"},Be={class:"card mb-4"},Ee={class:"card-body"},Fe={key:0,class:"text-center py-4 text-muted"},Te={key:1},ze={class:"row g-3"},De={class:"col-md-5"},Re=["onUpdate:modelValue","onChange","onBlur"],Me=["value","disabled"],Qe={key:0},Xe={key:0,class:"invalid-feedback"},Ge={key:1,class:"invalid-feedback"},He={class:"col-md-2"},Je=["onUpdate:modelValue","onInput","onBlur"],Ke={key:0,class:"invalid-feedback"},We={class:"col-md-3"},Ye=["onUpdate:modelValue","onInput","onBlur"],Ze={key:0,class:"invalid-feedback"},et={class:"col-md-2"},tt=["value"],st={class:"col-12 text-end"},it=["onClick"],ot={class:"col-lg-4"},rt={class:"card sticky-top",style:{top:"20px"}},nt={class:"card-body"},lt={class:"mb-3"},ut={class:"d-flex justify-content-between mb-2"},at={class:"fw-medium"},dt={class:"d-flex justify-content-between mb-2"},ct={class:"fw-medium"},pt={class:"d-flex justify-content-between mb-2"},mt={class:"d-flex justify-content-between mb-2"},_t={class:"d-flex justify-content-between"},vt={class:"fw-bold text-success fs-5"},bt={class:"d-grid gap-2"},ft=["disabled"],yt={key:0,class:"spinner-border spinner-border-sm me-2"},ht={key:1,class:"bi bi-check-circle me-1"},kt=te({__name:"Create",props:{suppliers:{},products:{},purchaseOrders:{},purchaseOrder:{}},setup(j){const f=j,{success:M,error:Q}=le(),v=N(""),k=N(!1),g=N(null),o=se({supplier_id:f.purchaseOrder?.supplier_id||"",purchase_order_id:f.purchaseOrder?.id||"",delivery_date:new Date().toISOString().split("T")[0],status:"pending",notes:"",invoice_number:"",tax_amount:0,discount_amount:0,subtotal:0,total_amount:0,items:f.purchaseOrder?.items?.map(i=>({product_id:i.product_id||0,quantity:Number(i.quantity)||1,unit_price:Number(i.unit_price)||0,total_price:Number(i.quantity||1)*Number(i.unit_price||0)}))||[]}),O=P(()=>{if(!o.supplier_id)return[];let i=f.purchaseOrders.filter(e=>e.supplier_id===Number(o.supplier_id));if(v.value){const e=v.value.toLowerCase();i=i.filter(s=>s.po_number.toLowerCase().includes(e))}return i}),X=()=>{k.value=!0},G=i=>{g.value=i,o.purchase_order_id=i.id,v.value=i.po_number,k.value=!1},H=()=>{o.purchase_order_id="",o.items=[],v.value="",g.value=null,k.value=!1};U(()=>o.supplier_id,()=>{o.supplier_id&&(o.purchase_order_id="",o.items=[],v.value="",g.value=null,k.value=!1)}),U(()=>o.items.map(i=>({quantity:i.quantity,unit_price:i.unit_price,total_price:i.total_price})),()=>{o.items.forEach((i,e)=>{const s=Number(i.quantity)||0,r=Number(i.unit_price)||0;i.total_price=s*r}),w()},{deep:!0}),U([()=>o.tax_amount,()=>o.discount_amount],()=>{C()});const J=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},K=i=>{o.items.splice(i,1),w()},W=i=>{const e=o.items[i],s=f.products.find(r=>r.id===e.product_id);s&&(e.unit_price=s.cost_price||s.price,A(i))},A=i=>{const e=o.items[i];if(!e)return;const s=Number(e.quantity)||0,r=Number(e.unit_price)||0;e.total_price=s*r,w()},w=()=>{const i=o.items.reduce((e,s)=>{const r=Number(s.total_price)||0;return e+r},0);o.subtotal=i,C()},C=()=>{const i=Number(o.subtotal)||0,e=Number(o.tax_amount)||0,s=Number(o.discount_amount)||0;o.total_amount=i+e-s},F=P(()=>o.items.reduce((i,e)=>{const s=Number(e.total_price)||0;return i+s},0)),Y=P(()=>{const i=F.value,e=Number(o.tax_amount)||0,s=Number(o.discount_amount)||0;return i+e-s}),S=i=>new Intl.NumberFormat("fr-FR").format(i)+" Fcfa",Z=()=>{d.value={};const i=ee();if(i){d.value=i;return}o.items.forEach((e,s)=>{const r=Number(e.quantity)||0,a=Number(e.unit_price)||0;e.total_price=r*a}),w(),o.post(E("delivery-notes.store"),{onSuccess:()=>{M("Bon de livraison créé avec succès !"),d.value={}},onError:()=>{Q("Erreur lors de la création du bon de livraison.")}})},d=N({}),{errors:m,processing:I}=o,L=(i,e)=>!i||i===0?!1:o.items.some((s,r)=>r!==e&&s.product_id===i),x=i=>{const e=o.items[i];return!e.product_id||e.product_id===0?!1:L(e.product_id,i)},ee=()=>{const i={};return o.supplier_id||(i.supplier_id="Le fournisseur est requis"),o.purchase_order_id||(i.purchase_order_id="Le bon de commande est requis"),o.delivery_date||(i.delivery_date="La date de livraison est requise"),o.items.length===0&&(i.items="Au moins un article est requis"),o.items.forEach((e,s)=>{!e.product_id||e.product_id===0?i[`items.${s}.product_id`]="Le produit est requis":x(s)&&(i[`items.${s}.product_id`]="Ce produit est déjà sélectionné"),(!e.quantity||e.quantity<1)&&(i[`items.${s}.quantity`]="La quantité doit être supérieure à 0"),(!e.unit_price||e.unit_price<0)&&(i[`items.${s}.unit_price`]="Le prix unitaire est requis et doit être positif")}),Object.keys(i).length>0?i:null},q=(i,e,s)=>{const r=`items.${i}.${e}`;d.value[r]&&delete d.value[r];let a="";switch(e){case"product_id":!s||s===0?a="Le produit est requis":x(i)&&(a="Ce produit est déjà sélectionné");break;case"quantity":(!s||s<1)&&(a="La quantité doit être supérieure à 0");break;case"unit_price":(!s||s<0)&&(a="Le prix unitaire est requis et doit être positif");break}a&&(d.value[r]=a)};ie(()=>{f.purchaseOrder&&(g.value=f.purchaseOrder,v.value=f.purchaseOrder.po_number),o.items.length>0&&w(),document.addEventListener("click",T)}),oe(()=>{document.removeEventListener("click",T)});const T=i=>{i.target.closest(".position-relative")||(k.value=!1)};return(i,e)=>(l(),re(ne,null,{default:B(()=>[t("div",ae,[e[9]||(e[9]=t("div",null,[t("h1",{class:"h2 mb-1"},"Nouveau bon de livraison"),t("p",{class:"text-muted mb-0"},"Enregistrez une nouvelle livraison fournisseur")],-1)),z(n(D),{href:n(E)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:B(()=>[...e[8]||(e[8]=[t("i",{class:"bi bi-arrow-left me-1"},null,-1),_(" Retour à la liste ",-1)])]),_:1},8,["href"])]),t("form",null,[t("div",de,[t("div",ce,[t("div",pe,[e[19]||(e[19]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Informations générales")],-1)),t("div",me,[t("div",_e,[t("div",ve,[e[11]||(e[11]=t("label",{class:"form-label"},[_(" Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),b(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>n(o).supplier_id=s),required:"",class:y(["form-select",{"is-invalid":n(m).supplier_id||d.value.supplier_id}]),onChange:H},[e[10]||(e[10]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(l(!0),u($,null,V(j.suppliers,s=>(l(),u("option",{key:s.id,value:s.id},c(s.name),9,be))),128))],34),[[R,n(o).supplier_id]]),n(m).supplier_id?(l(),u("div",fe,c(n(m).supplier_id),1)):p("",!0),d.value.supplier_id?(l(),u("div",ye,c(d.value.supplier_id),1)):p("",!0)]),t("div",he,[e[15]||(e[15]=t("label",{class:"form-label"},[_(" Bon de commande "),t("span",{class:"text-danger"},"*")],-1)),t("div",ke,[b(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=s=>v.value=s),onInput:X,onFocus:e[2]||(e[2]=s=>k.value=!0),placeholder:"Rechercher un bon de commande...",class:y(["form-control",{"is-invalid":n(m).purchase_order_id||d.value.purchase_order_id}])},null,34),[[h,v.value]]),k.value&&O.value.length>0?(l(),u("div",ge,[(l(!0),u($,null,V(O.value,s=>(l(),u("a",{key:s.id,onClick:r=>G(s),class:"dropdown-item"},c(s.po_number),9,qe))),128))])):p("",!0),v.value&&O.value.length===0&&f.purchaseOrders.length>0?(l(),u("div",we,[...e[12]||(e[12]=[t("div",{class:"dropdown-item text-muted"}," Aucun bon de commande trouvé ",-1)])])):p("",!0),v.value&&!n(o).supplier_id?(l(),u("div",Ce,[...e[13]||(e[13]=[t("div",{class:"dropdown-item text-muted"}," Veuillez d'abord sélectionner un fournisseur ",-1)])])):p("",!0)]),n(m).purchase_order_id||d.value.purchase_order_id?(l(),u("div",xe,[n(m).purchase_order_id?(l(),u("div",Ne,c(n(m).purchase_order_id),1)):p("",!0),d.value.purchase_order_id?(l(),u("div",$e,c(d.value.purchase_order_id),1)):p("",!0)])):p("",!0),g.value?(l(),u("div",Ve,[t("span",je,[e[14]||(e[14]=t("i",{class:"bi bi-check-circle me-1"},null,-1)),_(" "+c(g.value.po_number),1)])])):p("",!0)]),t("div",Oe,[e[16]||(e[16]=t("label",{class:"form-label"},[_(" Date de livraison "),t("span",{class:"text-danger"},"*")],-1)),b(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>n(o).delivery_date=s),type:"date",required:"",class:y(["form-control",{"is-invalid":n(m).delivery_date||d.value.delivery_date}])},null,2),[[h,n(o).delivery_date]]),n(m).delivery_date?(l(),u("div",Ae,c(n(m).delivery_date),1)):p("",!0),d.value.delivery_date?(l(),u("div",Se,c(d.value.delivery_date),1)):p("",!0)]),t("div",Ie,[e[17]||(e[17]=t("label",{class:"form-label"},"Numéro de facture fournisseur",-1)),b(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>n(o).invoice_number=s),type:"text",class:y(["form-control",{"is-invalid":n(m).invoice_number}]),placeholder:"EX: FACT-2025-001"},null,2),[[h,n(o).invoice_number]]),n(m).invoice_number?(l(),u("div",Le,c(n(m).invoice_number),1)):p("",!0)]),t("div",Pe,[e[18]||(e[18]=t("label",{class:"form-label"},"Notes",-1)),b(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>n(o).notes=s),rows:"3",class:y(["form-control",{"is-invalid":n(m).notes}]),placeholder:"Ajoutez des notes sur cette livraison..."},null,2),[[h,n(o).notes]]),n(m).notes?(l(),u("div",Ue,c(n(m).notes),1)):p("",!0)])])])]),t("div",Be,[t("div",{class:"card-header d-flex justify-content-between align-items-center"},[e[21]||(e[21]=t("h5",{class:"card-title mb-0"},"Articles livrés",-1)),t("button",{type:"button",onClick:J,class:"btn btn-primary btn-sm"},[...e[20]||(e[20]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),_(" Ajouter un article ",-1)])])]),t("div",Ee,[n(o).items.length===0?(l(),u("div",Fe,[...e[22]||(e[22]=[t("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),t("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),u("div",Te,[(l(!0),u($,null,V(n(o).items,(s,r)=>(l(),u("div",{key:r,class:"border rounded p-3 mb-3"},[t("div",ze,[t("div",De,[e[24]||(e[24]=t("label",{class:"form-label"},[_("Produit "),t("span",{class:"text-danger"},"*")],-1)),b(t("select",{"onUpdate:modelValue":a=>s.product_id=a,required:"",class:y(["form-select",{"is-invalid":d.value[`items.${r}.product_id`]||x(r)}]),onChange:a=>{W(r),q(r,"product_id",s.product_id)},onBlur:a=>q(r,"product_id",s.product_id)},[e[23]||(e[23]=t("option",{value:"0"},"Sélectionner un produit",-1)),(l(!0),u($,null,V(j.products,a=>(l(),u("option",{key:a.id,value:a.id,disabled:L(a.id,r)},[_(c(a.name)+" ",1),L(a.id,r)?(l(),u("span",Qe," - Déjà sélectionné")):p("",!0)],8,Me))),128))],42,Re),[[R,s.product_id]]),d.value[`items.${r}.product_id`]?(l(),u("div",Xe,c(d.value[`items.${r}.product_id`]),1)):p("",!0),x(r)?(l(),u("div",Ge," Ce produit est déjà sélectionné dans ce bon de livraison. ")):p("",!0)]),t("div",He,[e[25]||(e[25]=t("label",{class:"form-label"},[_("Quantité "),t("span",{class:"text-danger"},"*")],-1)),b(t("input",{"onUpdate:modelValue":a=>s.quantity=a,type:"number",min:"1",required:"",class:y(["form-control",{"is-invalid":d.value[`items.${r}.quantity`]}]),onInput:a=>{A(r),q(r,"quantity",s.quantity)},onBlur:a=>q(r,"quantity",s.quantity)},null,42,Je),[[h,s.quantity,void 0,{number:!0}]]),d.value[`items.${r}.quantity`]?(l(),u("div",Ke,c(d.value[`items.${r}.quantity`]),1)):p("",!0)]),t("div",We,[e[26]||(e[26]=t("label",{class:"form-label"},[_("Prix d'achat unitaire "),t("span",{class:"text-danger"},"*")],-1)),b(t("input",{"onUpdate:modelValue":a=>s.unit_price=a,type:"number",step:"0.01",min:"0",required:"",class:y(["form-control",{"is-invalid":d.value[`items.${r}.unit_price`]}]),onInput:a=>{A(r),q(r,"unit_price",s.unit_price)},onBlur:a=>q(r,"unit_price",s.unit_price)},null,42,Ye),[[h,s.unit_price,void 0,{number:!0}]]),d.value[`items.${r}.unit_price`]?(l(),u("div",Ze,c(d.value[`items.${r}.unit_price`]),1)):p("",!0)]),t("div",et,[e[27]||(e[27]=t("label",{class:"form-label"},"Total",-1)),t("input",{value:S(s.total_price),type:"text",class:"form-control",readonly:""},null,8,tt)]),t("div",st,[t("button",{type:"button",onClick:a=>K(r),class:"btn btn-sm btn-outline-danger"},[...e[28]||(e[28]=[t("i",{class:"bi bi-trash me-1"},null,-1),_(" Supprimer ",-1)])],8,it)])])]))),128))]))])])]),t("div",ot,[t("div",rt,[e[37]||(e[37]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},"Résumé")],-1)),t("div",nt,[t("div",lt,[t("div",ut,[e[29]||(e[29]=t("span",null,"Articles:",-1)),t("span",at,c(n(o).items.length),1)]),t("div",dt,[e[30]||(e[30]=t("span",null,"Sous-total:",-1)),t("span",ct,c(S(F.value)),1)]),t("div",pt,[e[31]||(e[31]=t("span",null,"Taxes:",-1)),b(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>n(o).tax_amount=s),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:C},null,544),[[h,n(o).tax_amount,void 0,{number:!0}]])]),t("div",mt,[e[32]||(e[32]=t("span",null,"Remise:",-1)),b(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>n(o).discount_amount=s),type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",style:{width:"120px"},onInput:C},null,544),[[h,n(o).discount_amount,void 0,{number:!0}]])]),e[34]||(e[34]=t("hr",null,null,-1)),t("div",_t,[e[33]||(e[33]=t("span",{class:"fw-bold"},"Total:",-1)),t("span",vt,c(S(Y.value)),1)])]),e[36]||(e[36]=t("div",{class:"alert alert-info"},[t("i",{class:"bi bi-info-circle me-1"}),_(" Le stock sera ajusté automatiquement après la validation du bon de livraison. ")],-1)),t("div",bt,[t("button",{type:"button",onClick:Z,class:"btn btn-success",disabled:n(I)||n(o).items.length===0},[n(I)?(l(),u("span",yt)):(l(),u("i",ht)),_(" "+c(n(I)?"Création...":"Créer le bon de livraison"),1)],8,ft),z(n(D),{href:n(E)("delivery-notes.index"),class:"btn btn-outline-secondary"},{default:B(()=>[...e[35]||(e[35]=[_(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),Vt=ue(kt,[["__scopeId","data-v-b0a63c0b"]]);export{Vt as default};
