import{d as G,i as H,y as f,c as J,w as k,a as s,j as S,u as e,l as W,f as v,m,b as a,e as p,n as _,o as l,F as w,g as C,t as c,p as V,v as b,s as D}from"./app-oFHxr63-.js";import{_ as K}from"./AppLayout.vue_vue_type_script_setup_true_lang-oJPXENP6.js";import{r as q}from"./routes-D3G7R3Tx.js";import{u as X}from"./useSweetAlert-CjcY7Pj8.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-CedOSUd9.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const Z={class:"d-flex justify-content-between align-items-center mb-4"},tt={class:"row"},st={class:"col-lg-8"},et={class:"card mb-4"},ot={class:"card-body"},nt={class:"row g-3"},it={class:"col-md-6"},lt=["value"],at={key:0,class:"invalid-feedback"},dt={class:"col-md-6"},rt={key:0,class:"invalid-feedback"},ut={class:"col-md-6"},ct=["min"],mt={key:0,class:"invalid-feedback"},pt={class:"mt-3"},vt={key:0,class:"invalid-feedback"},_t={class:"card mb-4"},bt={class:"card-header d-flex justify-content-between align-items-center"},ft={class:"d-flex gap-2"},yt={class:"card-body"},gt={key:0,class:"text-center py-4 text-muted"},xt={key:1},ht={class:"row g-3"},kt={class:"col-md-5"},wt=["onUpdate:modelValue","onChange"],Ct=["value","disabled"],Vt={key:0},qt={key:0,class:"invalid-feedback"},Ft={class:"col-md-2"},It=["onUpdate:modelValue","onInput"],Ut={class:"col-md-2"},jt={class:"input-group"},At=["onUpdate:modelValue","onInput"],St={class:"col-md-2"},Wt={class:"input-group"},Dt=["onUpdate:modelValue"],Pt={class:"col-md-1 d-flex align-items-end"},Et=["onClick"],Nt={class:"col-lg-4"},zt={class:"card"},Tt={class:"card-body"},Mt={class:"d-flex justify-content-between mb-2"},$t={class:"fw-medium"},Bt={class:"mb-3"},Rt={class:"input-group"},Lt={key:0,class:"invalid-feedback"},Ot={class:"mb-3"},Qt={class:"input-group"},Gt={key:0,class:"invalid-feedback"},Ht={class:"d-flex justify-content-between mb-3"},Jt={class:"fw-bold text-success fs-5"},Kt={class:"d-grid gap-2"},Xt=["disabled"],Yt={key:0,class:"spinner-border spinner-border-sm me-2"},Zt={key:1,class:"bi bi-check-circle me-1"},ts=G({__name:"Create",props:{customers:{},products:{}},setup(y){const P=y,{success:E,error:F}=X(),o=H({customer_id:"",status:"draft",notes:"",valid_until:"",tax_amount:0,discount_amount:0,items:[]}),N=()=>{o.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},z=i=>{o.items.splice(i,1)},T=i=>{const t=o.items[i],n=P.products.find(u=>u.id===t.product_id);n&&(t.unit_price=n.price,g(i))},g=i=>{const t=o.items[i];t.total_price=t.quantity*t.unit_price},x=(i,t)=>i?o.items.some((n,u)=>u!==t&&n.product_id===i):!1,I=i=>{const t=o.items[i];return t.product_id?x(t.product_id,i):!1},M=f(()=>{const i=o.items.map(t=>t.product_id).filter(t=>t>0);return i.length!==new Set(i).size}),$=()=>{const i=new Map;o.items.forEach(t=>{if(t.product_id>0)if(i.has(t.product_id)){const n=i.get(t.product_id);n.quantity+=t.quantity,n.total_price=n.quantity*n.unit_price}else i.set(t.product_id,{...t})}),o.items=Array.from(i.values())},U=i=>{if(!i||i===0||typeof i!="number"||isNaN(i))return"80px";const Q=70+i.toFixed(2).length*9;return`${Math.max(70,Math.min(130,Q))}px`},j=i=>new Intl.NumberFormat("fr-FR").format(i)+" Fcfa",A=f(()=>o.items.reduce((i,t)=>i+t.total_price,0)),B=f(()=>o.tax_amount||0),R=f(()=>o.discount_amount||0),L=f(()=>A.value+B.value-R.value),O=()=>{if(o.items.length===0){F("Veuillez ajouter au moins un article.");return}const i={customer_id:o.customer_id||null,status:o.status,notes:o.notes||null,valid_until:o.valid_until||null,tax_amount:o.tax_amount||0,discount_amount:o.discount_amount||0,items:o.items.map(t=>({product_id:t.product_id,quantity:t.quantity,unit_price:t.unit_price}))};o.transform(()=>i).post(q("quotes.store"),{onSuccess:()=>{E("Devis créé avec succès !"),o.reset()},onError:t=>{console.error("Erreurs de validation:",t),F("Erreur lors de la création du devis.")}})},{errors:d,processing:h}=o;return(i,t)=>(l(),J(K,null,{default:k(()=>[s("div",Z,[t[7]||(t[7]=s("div",null,[s("h1",{class:"h2 mb-1"},"Nouveau devis"),s("p",{class:"text-muted mb-0"},"Créez un nouveau devis")],-1)),S(e(W),{href:e(q)("quotes.index"),class:"btn btn-outline-secondary"},{default:k(()=>[...t[6]||(t[6]=[s("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),s("form",null,[s("div",tt,[s("div",st,[s("div",et,[t[15]||(t[15]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Informations générales")],-1)),s("div",ot,[s("div",nt,[s("div",it,[t[9]||(t[9]=s("label",{class:"form-label"},"Client",-1)),m(s("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>e(o).customer_id=n),class:_(["form-select",{"is-invalid":e(d).customer_id}])},[t[8]||(t[8]=s("option",{value:""},"Sélectionner un client (optionnel)",-1)),(l(!0),a(w,null,C(y.customers,n=>(l(),a("option",{key:n.id,value:n.id},c(n.name),9,lt))),128))],2),[[V,e(o).customer_id]]),e(d).customer_id?(l(),a("div",at,c(e(d).customer_id),1)):p("",!0)]),s("div",dt,[t[11]||(t[11]=s("label",{class:"form-label"},"Statut",-1)),m(s("select",{"onUpdate:modelValue":t[1]||(t[1]=n=>e(o).status=n),class:_(["form-select",{"is-invalid":e(d).status}])},[...t[10]||(t[10]=[s("option",{value:"draft"},"Brouillon",-1),s("option",{value:"sent"},"Envoyé",-1),s("option",{value:"accepted"},"Accepté",-1),s("option",{value:"rejected"},"Refusé",-1),s("option",{value:"expired"},"Expiré",-1)])],2),[[V,e(o).status]]),e(d).status?(l(),a("div",rt,c(e(d).status),1)):p("",!0)]),s("div",ut,[t[12]||(t[12]=s("label",{class:"form-label"},"Date de validité (optionnel)",-1)),m(s("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>e(o).valid_until=n),type:"date",class:_(["form-control",{"is-invalid":e(d).valid_until}]),min:new Date().toISOString().split("T")[0]},null,10,ct),[[b,e(o).valid_until]]),e(d).valid_until?(l(),a("div",mt,c(e(d).valid_until),1)):p("",!0),t[13]||(t[13]=s("small",{class:"form-text text-muted"},"Date limite de validité du devis",-1))])]),s("div",pt,[t[14]||(t[14]=s("label",{class:"form-label"},"Notes (optionnel)",-1)),m(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=n=>e(o).notes=n),rows:"3",class:_(["form-control",{"is-invalid":e(d).notes}]),placeholder:"Ajoutez des notes sur ce devis..."},null,2),[[b,e(o).notes]]),e(d).notes?(l(),a("div",vt,c(e(d).notes),1)):p("",!0)])])]),s("div",_t,[s("div",bt,[t[18]||(t[18]=s("h5",{class:"card-title mb-0"},"Articles",-1)),s("div",ft,[M.value?(l(),a("button",{key:0,type:"button",onClick:$,class:"btn btn-warning btn-sm"},[...t[16]||(t[16]=[s("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):p("",!0),s("button",{type:"button",onClick:N,class:"btn btn-primary btn-sm"},[...t[17]||(t[17]=[s("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),s("div",yt,[e(o).items.length===0?(l(),a("div",gt,[...t[19]||(t[19]=[s("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),s("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),a("div",xt,[(l(!0),a(w,null,C(e(o).items,(n,u)=>(l(),a("div",{key:u,class:"border rounded p-3 mb-3"},[s("div",ht,[s("div",kt,[t[21]||(t[21]=s("label",{class:"form-label"},[v(" Produit "),s("span",{class:"text-danger"},"*")],-1)),m(s("select",{"onUpdate:modelValue":r=>n.product_id=r,required:"",class:_(["form-select",{"is-invalid":I(u)}]),onChange:r=>T(u)},[t[20]||(t[20]=s("option",{value:""},"Sélectionner un produit",-1)),(l(!0),a(w,null,C(y.products,r=>(l(),a("option",{key:r.id,value:r.id,disabled:x(r.id,u)},[v(c(r.name)+" ",1),x(r.id,u)?(l(),a("span",Vt," - Déjà sélectionné")):p("",!0)],8,Ct))),128))],42,wt),[[V,n.product_id]]),I(u)?(l(),a("div",qt," Ce produit est déjà sélectionné dans ce devis. ")):p("",!0)]),s("div",Ft,[t[22]||(t[22]=s("label",{class:"form-label"},[v(" Quantité "),s("span",{class:"text-danger"},"*")],-1)),m(s("input",{"onUpdate:modelValue":r=>n.quantity=r,type:"number",min:"1",required:"",class:"form-control",onInput:r=>g(u)},null,40,It),[[b,n.quantity,void 0,{number:!0}]])]),s("div",Ut,[t[24]||(t[24]=s("label",{class:"form-label"},"Prix unitaire",-1)),s("div",jt,[m(s("input",{"onUpdate:modelValue":r=>n.unit_price=r,type:"number",step:"0.01",min:"0",class:"form-control",style:D({width:U(n.unit_price)}),onInput:r=>g(u)},null,44,At),[[b,n.unit_price,void 0,{number:!0}]]),t[23]||(t[23]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",St,[t[26]||(t[26]=s("label",{class:"form-label"},"Total",-1)),s("div",Wt,[m(s("input",{"onUpdate:modelValue":r=>n.total_price=r,type:"number",step:"0.01",readonly:"",class:"form-control",style:D({width:U(n.total_price)})},null,12,Dt),[[b,n.total_price,void 0,{number:!0}]]),t[25]||(t[25]=s("span",{class:"input-group-text"},"Fcfa",-1))])]),s("div",Pt,[s("button",{type:"button",onClick:r=>z(u),class:"btn btn-outline-danger w-100"},[...t[27]||(t[27]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Et)])])]))),128))]))])])]),s("div",Nt,[s("div",zt,[t[36]||(t[36]=s("div",{class:"card-header"},[s("h5",{class:"card-title mb-0"},"Résumé du devis")],-1)),s("div",Tt,[s("div",Mt,[t[28]||(t[28]=s("span",null,"Sous-total:",-1)),s("span",$t,c(j(A.value)),1)]),s("div",Bt,[t[30]||(t[30]=s("label",{class:"form-label"},"Taxes (Fcfa)",-1)),s("div",Rt,[m(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=n=>e(o).tax_amount=n),step:"0.01",min:"0",class:_(["form-control",{"is-invalid":e(d).tax_amount}]),placeholder:"0.00"},null,2),[[b,e(o).tax_amount,void 0,{number:!0}]]),t[29]||(t[29]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(d).tax_amount?(l(),a("div",Lt,c(e(d).tax_amount),1)):p("",!0)]),s("div",Ot,[t[32]||(t[32]=s("label",{class:"form-label"},"Remise (Fcfa)",-1)),s("div",Qt,[m(s("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=n=>e(o).discount_amount=n),step:"0.01",min:"0",class:_(["form-control",{"is-invalid":e(d).discount_amount}]),placeholder:"0.00"},null,2),[[b,e(o).discount_amount,void 0,{number:!0}]]),t[31]||(t[31]=s("span",{class:"input-group-text"},"Fcfa",-1))]),e(d).discount_amount?(l(),a("div",Gt,c(e(d).discount_amount),1)):p("",!0)]),t[35]||(t[35]=s("hr",null,null,-1)),s("div",Ht,[t[33]||(t[33]=s("span",{class:"fw-bold"},"Total:",-1)),s("span",Jt,c(j(L.value)),1)]),s("div",Kt,[s("button",{type:"button",onClick:O,class:"btn btn-primary",disabled:e(h)||e(o).items.length===0},[e(h)?(l(),a("span",Yt)):(l(),a("i",Zt)),v(" "+c(e(h)?"Enregistrement...":"Enregistrer le devis"),1)],8,Xt),S(e(W),{href:e(q)("quotes.index"),class:"btn btn-outline-secondary"},{default:k(()=>[...t[34]||(t[34]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),cs=Y(ts,[["__scopeId","data-v-73a73d1e"]]);export{cs as default};
