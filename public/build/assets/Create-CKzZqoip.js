import{d as Z,r as tt,i as et,y as h,c as st,w as F,a as e,j as w,u as a,l as W,f as v,b as d,e as c,o as l,t as r,m as _,n as f,p as ot,v as b,F as nt,g as at,s as M}from"./app-CGqa7dvF.js";import{_ as it}from"./AppLayout.vue_vue_type_script_setup_true_lang-CUowRV7B.js";import{r as A}from"./routes-Ds1K_LXc.js";import{u as lt}from"./useSweetAlert-CjcY7Pj8.js";import{C as dt,P as ut}from"./CustomerAutocomplete-CXKgetRX.js";import{_ as rt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BootstrapLayout-L_TowVZG.js";import"./sweetalert2.esm.all-NNS-RXd7.js";const mt={class:"d-flex justify-content-between align-items-center mb-4"},ct={class:"row"},pt={class:"col-lg-8"},_t={class:"card mb-4"},vt={class:"card-body"},ft={class:"row g-3"},bt={class:"col-md-6"},yt={key:0,class:"invalid-feedback d-block"},ht={class:"col-md-6"},kt={key:0,class:"invalid-feedback"},gt={key:1,class:"invalid-feedback"},xt={class:"col-md-6"},wt=["min"],qt={key:0,class:"invalid-feedback"},Vt={class:"mt-3"},Ct={key:0,class:"invalid-feedback"},St={class:"card mb-4"},Ft={class:"card-header d-flex justify-content-between align-items-center"},At={class:"d-flex gap-2"},It={class:"card-body"},Ut={key:0,class:"text-center py-4 text-muted"},Lt={key:1},jt={class:"row g-3"},Et={class:"col-md-4"},Pt={key:0,class:"invalid-feedback d-block"},Wt={class:"col-md-2"},Mt=["onUpdate:modelValue","max","onInput"],$t={key:0,class:"invalid-feedback"},Dt={key:1,class:"form-text text-muted"},zt={class:"col-md-2"},Rt={class:"input-group"},Tt=["onUpdate:modelValue","onInput"],Nt={class:"col-md-2"},Bt={class:"input-group"},Ot=["onUpdate:modelValue"],Qt={class:"col-md-2 d-flex align-items-end"},Gt=["onClick"],Ht={class:"col-lg-4"},Jt={class:"card"},Kt={class:"card-body"},Xt={class:"d-flex justify-content-between mb-2"},Yt={class:"fw-medium"},Zt={class:"mb-3"},te={class:"input-group"},ee={key:0,class:"invalid-feedback"},se={key:1,class:"invalid-feedback"},oe={class:"mb-3"},ne={class:"input-group"},ae={key:0,class:"invalid-feedback"},ie={key:1,class:"invalid-feedback"},le={class:"mb-3"},de={class:"input-group"},ue=["max"],re={key:0,class:"invalid-feedback"},me={key:1,class:"invalid-feedback"},ce={class:"form-text text-muted"},pe={class:"d-flex justify-content-between mb-2"},_e={class:"fw-bold text-success fs-5"},ve={key:0,class:"d-flex justify-content-between mb-2"},fe={class:"fw-medium text-primary"},be={key:1,class:"d-flex justify-content-between mb-3"},ye={class:"fw-bold text-warning fs-5"},he={class:"d-grid gap-2"},ke=["disabled"],ge={key:0,class:"spinner-border spinner-border-sm me-2"},xe={key:1,class:"bi bi-check-circle me-1"},we=Z({__name:"Create",props:{customers:{},products:{}},setup(q){const I=q,{success:$,error:V}=lt(),m=tt({}),n=et({customer_id:"",payment_method:"",notes:"",due_date:"",tax_amount:0,discount_amount:0,down_payment_amount:0,items:[]}),D=()=>{n.items.push({product_id:0,quantity:1,unit_price:0,total_price:0})},z=o=>{n.items.splice(o,1)},R=(o,t)=>{const s=n.items[t];s.product_id=o.id,s.unit_price=o.price,C(t)},T=o=>n.items.map((t,s)=>s!==o?t.product_id:null).filter(t=>t!==null&&t>0),C=o=>{const t=n.items[o];t.total_price=t.quantity*t.unit_price},N=(o,t)=>o?n.items.some((s,i)=>i!==t&&s.product_id===o):!1,U=o=>{const t=n.items[o];return t.product_id?N(t.product_id,o):!1},B=h(()=>{const o=n.items.map(t=>t.product_id).filter(t=>t>0);return o.length!==new Set(o).size}),O=()=>{const o=new Map;n.items.forEach(t=>{if(t.product_id>0)if(o.has(t.product_id)){const s=o.get(t.product_id);s.quantity+=t.quantity,s.total_price=s.quantity*s.unit_price}else o.set(t.product_id,{...t})}),n.items=Array.from(o.values())},g=o=>{const t=n.items[o];if(!t.product_id||!t.quantity)return!1;const s=x(o);return t.quantity>s},x=o=>{const t=n.items[o];if(!t.product_id)return 0;const s=I.products.find(i=>i.id===t.product_id);return s?s.stock_quantity:0},L=o=>{const t=n.items[o];if(!t.product_id)return"";const s=I.products.find(i=>i.id===t.product_id);return s?s.unit:""},Q=o=>x(o),j=o=>{if(!o||o===0||typeof o!="number"||isNaN(o))return"80px";const Y=70+o.toFixed(2).length*9;return`${Math.max(70,Math.min(130,Y))}px`},k=o=>new Intl.NumberFormat("fr-FR").format(o)+" Fcfa",E=h(()=>n.items.reduce((o,t)=>o+t.total_price,0)),G=h(()=>n.tax_amount||0),H=h(()=>n.discount_amount||0),y=h(()=>E.value+G.value-H.value),J=h(()=>y.value-(n.down_payment_amount||0)),K=()=>{const o={};return n.payment_method||(o.payment_method="Le mode de paiement est requis"),n.tax_amount<0&&(o.tax_amount="Le montant de la taxe ne peut pas être négatif"),n.discount_amount<0&&(o.discount_amount="Le montant de la remise ne peut pas être négatif"),n.down_payment_amount<0&&(o.down_payment_amount="L'acompte ne peut pas être négatif"),n.down_payment_amount>y.value&&(o.down_payment_amount="L'acompte ne peut pas dépasser le montant total"),n.items.forEach((t,s)=>{t.product_id||(o[`items.${s}.product_id`]="Le produit est requis"),(!t.quantity||t.quantity<1)&&(o[`items.${s}.quantity`]="La quantité doit être au moins 1"),(!t.unit_price||t.unit_price<0)&&(o[`items.${s}.unit_price`]="Le prix unitaire doit être positif"),g(s)&&(o[`items.${s}.quantity`]="La quantité dépasse le stock disponible")}),Object.keys(o).length===0?null:o},P=(o,t)=>{m.value[o]&&delete m.value[o];let s="";switch(o){case"payment_method":t||(s="Le mode de paiement est requis");break;case"tax_amount":t<0&&(s="Le montant de la taxe ne peut pas être négatif");break;case"discount_amount":t<0&&(s="Le montant de la remise ne peut pas être négatif");break;case"down_payment_amount":t<0?s="L'acompte ne peut pas être négatif":t>y.value&&(s="L'acompte ne peut pas dépasser le montant total");break}s&&(m.value[o]=s)},X=()=>{m.value={};const o=K();if(o){m.value=o;return}if(n.items.length===0){V("Veuillez ajouter au moins un article.");return}if(n.items.some((i,p)=>g(p))){V("Veuillez corriger les quantités qui dépassent le stock disponible.");return}const s={customer_id:n.customer_id||null,payment_method:n.payment_method,notes:n.notes||null,tax_amount:n.tax_amount||0,discount_amount:n.discount_amount||0,down_payment_amount:n.down_payment_amount||0,items:n.items.map(i=>({product_id:i.product_id,quantity:i.quantity,unit_price:i.unit_price}))};n.transform(()=>s).post(A("sales.store"),{onSuccess:()=>{$("Vente enregistrée avec succès !"),n.reset(),m.value={}},onError:i=>{console.error("Erreurs de validation:",i),V("Erreur lors de l'enregistrement de la vente.")}})},{errors:u,processing:S}=n;return(o,t)=>(l(),st(it,null,{default:F(()=>[e("div",mt,[t[10]||(t[10]=e("div",null,[e("h1",{class:"h2 mb-1"},"Nouvelle vente"),e("p",{class:"text-muted mb-0"},"Enregistrez une nouvelle vente")],-1)),w(a(W),{href:a(A)("sales.index"),class:"btn btn-outline-secondary"},{default:F(()=>[...t[9]||(t[9]=[e("i",{class:"bi bi-arrow-left me-1"},null,-1),v(" Retour à la liste ",-1)])]),_:1},8,["href"])]),e("form",null,[e("div",ct,[e("div",pt,[e("div",_t,[t[17]||(t[17]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Informations générales")],-1)),e("div",vt,[e("div",ft,[e("div",bt,[t[11]||(t[11]=e("label",{class:"form-label"},"Client",-1)),w(dt,{customers:q.customers,modelValue:a(n).customer_id,"onUpdate:modelValue":t[0]||(t[0]=s=>a(n).customer_id=s),placeholder:"Rechercher un client (optionnel)...","is-invalid":!!a(u).customer_id},null,8,["customers","modelValue","is-invalid"]),a(u).customer_id?(l(),d("div",yt,r(a(u).customer_id),1)):c("",!0)]),e("div",ht,[t[13]||(t[13]=e("label",{class:"form-label"},[v(" Mode de paiement "),e("span",{class:"text-danger"},"*")],-1)),_(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>a(n).payment_method=s),required:"",class:f(["form-select",{"is-invalid":a(u).payment_method||m.value.payment_method}]),onBlur:t[2]||(t[2]=s=>P("payment_method",a(n).payment_method)),onChange:t[3]||(t[3]=s=>P("payment_method",a(n).payment_method))},[...t[12]||(t[12]=[e("option",{value:""},"Sélectionner un mode de paiement",-1),e("option",{value:"cash"},"Espèces",-1),e("option",{value:"card"},"Carte",-1),e("option",{value:"bank_transfer"},"Virement bancaire",-1),e("option",{value:"check"},"Chèque",-1),e("option",{value:"orange_money"},"Orange Money",-1),e("option",{value:"wave"},"Wave",-1)])],34),[[ot,a(n).payment_method]]),a(u).payment_method?(l(),d("div",kt,r(a(u).payment_method),1)):c("",!0),m.value.payment_method?(l(),d("div",gt,r(m.value.payment_method),1)):c("",!0)]),e("div",xt,[t[14]||(t[14]=e("label",{class:"form-label"},"Date d'échéance (optionnel)",-1)),_(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>a(n).due_date=s),type:"date",class:f(["form-control",{"is-invalid":a(u).due_date}]),min:new Date().toISOString().split("T")[0]},null,10,wt),[[b,a(n).due_date]]),a(u).due_date?(l(),d("div",qt,r(a(u).due_date),1)):c("",!0),t[15]||(t[15]=e("small",{class:"form-text text-muted"},"Date limite de paiement",-1))])]),e("div",Vt,[t[16]||(t[16]=e("label",{class:"form-label"},"Notes (optionnel)",-1)),_(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>a(n).notes=s),rows:"3",class:f(["form-control",{"is-invalid":a(u).notes}]),placeholder:"Ajoutez des notes sur cette vente..."},null,2),[[b,a(n).notes]]),a(u).notes?(l(),d("div",Ct,r(a(u).notes),1)):c("",!0)])])]),e("div",St,[e("div",Ft,[t[20]||(t[20]=e("h5",{class:"card-title mb-0"},"Articles",-1)),e("div",At,[B.value?(l(),d("button",{key:0,type:"button",onClick:O,class:"btn btn-warning btn-sm"},[...t[18]||(t[18]=[e("i",{class:"bi bi-arrow-down-up me-1"},null,-1),v(" Fusionner les doublons ",-1)])])):c("",!0),e("button",{type:"button",onClick:D,class:"btn btn-primary btn-sm"},[...t[19]||(t[19]=[e("i",{class:"bi bi-plus-circle me-1"},null,-1),v(" Ajouter un article ",-1)])])])]),e("div",It,[a(n).items.length===0?(l(),d("div",Ut,[...t[21]||(t[21]=[e("i",{class:"bi bi-cart-x fs-1 mb-3"},null,-1),e("p",null,'Aucun article ajouté. Cliquez sur "Ajouter un article" pour commencer.',-1)])])):(l(),d("div",Lt,[(l(!0),d(nt,null,at(a(n).items,(s,i)=>(l(),d("div",{key:i,class:"border rounded p-3 mb-3"},[e("div",jt,[e("div",Et,[t[22]||(t[22]=e("label",{class:"form-label"},[v(" Produit "),e("span",{class:"text-danger"},"*")],-1)),w(ut,{modelValue:s.product_id,"onUpdate:modelValue":p=>s.product_id=p,products:q.products,"exclude-product-ids":T(i),"is-invalid":U(i),placeholder:"Rechercher un produit...",onSelected:p=>R(p,i)},null,8,["modelValue","onUpdate:modelValue","products","exclude-product-ids","is-invalid","onSelected"]),U(i)?(l(),d("div",Pt," Ce produit est déjà sélectionné dans cette vente. ")):c("",!0)]),e("div",Wt,[t[23]||(t[23]=e("label",{class:"form-label"},[v(" Quantité "),e("span",{class:"text-danger"},"*")],-1)),_(e("input",{"onUpdate:modelValue":p=>s.quantity=p,type:"number",min:"1",max:Q(i),required:"",class:f(["form-control",{"is-invalid":g(i)}]),onInput:p=>C(i)},null,42,Mt),[[b,s.quantity,void 0,{number:!0}]]),g(i)?(l(),d("div",$t," Stock insuffisant. Disponible: "+r(x(i))+" "+r(L(i)),1)):s.product_id?(l(),d("div",Dt," Stock disponible: "+r(x(i))+" "+r(L(i)),1)):c("",!0)]),e("div",zt,[t[25]||(t[25]=e("label",{class:"form-label"},"Prix unitaire",-1)),e("div",Rt,[_(e("input",{"onUpdate:modelValue":p=>s.unit_price=p,type:"number",step:"0.01",min:"0",class:f(["form-control",{"is-invalid":!1}]),style:M({width:j(s.unit_price)}),onInput:p=>C(i)},null,44,Tt),[[b,s.unit_price,void 0,{number:!0}]]),t[24]||(t[24]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Nt,[t[27]||(t[27]=e("label",{class:"form-label"},"Total",-1)),e("div",Bt,[_(e("input",{"onUpdate:modelValue":p=>s.total_price=p,type:"number",step:"0.01",readonly:"",class:"form-control",style:M({width:j(s.total_price)})},null,12,Ot),[[b,s.total_price,void 0,{number:!0}]]),t[26]||(t[26]=e("span",{class:"input-group-text"},"Fcfa",-1))])]),e("div",Qt,[e("button",{type:"button",onClick:p=>z(i),class:"btn btn-outline-danger w-100"},[...t[28]||(t[28]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Gt)])])]))),128))]))])])]),e("div",Ht,[e("div",Jt,[t[41]||(t[41]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},"Résumé de la vente")],-1)),e("div",Kt,[e("div",Xt,[t[29]||(t[29]=e("span",null,"Sous-total:",-1)),e("span",Yt,r(k(E.value)),1)]),e("div",Zt,[t[31]||(t[31]=e("label",{class:"form-label"},"Taxes (Fcfa)",-1)),e("div",te,[_(e("input",{type:"number","onUpdate:modelValue":t[6]||(t[6]=s=>a(n).tax_amount=s),step:"0.01",min:"0",class:f(["form-control",{"is-invalid":a(u).tax_amount||m.value.tax_amount}]),placeholder:"0.00"},null,2),[[b,a(n).tax_amount,void 0,{number:!0}]]),t[30]||(t[30]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).tax_amount?(l(),d("div",ee,r(a(u).tax_amount),1)):c("",!0),m.value.tax_amount?(l(),d("div",se,r(m.value.tax_amount),1)):c("",!0)]),e("div",oe,[t[33]||(t[33]=e("label",{class:"form-label"},"Remise (Fcfa)",-1)),e("div",ne,[_(e("input",{type:"number","onUpdate:modelValue":t[7]||(t[7]=s=>a(n).discount_amount=s),step:"0.01",min:"0",class:f(["form-control",{"is-invalid":a(u).discount_amount||m.value.discount_amount}]),placeholder:"0.00"},null,2),[[b,a(n).discount_amount,void 0,{number:!0}]]),t[32]||(t[32]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).discount_amount?(l(),d("div",ae,r(a(u).discount_amount),1)):c("",!0),m.value.discount_amount?(l(),d("div",ie,r(m.value.discount_amount),1)):c("",!0)]),e("div",le,[t[35]||(t[35]=e("label",{class:"form-label"},"Acompte (Fcfa)",-1)),e("div",de,[_(e("input",{type:"number","onUpdate:modelValue":t[8]||(t[8]=s=>a(n).down_payment_amount=s),step:"0.01",min:"0",max:y.value,class:f(["form-control",{"is-invalid":a(u).down_payment_amount||m.value.down_payment_amount}]),placeholder:"0.00"},null,10,ue),[[b,a(n).down_payment_amount,void 0,{number:!0}]]),t[34]||(t[34]=e("span",{class:"input-group-text"},"Fcfa",-1))]),a(u).down_payment_amount?(l(),d("div",re,r(a(u).down_payment_amount),1)):c("",!0),m.value.down_payment_amount?(l(),d("div",me,r(m.value.down_payment_amount),1)):c("",!0),e("div",ce," Montant maximum: "+r(k(y.value)),1)]),t[40]||(t[40]=e("hr",null,null,-1)),e("div",pe,[t[36]||(t[36]=e("span",{class:"fw-bold"},"Total:",-1)),e("span",_e,r(k(y.value)),1)]),a(n).down_payment_amount>0?(l(),d("div",ve,[t[37]||(t[37]=e("span",null,"Acompte:",-1)),e("span",fe,r(k(a(n).down_payment_amount)),1)])):c("",!0),a(n).down_payment_amount>0?(l(),d("div",be,[t[38]||(t[38]=e("span",{class:"fw-bold"},"Reste à payer:",-1)),e("span",ye,r(k(J.value)),1)])):c("",!0),e("div",he,[e("button",{type:"button",onClick:X,class:"btn btn-success",disabled:a(S)||a(n).items.length===0},[a(S)?(l(),d("span",ge)):(l(),d("i",xe)),v(" "+r(a(S)?"Enregistrement...":"Enregistrer la vente"),1)],8,ke),w(a(W),{href:a(A)("sales.index"),class:"btn btn-outline-secondary"},{default:F(()=>[...t[39]||(t[39]=[v(" Annuler ",-1)])]),_:1},8,["href"])])])])])])])]),_:1}))}}),Pe=rt(we,[["__scopeId","data-v-75c6dc0c"]]);export{Pe as default};
